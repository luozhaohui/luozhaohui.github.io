
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Android多线程分析之二：Thread的实现 - 飘飘白云</title>
  <meta name="author" content="飘飘白云">

  
  <meta name="description" content="Android多线程分析之二：Thread的实现">
  <meta name="keywords" content="android, thread">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://luozhaohui.github.io/blog/2014/07/10/android-thread-tutoria02/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="飘飘白云" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">飘飘白云</a></h1>
  
    <h2>所读，所看，所思</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.bing.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="luozhaohui.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Android多线程分析之二：Thread的实现</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-10T21:21:40+08:00'><span class='date'>2014-07-10</span> <span class='time'>9:21 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h2>引言</h2>

<p>在前文<a href="https://luozhaohui.github.io/blog/2014/07/08/android-thread-tutoria01/">Android多线程分析之一：使用Thread异步下载图像</a>中演示了如何使用<code>Thread</code>处理异步事务。示例中这个<code>Java Thread</code>类都是位于<code>Framework</code>层的类，它自身是通过<code>JNI</code>转调<code>dalvik</code>里面的<code>Thread</code>相关方法实现的。因此要分析<code>Andriod</code> 中的线程，就需要分析这两层中的与线程相关的代码，这就是本文要探讨的主题。本文将把<code>Framework</code>层中的<code>Java Thread</code>称为<code>Android Thread</code>，而把<code>dalvik</code>中的 <code>Thread</code>成为<code>dalvik Thread</code>。</p>

<!--more-->


<h2>源码路径</h2>

<p>本文涉及到的 <code>Android</code> 源码路径：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>android/libcore/luni/src/main/java/java/lang/Runnable.java
</span><span class='line'>android/libcore/luni/src/main/java/java/lang/Thread.java
</span><span class='line'>android/libcore/luni/src/main/java/java/lang/ThreadGroup.java
</span><span class='line'>android/libcore/luni/src/main/java/java/lang/VMThread.java
</span><span class='line'>android/dalvik/vm/native/java_lang_VMThread.cpp
</span><span class='line'>android/dalvik/vm/Thread.cpp</span></code></pre></td></tr></table></div></figure>


<h2>Android Thread</h2>

<p>首先来分析<code>Android Thread</code>，这个类的源码在<code>android/libcore/luni/src/main/java/java/lang/Thread.java</code>，它实现了<code>Runnable</code>接口。<code>Runnable</code>只有一个无参无返回值的<code>void run()</code>的接口：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Represents a command that can be executed. Often used to run code in a</span>
</span><span class='line'><span class="cm"> * different {@link Thread}.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Runnable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Starts executing the active part of the class&#39; code. This method is</span>
</span><span class='line'><span class="cm">     * called when a thread is started that has been created with a class which</span>
</span><span class='line'><span class="cm">     * implements {@code Runnable}.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Android Thread</code>存在六种状态，这些状态定义在枚举<code>State</code>中，源码注释写的很清晰，在这里就不罗嗦了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * A representation of a thread&#39;s state. A given thread may only be in one</span>
</span><span class='line'><span class="cm"> * state at a time.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The thread has been created, but has never been started.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">NEW</span><span class="o">,</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The thread may be run.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">RUNNABLE</span><span class="o">,</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The thread is blocked and waiting for a lock.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">BLOCKED</span><span class="o">,</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The thread is waiting.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">WAITING</span><span class="o">,</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The thread is waiting for a specified amount of time.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">TIMED_WAITING</span><span class="o">,</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The thread has been terminated.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">TERMINATED</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Android Thread</code>类中一些关键成员变量如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">volatile</span> <span class="n">VMThread</span> <span class="n">vmThread</span><span class="o">;</span>
</span><span class='line'><span class="kd">volatile</span> <span class="n">ThreadGroup</span> <span class="n">group</span><span class="o">;</span>
</span><span class='line'><span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">daemon</span><span class="o">;</span>
</span><span class='line'><span class="kd">volatile</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'><span class="kd">volatile</span> <span class="kt">int</span> <span class="n">priority</span><span class="o">;</span>
</span><span class='line'><span class="kd">volatile</span> <span class="kt">long</span> <span class="n">stackSize</span><span class="o">;</span>
</span><span class='line'><span class="n">Runnable</span> <span class="n">target</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'><span class="n">ThreadLocal</span><span class="o">.</span><span class="na">Values</span> <span class="n">localValues</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><code>vmThread</code>：可视为对<code>dalvik thread</code>的简单封装，<code>Thread</code>类通过<code>VMThread</code>里面的<code>JNI</code>方法来调用<code>dalvik</code>中操作线程的方法，通过它的成员变量<code>thread</code>和<code>vmata</code>，我们可以将<code>Android Thread</code>和<code>dalvik Thread</code>的关联起来；<br/>
<code>group</code>：每一个线程都属于一个<code>group</code>，当线程被创建时就会加入一个特定的<code>group</code>，当线程运行结束，会从这个<code>group</code>中移除；<br/>
<code>daemon</code>：当前线程是不是守护线程，守护线程只会在没有非守护线程运行的情况下才会运行；<br/>
<code>priority</code>：线程优先级，<code>Java Thread</code>类的线程优先级取值范围为 [1, 10]，默认优先级为 5；<br/>
<code>stackSize</code>：线程栈大小，默认为 0，即使用默认的线程栈大小（由<code>dalvik&lt;</code>中的全局变量<code>gDvm.stackSize</code>决定）；<br/>
<code>target</code>：一个<code>Runnable</code>对象，<code>Thread</code>的<code>run()</code>方法中会转调该<code>target</code>的<code>run()</code>方法，这是线程真正处理事务的地方；<br/>
<code>id</code>：线程<code>id</code>，通过递增<code>count</code>得到该<code>id</code>，如果没有显式给线程设置名字，那么就会使用<code>Thread+id</code>当作线程的名字。注意这不是真正意义上的线程<code>id</code>，即在<code>logcat</code>中打印的<code>tid</code>并不是这个<code>id</code>，那<code>tid</code>是指<code>dalvik</code>线程的<code>id</code>；
<code>localValues</code>：线程本地存储（<code>TLS</code>）数据；</p></blockquote>

<p>接下来，我们来看<code>Android Thread</code>的构造函数，大部分构造函数都是通过转调静态函数<code>create</code>实现的，下面来详细分析<code>create</code>这个关键函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="n">ThreadGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">runnable</span><span class="o">,</span> <span class="n">String</span> <span class="n">threadName</span><span class="o">,</span> <span class="kt">long</span> <span class="n">stackSize</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Thread</span> <span class="n">currentThread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">group</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">group</span> <span class="o">=</span> <span class="n">currentThread</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">isDestroyed</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalThreadStateException</span><span class="o">(</span><span class="s">&quot;Group already destroyed&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">id</span> <span class="o">=</span> <span class="o">++</span><span class="n">Thread</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">threadName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="s">&quot;Thread-&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">threadName</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">runnable</span><span class="o">;</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">stackSize</span> <span class="o">=</span> <span class="n">stackSize</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">priority</span> <span class="o">=</span> <span class="n">currentThread</span><span class="o">.</span><span class="na">getPriority</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">contextClassLoader</span> <span class="o">=</span> <span class="n">currentThread</span><span class="o">.</span><span class="na">contextClassLoader</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Transfer over InheritableThreadLocals.</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">currentThread</span><span class="o">.</span><span class="na">inheritableValues</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">inheritableValues</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">.</span><span class="na">Values</span><span class="o">(</span><span class="n">currentThread</span><span class="o">.</span><span class="na">inheritableValues</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// add ourselves to our ThreadGroup of choice</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">addThread</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先，通过静态函数<code>currentThread</code>获取创建线程所在的当前线程，然后将当前线程的一些属性传递给即将创建的新线程。这是通过<code>VMThread</code>转调<code>dalvik</code>中的代码实现的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Thread</span> <span class="nf">currentThread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">VMThread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>dalvik Thread</h2>

<p><code>VMThread</code>的<code>currentThread</code>是一个<code>native</code>方法，其<code>JNI</code>实现为<code>android/dalvik/vm/native/java_lang_VMThread.cpp</code>中的<code>Dalvik_java_lang_VMThread_currentThread</code>方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">Dalvik_java_lang_VMThread_currentThread</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span>
</span><span class='line'>    <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">UNUSED_PARAMETER</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">RETURN_PTR</span><span class="p">(</span><span class="n">dvmThreadSelf</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">threadObj</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>该方法里的<code>dvmThreadSelf()</code>方法定义在<code>android/dalvik/vm/Thread.cpp</code>中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">Thread</span><span class="o">*</span> <span class="nf">dvmThreadSelf</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">Thread</span><span class="o">*</span><span class="p">)</span> <span class="n">pthread_getspecific</span><span class="p">(</span><span class="n">gDvm</span><span class="p">.</span><span class="n">pthreadKeySelf</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从上面的调用栈可以看到，每一个<code>dalvik</code>线程都会将自身存放在<code>key</code>为<code>pthreadKeySelf</code> 的线程本地存储中，获取当前线程时，只需要根据这个<code>key</code>查询获取即可，<code>dalvik Thread</code>有一个名为<code>threadObj</code> 的成员变量：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/* the java/lang/Thread that we are associated with */</span>
</span><span class='line'><span class="n">Object</span><span class="o">*</span>     <span class="n">threadObj</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>dalvik Thread</code>这个成员变量<code>threadObj</code>关联的就是对应的<code>Android Thread</code>对象，所以通过<code>native</code>方法<code>VMThread.currentThread()</code>返回的是存储在<code>TLS</code>中的当前<code>dalvik</code>线程对应的<code>Android Thread</code>。</p>

<p>接着分析上面的代码，如果没有给新线程指定<code>group</code>那么就会指定<code>group</code>为当前线程所在的<code>group</code>中，然后给新线程设置<code>name</code>，<code>priority</code>等。最后通过调用<code>ThreadGroup</code>的<code>addThread</code>方法将新线程添加到<code>group</code>中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Called by the Thread constructor.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">final</span> <span class="kt">void</span> <span class="nf">addThread</span><span class="o">(</span><span class="n">Thread</span> <span class="n">thread</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalThreadStateException</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">threadRefs</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">isDestroyed</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalThreadStateException</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">threadRefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;(</span><span class="n">thread</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ThreadGroup</code>的代码相对简单，它有一个名为<code>threadRefs</code>的列表，持有属于同一组的<code>thread</code>引用，可以对一组<code>thread</code>进行一些线程操作。</p>

<p>上面分析的是<code>Android Thread</code>的构造过程，从上面的分析可以看出，<code>Android Thread</code>的构造方法仅仅是设置了一些线程属性，并没有真正去创建一个新的<code>dalvik Thread</code>，<code>dalvik Thread</code>创建过程要等到客户代码调用<code>Android Thread</code>的<code>start()</code>方法才会进行。下面我们来分析<code>Java Thread</code>的<code>start()</code>方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">hasBeenStarted</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalThreadStateException</span><span class="o">(</span><span class="s">&quot;Thread already started.&quot;</span><span class="o">);</span> <span class="c1">// TODO Externalize?</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">hasBeenStarted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">VMThread</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">stackSize</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Android Thread</code>的 <code>start</code> 方法很简单，仅仅是转调 <code>VMThread</code> 的 <code>native</code> 方法 <code>create</code>，其 <code>JNI</code> 实现为 <code>android/dalvik/vm/native/java_lang_VMThread.cpp</code> 中的 <code>Dalvik_java_lang_VMThread_create</code> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">Dalvik_java_lang_VMThread_create</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Object</span><span class="o">*</span> <span class="n">threadObj</span> <span class="o">=</span> <span class="p">(</span><span class="n">Object</span><span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="n">s8</span> <span class="n">stackSize</span> <span class="o">=</span> <span class="n">GET_ARG_LONG</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* copying collector will pin threadObj for us since it was an argument */</span>
</span><span class='line'>    <span class="n">dvmCreateInterpThread</span><span class="p">(</span><span class="n">threadObj</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">stackSize</span><span class="p">);</span>
</span><span class='line'>    <span class="n">RETURN_VOID</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create 线程</h2>

<p><code>dvmCreateInterpThread</code> 的实现在 <code>Thread.cpp</code> 中，由于这个函数的内容很长，在这里只列出关键的地方：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">bool</span> <span class="nf">dvmCreateInterpThread</span><span class="p">(</span><span class="n">Object</span><span class="o">*</span> <span class="n">threadObj</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqStackSize</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Thread</span><span class="o">*</span> <span class="n">self</span> <span class="o">=</span> <span class="n">dvmThreadSelf</span><span class="p">();</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">Thread</span><span class="o">*</span> <span class="n">newThread</span> <span class="o">=</span> <span class="n">allocThread</span><span class="p">(</span><span class="n">stackSize</span><span class="p">);</span>
</span><span class='line'>    <span class="n">newThread</span><span class="o">-&gt;</span><span class="n">threadObj</span> <span class="o">=</span> <span class="n">threadObj</span><span class="p">;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">Object</span><span class="o">*</span> <span class="n">vmThreadObj</span> <span class="o">=</span> <span class="n">dvmAllocObject</span><span class="p">(</span><span class="n">gDvm</span><span class="p">.</span><span class="n">classJavaLangVMThread</span><span class="p">,</span> <span class="n">ALLOC_DEFAULT</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dvmSetFieldInt</span><span class="p">(</span><span class="n">vmThreadObj</span><span class="p">,</span> <span class="n">gDvm</span><span class="p">.</span><span class="n">offJavaLangVMThread_vmData</span><span class="p">,</span> <span class="p">(</span><span class="n">u4</span><span class="p">)</span><span class="n">newThread</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dvmSetFieldObject</span><span class="p">(</span><span class="n">threadObj</span><span class="p">,</span> <span class="n">gDvm</span><span class="p">.</span><span class="n">offJavaLangThread_vmThread</span><span class="p">,</span> <span class="n">vmThreadObj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="kt">pthread_t</span> <span class="n">threadHandle</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadHandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">threadAttr</span><span class="p">,</span> <span class="n">interpThreadStart</span><span class="p">,</span> <span class="n">newThread</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Tell the new thread to start.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * We must hold the thread list lock before messing with another thread.</span>
</span><span class='line'><span class="cm">     * In the general case we would also need to verify that newThread was</span>
</span><span class='line'><span class="cm">     * still in the thread list, but in our case the thread has not started</span>
</span><span class='line'><span class="cm">     * executing user code and therefore has not had a chance to exit.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * We move it to VMWAIT, and it then shifts itself to RUNNING, which</span>
</span><span class='line'><span class="cm">     * comes with a suspend-pending check.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">dvmLockThreadList</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">newThread</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">THREAD_STARTING</span><span class="p">);</span>
</span><span class='line'>    <span class="n">newThread</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_VMWAIT</span><span class="p">;</span>
</span><span class='line'>    <span class="n">pthread_cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDvm</span><span class="p">.</span><span class="n">threadStartCond</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dvmUnlockThreadList</span><span class="p">();</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Alloc and initialize a Thread struct.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Does not create any objects, just stuff on the system (malloc) heap.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="n">Thread</span><span class="o">*</span> <span class="nf">allocThread</span><span class="p">(</span><span class="kt">int</span> <span class="n">interpStackSize</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">thread</span> <span class="o">=</span> <span class="p">(</span><span class="n">Thread</span><span class="o">*</span><span class="p">)</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Thread</span><span class="p">));</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_INITIALIZING</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先，通过调用 <code>allocThread</code> 创建一个名为 <code>newThread</code> 的<code>dalvik Thread</code> 并设置一些属性，将设置其成员变量 <code>threadObj</code> 为传入的 <code>Android Thread</code>，这样<code>dalvik Thread</code>就与<code>Android Thread</code>关联起来了；然后创建一个名为 <code>vmThreadObj</code> 的 <code>VMThread</code> 对象，设置其成员变量 <code>vmData</code> 为 <code>newThread</code>，设置<code>Android Thread threadObj</code>的成员变量 <code>vmThread</code> 为这个 <code>vmThreadObj</code>，这样<code>Android Thread</code>通过 <code>VMThread</code> 的成员变量 <code>vmData</code> 就和<code>dalvik Thread</code>关联起来了。</p>

<h2>Start 线程</h2>

<p>然后，通过 <code>pthread_create</code> 创建 <code>pthread</code> 线程，并让这个线程 <code>start</code>，这样就会进入该线程的 <code>thread entry</code> 运行，下来我们来看新线程的 <code>thread entry</code> 方法 <code>interpThreadStart</code>，同样只列出关键的地方：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * pthread entry function for threads started from interpreted code.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">interpThreadStart</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Thread</span><span class="o">*</span> <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">Thread</span><span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">threadName</span><span class="p">(</span><span class="n">dvmGetThreadName</span><span class="p">(</span><span class="n">self</span><span class="p">));</span>
</span><span class='line'>    <span class="n">setThreadName</span><span class="p">(</span><span class="n">threadName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Finish initializing the Thread struct.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">dvmLockThreadList</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">prepareThread</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">THREAD_VMWAIT</span><span class="p">)</span>
</span><span class='line'>        <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDvm</span><span class="p">.</span><span class="n">threadStartCond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gDvm</span><span class="p">.</span><span class="n">threadListLock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dvmUnlockThreadList</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Add a JNI context.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">jniEnv</span> <span class="o">=</span> <span class="n">dvmCreateJNIEnv</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Change our state so the GC will wait for us from now on.  If a GC is</span>
</span><span class='line'><span class="cm">     * in progress this call will suspend us.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">dvmChangeStatus</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">THREAD_RUNNING</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Execute the &quot;run&quot; method.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * At this point our stack is empty, so somebody who comes looking for</span>
</span><span class='line'><span class="cm">     * stack traces right now won&#39;t have much to look at.  This is normal.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">Method</span><span class="o">*</span> <span class="n">run</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">threadObj</span><span class="o">-&gt;</span><span class="n">clazz</span><span class="o">-&gt;</span><span class="n">vtable</span><span class="p">[</span><span class="n">gDvm</span><span class="p">.</span><span class="n">voffJavaLangThread_run</span><span class="p">];</span>
</span><span class='line'>    <span class="n">JValue</span> <span class="n">unused</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ALOGV</span><span class="p">(</span><span class="s">&quot;threadid=%d: calling run()&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">threadId</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;run&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dvmCallMethod</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">threadObj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unused</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ALOGV</span><span class="p">(</span><span class="s">&quot;threadid=%d: exiting&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">threadId</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Remove the thread from various lists, report its death, and free</span>
</span><span class='line'><span class="cm">     * its resources.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">dvmDetachCurrentThread</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Finish initialization of a Thread struct.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * This must be called while executing in the new thread, but before the</span>
</span><span class='line'><span class="cm"> * thread is added to the thread list.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * NOTE: The threadListLock must be held by the caller (needed for</span>
</span><span class='line'><span class="cm"> * assignThreadId()).</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">bool</span> <span class="nf">prepareThread</span><span class="p">(</span><span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assignThreadId</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
</span><span class='line'>    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">pthread_self</span><span class="p">();</span>
</span><span class='line'>    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">systemTid</span> <span class="o">=</span> <span class="n">dvmGetSysThreadId</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">setThreadSelf</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Explore our sense of self.  Stuffs the thread pointer into TLS.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">setThreadSelf</span><span class="p">(</span><span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cc</span> <span class="o">=</span> <span class="n">pthread_setspecific</span><span class="p">(</span><span class="n">gDvm</span><span class="p">.</span><span class="n">pthreadKeySelf</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在新线程的 <code>thread entry</code> 方法 <code>interpThreadStart</code> 中，首先设置线程的名字，然后通过调用 <code>prepareThread</code> 设置线程 <code>id</code> 以及其它一些属性，并调用 <code>setThreadSelf</code> 将新<code>dalvik Thread</code>自身保存在 <code>TLS</code> 中，这样之后就能通过 <code>dvmThreadSelf</code> 方法从 <code>TLS</code> 中获取它。然后修改状态为 <code>THREAD_RUNNING</code>，并调用对应<code>Android Thread</code>的 <code>run</code> 方法，运行客户代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">target</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>对于继承自<code>Android Thread</code>带有 <code>Looper</code> 的 <code>Android HandlerThread</code> 来说，会调用它覆写 <code>run()</code> 方法：（关于 <code>Looper</code> 的话题下一篇会讲到，这里暂且略过）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mTid</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="na">myTid</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Looper</span><span class="o">.</span><span class="na">prepare</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mLooper</span> <span class="o">=</span> <span class="n">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
</span><span class='line'>        <span class="n">notifyAll</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span><span class="n">mPriority</span><span class="o">);</span>
</span><span class='line'>    <span class="n">onLooperPrepared</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>
</span><span class='line'>    <span class="n">mTid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Detach 线程</h2>

<p><code>target</code> 在前面已经做了介绍，它是线程真正处理逻辑事务的地方。一旦逻辑事务处理完毕从 <code>run</code> 中返回，线程就会回到 <code>interpThreadStart</code> 方法中，继续执行 <code>dvmDetachCurrentThread</code> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Detach the thread from the various data structures, notify other threads</span>
</span><span class='line'><span class="cm"> * that are waiting to &quot;join&quot; it, and free up all heap-allocated storage.</span>
</span><span class='line'><span class="cm"> * /</span>
</span><span class='line'><span class="cm">void dvmDetachCurrentThread()</span>
</span><span class='line'><span class="cm">{</span>
</span><span class='line'><span class="cm">    Thread* self = dvmThreadSelf();</span>
</span><span class='line'><span class="cm">    Object* vmThread;</span>
</span><span class='line'><span class="cm">    Object* group;</span>
</span><span class='line'><span class="cm">    ...</span>
</span><span class='line'><span class="cm">    group = dvmGetFieldObject(self-&gt;threadObj, gDvm.offJavaLangThread_group);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    /*</span>
</span><span class='line'><span class="cm">     * Remove the thread from the thread group.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Method</span><span class="o">*</span> <span class="n">removeThread</span> <span class="o">=</span>
</span><span class='line'>            <span class="n">group</span><span class="o">-&gt;</span><span class="n">clazz</span><span class="o">-&gt;</span><span class="n">vtable</span><span class="p">[</span><span class="n">gDvm</span><span class="p">.</span><span class="n">voffJavaLangThreadGroup_removeThread</span><span class="p">];</span>
</span><span class='line'>        <span class="n">JValue</span> <span class="n">unused</span><span class="p">;</span>
</span><span class='line'>        <span class="n">dvmCallMethod</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">removeThread</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unused</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">threadObj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Clear the vmThread reference in the Thread object.  Interpreted code</span>
</span><span class='line'><span class="cm">     * will now see that this Thread is not running.  As this may be the</span>
</span><span class='line'><span class="cm">     * only reference to the VMThread object that the VM knows about, we</span>
</span><span class='line'><span class="cm">     * have to create an internal reference to it first.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">vmThread</span> <span class="o">=</span> <span class="n">dvmGetFieldObject</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">threadObj</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">gDvm</span><span class="p">.</span><span class="n">offJavaLangThread_vmThread</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dvmAddTrackedAlloc</span><span class="p">(</span><span class="n">vmThread</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dvmSetFieldObject</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">threadObj</span><span class="p">,</span> <span class="n">gDvm</span><span class="p">.</span><span class="n">offJavaLangThread_vmThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* clear out our struct Thread pointer, since it&#39;s going away */</span>
</span><span class='line'>    <span class="n">dvmSetFieldObject</span><span class="p">(</span><span class="n">vmThread</span><span class="p">,</span> <span class="n">gDvm</span><span class="p">.</span><span class="n">offJavaLangVMThread_vmData</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Thread.join() is implemented as an Object.wait() on the VMThread</span>
</span><span class='line'><span class="cm">     * object.  Signal anyone who is waiting.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">dvmLockObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">vmThread</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dvmObjectNotifyAll</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">vmThread</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dvmUnlockObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">vmThread</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dvmReleaseTrackedAlloc</span><span class="p">(</span><span class="n">vmThread</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vmThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dvmLockThreadList</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Lose the JNI context.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">dvmDestroyJNIEnv</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">jniEnv</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">jniEnv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">THREAD_ZOMBIE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Remove ourselves from the internal thread list.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">unlinkThread</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">releaseThreadId</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dvmUnlockThreadList</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">setThreadSelf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">freeThread</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Free a Thread struct, and all the stuff allocated within.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">freeThread</span><span class="p">(</span><span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 <code>dvmDetachCurrentThread</code> 函数里，首先获取当前线程 <code>self</code>，这里获得的就是当前执行 <code>thread entry</code> 的新线程，然后通过其对应的<code>Android Thread</code>对象 <code>threadObj</code> 获取该对象所在 <code>group</code>，然后将 <code>threadObj</code> 这个<code>Android Thread</code>对象从 <code>group</code> 中移除；接着清除 <code>Android</code> 与 <code>dalvik</code> 线程之间的关联关系，并通知 <code>join</code> 该线程的其它线程；最后，设置线程状态为 <code>THREAD_ZOMBIE</code>，清除 <code>TLS</code> 中存储的线程值，并通过调用 <code>freeThread</code> 释放内存，至此线程就终结了。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard"><span class="fn">飘飘白云</span> 发表于</span>

      




<time class='entry-date' datetime='2014-07-10T21:21:40+08:00'><span class='date'>2014-07-10</span> <span class='time'>9:21 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ruan-jian-kai-fa/'>软件开发</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/08/android-thread-tutoria01/" title="Previous Post: Android多线程分析之一：使用Thread异步下载图像">&laquo; Android多线程分析之一：使用Thread异步下载图像</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/07/12/android-thread-tutoria03/" title="Next Post: Android多线程分析之三：Handler，Looper的实现">Android多线程分析之三：Handler，Looper的实现 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>文章分类</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/shu-ping-ying-ping/'>书评影评 (44)</a></li>
<li class='category'><a href='/blog/categories/gong-ju-ruan-jian/'>工具软件 (2)</a></li>
<li class='category'><a href='/blog/categories/xin-zhi-si-wei/'>心智思维 (6)</a></li>
<li class='category'><a href='/blog/categories/sui-sui-nian/'>碎碎念 (24)</a></li>
<li class='category'><a href='/blog/categories/she-hui-za-tan/'>社会杂谈 (9)</a></li>
<li class='category'><a href='/blog/categories/du-shu-bi-ji/'>读书笔记 (2)</a></li>
<li class='category'><a href='/blog/categories/ruan-jian-kai-fa/'>软件开发 (8)</a></li>
<li class='category'><a href='/blog/categories/bian-zou-bian-kan/'>边走边看 (2)</a></li>

  </ul>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/12/24/reading/">2022年阅读总结-国学经典与欧亚历史</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/12/24/reading/">2021年阅读总结-学而不思则罔</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/12/31/reading/">2020年阅读统计</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/12/31/reading/">2019年阅读统计</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/12/31/reading/">2018年阅读统计</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>标签云</h1>
  <ul class="tag-cloud">
    <a style="font-size: 110%" href="/tags/shu-ping/">书评</a>
<a style="font-size: 107%" href="/tags/sui-sui-nian/">碎碎念</a>
<a style="font-size: 105%" href="/tags/ying-ping/">影评</a>
<a style="font-size: 103%" href="/tags/si-wei/">思维</a>
<a style="font-size: 101%" href="/tags/za-tan/">杂谈</a>
<a style="font-size: 99%" href="/tags/android/">android</a>
<a style="font-size: 99%" href="/tags/xin-qing/">心情</a>
<a style="font-size: 99%" href="/tags/thread/">thread</a>
<a style="font-size: 98%" href="/tags/hui-yi/">回忆</a>
<a style="font-size: 96%" href="/tags/li-shi/">历史</a>
<a style="font-size: 96%" href="/tags/ri-ben/">日本</a>
<a style="font-size: 96%" href="/tags/zheng-zhi/">政治</a>
<a style="font-size: 96%" href="/tags/gong-ju/">工具</a>
<a style="font-size: 94%" href="/tags/fang-fa-lun/">方法论</a>
<a style="font-size: 94%" href="/tags/lu-you/">旅游</a>
<a style="font-size: 94%" href="/tags/bi-ji/">笔记</a>
<a style="font-size: 94%" href="/tags/jiao-yu/">教育</a>
<a style="font-size: 90%" href="/tags/scheme/">Scheme</a>
<a style="font-size: 90%" href="/tags/xin-li-xue/">心理学</a>
<a style="font-size: 90%" href="/tags/xi-guan/">习惯</a>

  </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - 飘飘白云 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'https-luozhaohui-github-io';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://luozhaohui.github.io/blog/2014/07/10/android-thread-tutoria02/';
        var disqus_url = 'http://luozhaohui.github.io/blog/2014/07/10/android-thread-tutoria02/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


<!-- <noscript>Please enable JavaScript to view the comment form powered by <a href="https://commentit.io/">Comm(ent|it)</a></noscript>
<div id="commentit"></div>
<script type="text/javascript">
  /** CONFIGURATION VARIABLES **/
  var commentitUsername = 'luozhaohui';
  var commentitRepo = 'luozhaohui/luozhaohui.github.io';
  var commentitPath = '_posts/2014-07-10-android-thread-tutoria02.markdown';

  /** DON'T EDIT FOLLOWING LINES **/
  (function() {
      var commentit = document.createElement('script');
      commentit.type = 'text/javascript';
      commentit.async = true;
      commentit.src = 'https://commentit.io/static/embed/dist/commentit.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(commentit);
  })();
</script> -->









</body>
</html>
