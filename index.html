
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>飘飘白云</title>
  <meta name="author" content="飘飘白云">

  
  <meta name="description" content="飘飘白云的个人博客">
  <meta name="keywords" content="编程,阅读,公民,思维,心智,民主,自由">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://luozhaohui.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="飘飘白云" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="//libs.baidu.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">飘飘白云</a></h1>
  
    <h2>所读，所看，所思</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.bing.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="luozhaohui.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="搜索..."/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
  <!-- <li><a href="/blog/archives/tags.html">标签</a></li> -->
  <li><a href="/books">读书如抽丝</a></li>
  <li><a href="/about">关于我</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/07/the-strunggle-for-law/">法律的斗争（萨孟武节录意译本）</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-07T20:30:02+08:00'><span class='date'>2017-08-07</span> <span class='time'>8:30 pm</span></time>
        
           | <a href="/blog/2017/08/07/the-strunggle-for-law/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2017/08/07/the-strunggle-for-law/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>简介</h2>

<p>耶林的名作：《The Struggle For Low》为权利而斗争。
[德]鲁道夫·冯·耶林著<br/>
萨孟武 译</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2017/08/07/the-strunggle-for-law/">阅读全文 &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/03/15/cpp-scheme/">C++ 11模板元编程实现Scheme中的list及相关函数式编程接口</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-03-15T09:03:20+08:00'><span class='date'>2017-03-15</span> <span class='time'>9:03 am</span></time>
        
           | <a href="/blog/2017/03/15/cpp-scheme/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2017/03/15/cpp-scheme/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前言</h2>

<p>本文将介绍如何使用<code>C++11</code>模板元编程实现<code>Scheme</code>中的<code>list</code>及相关函数式编程接口，如<code>list</code>，<code>cons</code>，<code>car</code>，<code>cdr</code>，<code>length</code>，<code>is_empty</code>，<code>reverse</code>，<code>append</code>,<code>map</code>，<code>transform</code>，<code>enumerate</code>，<code>lambda</code>等。</p>

<h2>预备知识</h2>

<h3>Scheme简介</h3>

<p><a href="http://schemers.org/">Scheme</a>语言是<code>lisp</code>语言的一个方言(或说成变种)，它诞生于1975年的<code>MIT</code>，对于这个有近三十年历史的编程语言来说，它并没有象 C++，java，C#那样受到商业领域的青睐，在国内更是鲜为人知。但它在国外的计算机教育领域内却是有着广泛应用的，有很多人学的第一门计算机语言就 是<code>Scheme</code>语言（<a href="https://book.douban.com/subject/1148282/">SICP</a>曾经就是以<code>Scheme</code>为教学语言）。</p>

<p>它是一个小巧而又强大的语言，作为一个多用途的编程语言，它可以作为脚本语言使用，也可以作为应用软件的扩展语言来使用，它具有元语言特性，还有很多独到的特色,以致于它被称为编程语言中的"皇后"。</p>

<p>如果你对<code>Scheme</code>感兴趣，推荐使用<a href="http://racket-lang.org/">drracket</a>这个</ode>GUI</code>解释器，入门教程有：<a href="http://www.htdp.org/">How to Design Programs</a>，高级教程有：<a href="https://book.douban.com/subject/1148282/">SICP</a>。</p>

<h3>Scheme中的list及相关操作</h3>

<p><code>list</code>可以说是<code>Lisp</code>系语言的根基，其名就得自于<code><strong>LIS</strong>t <strong>P</strong>rocessor</code>，其重要性就像文件概念之于<code>unix</code>。</p>

<p><code>list</code>示例：</p>

<blockquote><p>(list &ldquo;red&rdquo; &ldquo;green&rdquo; &ldquo;blue&rdquo;)<br/>
&lsquo;(&ldquo;red&rdquo; &ldquo;green&rdquo; &ldquo;blue&rdquo;)<br/>
(list 1 2 3)<br/>
&rsquo;(1 2 3)</p></blockquote>

<p>上面的语法糖<code>list</code>其实是通过递归调用点对<code>cons</code>实现的，因此上面的语法等价于：</p>

<blockquote><p>(cons &ldquo;red&rdquo; (cons &ldquo;green&rdquo; (cons &ldquo;blue&rdquo; empty)))<br/>
&lsquo;(&ldquo;red&rdquo; &ldquo;green&rdquo; &ldquo;blue&rdquo;)<br/>
(cons 1 (cons 2 (cons 3 empty)))<br/>
&rsquo;(1 2 3)</p></blockquote>

<p>另外两个重要的点对操作是<code>car</code>和<code>cdr</code>，名字有点奇怪但是是有<a href="https://en.wikipedia.org/wiki/CAR_and_CDR">历史的</a>：<strong>C</strong>urrent <strong>A</strong>ddress <strong>R</strong>egister and <strong>C</strong>urrent <strong>D</strong>ecrement <strong>R</strong>egister，其实就相当于<code>first</code>和<code>second</code>的意思。</p>

<blockquote><p>(car (cons 1 2))  ==> 1<br/>
(cdr (cons 1 2))  ==> 2</p></blockquote>

<h3>模板元编程</h3>

<p>C++中的Meta Programming，即模板元编程，是图灵完备的，而且是编译期间完成的。模板元编程通常用于编写工具库，如STL、Boost等。</p>

<p>比如通常我们使用递归来实现实现阶乘：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;iostream&gt;
</span><span class='line'> 
</span><span class='line'>unsigned int factorial(unsigned int n) {
</span><span class='line'>    return n == 0 ? 1 : n * factorial(n - 1);
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>int main() {
</span><span class='line'>    std::cout &lt;&lt; factorial(5) &lt;&lt; std::endl;
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>我们也可以通过模板元编程来实现：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;iostream&gt;
</span><span class='line'>
</span><span class='line'>template &lt;unsigned int n&gt;
</span><span class='line'>struct factorial {
</span><span class='line'>    static constexpr unsigned int value = n * factorial&lt;n - 1&gt;::value;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;&gt;
</span><span class='line'>struct factorial&lt;0&gt; {
</span><span class='line'>    static constexpr unsigned int value = 1;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>int main() {
</span><span class='line'>    std::cout &lt;&lt; factorial&lt;5&gt;::value &lt;&lt; std::endl; // 120
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>实现</h2>

<p>本文完整代码可以在这里查看：<a href="https://github.com/luozhaohui/cpp/blob/master/cons.cpp">点击查看代码</a></p>

<h3>基本数据结构</h3>

<p>为了用模板元编程来模拟Scheme中<code>list</code>即相关操作，我们需要先定义一些模板数据结构。这些数据结构非常简单，即重新定义基本数据类型，为了简化，在这里我只特化了必须的<code>int</code>、<code>uint</code>、<code>bool</code>以及<code>empty</code>的实现。<code>empty</code>是递归实现<code>list</code>的最后一个元素，其作用相当于<code>&lsquo;\0&rsquo;</code>之于字符串。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// type_
</span><span class='line'>//
</span><span class='line'>template &lt;typename T, T N&gt;
</span><span class='line'>struct type_ {
</span><span class='line'>    using type = type_&lt;T, N&gt;;
</span><span class='line'>    using value_type = T;
</span><span class='line'>    static constexpr T value = N;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>// int_
</span><span class='line'>//
</span><span class='line'>template &lt;int N&gt;
</span><span class='line'>struct int_ {
</span><span class='line'>    using type = int_&lt;N&gt;;
</span><span class='line'>    using value_type = int;
</span><span class='line'>    static constexpr int value = N;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>// uint_
</span><span class='line'>//
</span><span class='line'>template &lt;unsigned int N&gt;
</span><span class='line'>struct uint_ {
</span><span class='line'>    using type = uint_&lt;N&gt;;
</span><span class='line'>    using value_type = unsigned int;
</span><span class='line'>    static constexpr unsigned int value = N;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;&gt;
</span><span class='line'>struct uint_&lt;0&gt; {
</span><span class='line'>    using type = uint_&lt;0&gt;;
</span><span class='line'>    using value_type = unsigned int;
</span><span class='line'>    static constexpr unsigned int value = 0;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>// bool_
</span><span class='line'>template &lt;bool N&gt;
</span><span class='line'>struct bool_ {
</span><span class='line'>    using type = bool_&lt;N&gt;;
</span><span class='line'>    using value_type = bool;
</span><span class='line'>    static constexpr bool value = N;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>// empty
</span><span class='line'>//
</span><span class='line'>struct empty {
</span><span class='line'>    using type = empty;
</span><span class='line'>    using value = empty;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>下面我们先来个小示例，看看怎么使用这些模板数据结构。这个示例的作用是将仅仅用0和1表示的十进制数字当成二进制看，转换为十进制数值。如：101 转换为十进制数值为 5.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;unsigned int N&gt;
</span><span class='line'>struct binary : uint_ &lt; binary &lt; N / 10 &gt;::type::value * 2 + (N % 10) &gt; {};
</span><span class='line'>
</span><span class='line'>template &lt;&gt;
</span><span class='line'>struct binary&lt;0&gt; : uint_&lt;0&gt; {};</span></code></pre></td></tr></table></div></figure>


<p>测试示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>std::cout &lt;&lt; binary&lt;101&gt;::value &lt;&lt; std::endl;               // 5</span></code></pre></td></tr></table></div></figure>


<h3>cons &amp; car &amp; cdr实现</h3>

<p><code>cons</code>的实现原理很简单：就是能够递归调用自己结合成点对<code>pair</code>。在<code>Scheme</code>中示例如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(cons 1 (cons 2 (cons 3 '())))</span></code></pre></td></tr></table></div></figure>


<p>其中<code>&lsquo;()</code>表示空的点对<code>pair</code>，在我们的实现里面就是<code>empty</code>。</p>

<p>因此<code>cons</code>用C++元编程实现就是：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;typename h, typename t&gt;
</span><span class='line'>struct cons {
</span><span class='line'>    using type = cons&lt;h, t&gt;;
</span><span class='line'>    using head = h;
</span><span class='line'>    using tail = t;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>std::cout &lt;&lt; cons&lt;int_&lt;1&gt;, int_&lt;2&gt;&gt;::head::value &lt;&lt; std::endl;  // 1</span></code></pre></td></tr></table></div></figure>


<p>同样，我们可以实现用于获取<code>head</code>的<code>car</code>与获取<code>tail</code>的<code>cdr</code>操作：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct car_t {
</span><span class='line'>    template &lt;typename cons&gt;
</span><span class='line'>    struct apply {
</span><span class='line'>        using type = typename cons::type::head;
</span><span class='line'>    };
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename cons&gt;
</span><span class='line'>struct car : car_t::template apply&lt;cons&gt;::type {};
</span><span class='line'>
</span><span class='line'>struct cdr_t {
</span><span class='line'>    template &lt;typename cons&gt;
</span><span class='line'>    struct apply {
</span><span class='line'>        using type = typename cons::type::tail::type;
</span><span class='line'>    };
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename cons&gt;
</span><span class='line'>struct cdr : cdr_t::template apply&lt;cons&gt;::type {};</span></code></pre></td></tr></table></div></figure>


<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using c1 = cons&lt;int_&lt;1&gt;, cons&lt;int_&lt;2&gt;, int_&lt;3&gt;&gt;&gt;;
</span><span class='line'>std::cout &lt;&lt; car&lt;c1&gt;::value &lt;&lt; ", " &lt;&lt; cdr&lt;c1&gt;::head::value &lt;&lt; std::endl; // 1, 2
</span><span class='line'>std::cout &lt;&lt; car&lt;c1&gt;::value &lt;&lt; ", " &lt;&lt; car&lt;cdr&lt;c1&gt;&gt;::value &lt;&lt; std::endl; // 1, 2</span></code></pre></td></tr></table></div></figure>


<p>对于上面的实现，稍微解释一下：<code>car</code>是对<code>car_t</code>的封装，这样使用起来更为方便，对比如下用法就能明了，后面这样的封装手法还会用到：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>car&lt;cons&lt;int_&lt;1&gt;, int_&lt;2&gt;&gt;::value                   // == 1
</span><span class='line'>car_f::template apply&lt;cons&lt;int_&lt;1&gt;, int_&lt;2&gt;&gt;::value // == 1</span></code></pre></td></tr></table></div></figure>


<h3>list的实现</h3>

<p><code>list</code>其实一种特殊的<code>cons</code>，其实现如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;typename first = empty, typename ...rest&gt;
</span><span class='line'>struct list_t : std::conditional &lt;
</span><span class='line'>    sizeof...(rest) == 0,
</span><span class='line'>    cons&lt;first, empty&gt;,
</span><span class='line'>    cons&lt;first, typename list_t&lt;rest...&gt;::type&gt;&gt;::type
</span><span class='line'>{};
</span><span class='line'>
</span><span class='line'>template &lt;&gt;
</span><span class='line'>struct list_t&lt;empty&gt; : empty {};
</span><span class='line'>
</span><span class='line'>template &lt;typename T, T ...elements&gt;
</span><span class='line'>struct list : list_t&lt;type_&lt;T, elements&gt;...&gt; {};</span></code></pre></td></tr></table></div></figure>


<p>这里用到了C++11中的变长模板参数，<code>std::conditional</code>以及对<code>empty</code>的特化处理。
 - 变长模板参数：<code>list</code>接收变长模板参数<code>elements</code>，然后封装类型为成<code>type_</code>的变长模板参数forward给<code>list_t</code>；
 - <code>std::conditional</code>：相当于<code>if &hellip; else &hellip;</code>，如果第一参数为真，则返回第二参数，否则返回第三参数；
 - &lt;第一参数中的code>sizeof&hellip;(rest)</code>：<code>sizeof</code>是C++11的新用法，用于获取变长参数的个数；
 - 第二参数的作用是终止递归；
 - 第三参数的作用是递归调用<code>list_t</code>构造点对。
 - 因为<code>empty</code>比较特殊，所以需要特化处理</p>

<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using l1 = list&lt;int, 1, 2, 3&gt;;
</span><span class='line'>using l2 = list&lt;int, 4, 5, 6, 7&gt;;
</span><span class='line'>using l3 = list_t&lt;int_&lt;1&gt;, int_&lt;2&gt;, int_&lt;3&gt;&gt;;
</span><span class='line'>
</span><span class='line'>std::cout &lt;&lt; "\n&gt;list" &lt;&lt; std::endl;
</span><span class='line'>print&lt;l1&gt;();    // 1, 2, 3
</span><span class='line'>print&lt;l3&gt;();    // 1, 2, 3
</span><span class='line'>std::cout &lt;&lt; car&lt;l1&gt;::value &lt;&lt; ", " &lt;&lt; cdr&lt;l1&gt;::head::value &lt;&lt; std::endl;   // 1, 2</span></code></pre></td></tr></table></div></figure>


<h3>length &amp; is_empty的实现</h3>

<p>先来看看<code>length<code>的实现，其思路与list的实现一样：递归调用自身，并针对<code>empty</code>特化处理。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;typename list&gt;
</span><span class='line'>struct length_t
</span><span class='line'>{
</span><span class='line'>    static constexpr unsigned int value =
</span><span class='line'>        1 + length_t&lt;typename cdr&lt;list&gt;::type&gt;::value;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;&gt;
</span><span class='line'>struct length_t&lt;empty&gt;
</span><span class='line'>{
</span><span class='line'>    static constexpr unsigned int value = 0;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename list&gt;
</span><span class='line'>struct length
</span><span class='line'>{
</span><span class='line'>    static constexpr unsigned int value = length_t&lt;typename list::type&gt;::value;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p><code>is_empty</code>可以简单实现为判断<code>length</code>为0：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;typename list&gt;
</span><span class='line'>struct is_empty
</span><span class='line'>{
</span><span class='line'>    static constexpr bool value = (0 == length&lt;list&gt;::value);
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>当然这样的实现效率并不高，因此可以通过对<code>list</code>以及<code>empty</code>的特化处理来高效实现：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;typename list&gt;
</span><span class='line'>struct is_empty_t
</span><span class='line'>{
</span><span class='line'>    static constexpr bool value = false;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;&gt;
</span><span class='line'>struct is_empty_t&lt;empty&gt;
</span><span class='line'>{
</span><span class='line'>    static constexpr bool value = true;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename list&gt;
</span><span class='line'>struct is_empty
</span><span class='line'>{
</span><span class='line'>    static constexpr bool value = is_empty_t&lt;typename list::type&gt;::value;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>std::cout &lt;&lt; "is_empty&lt;empty&gt; : " &lt;&lt; is_empty&lt;empty&gt;::value &lt;&lt; std::endl;            // 1
</span><span class='line'>std::cout &lt;&lt; "is_empty&lt;list&lt;int&gt;&gt; : " &lt;&lt; is_empty&lt;list&lt;int&gt;&gt;::value &lt;&lt; std::endl;    // 1
</span><span class='line'>std::cout &lt;&lt; "is_empty&lt;list&lt;int, 1, 2, 3&gt;&gt; : " &lt;&lt; is_empty&lt;l1&gt;::value &lt;&lt; std::endl;  // 0
</span><span class='line'>std::cout &lt;&lt; "length&lt;empty&gt; : " &lt;&lt; length&lt;empty&gt;::value &lt;&lt; std::endl;                // 0
</span><span class='line'>std::cout &lt;&lt; "length&lt;list&lt;int&gt;&gt; : " &lt;&lt; length&lt;list&lt;int&gt;&gt;::value &lt;&lt; std::endl;        // 0
</span><span class='line'>std::cout &lt;&lt; "length&lt;list&lt;int, 1, 2, 3&gt;&gt; : " &lt;&lt; length&lt;l1&gt;::value &lt;&lt; std::endl;      // 3</span></code></pre></td></tr></table></div></figure>


<h3>append &amp; reverse的实现</h3>

<p><code>append</code>是将一个列表list2追加到已有列表list1的后面，其实现思路是递归地将car<list1>当做head，然后将cdr<list1>作为新的list1递归调用append。不要忘记特化<code>empty</code>的情况。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct append_t {
</span><span class='line'>    template &lt;typename list1, typename list2&gt;
</span><span class='line'>    struct apply : cons&lt;
</span><span class='line'>        typename car&lt;list1&gt;::type,
</span><span class='line'>        typename append_t::template apply&lt;typename cdr&lt;list1&gt;::type, list2&gt;::type&gt;
</span><span class='line'>    {};
</span><span class='line'>
</span><span class='line'>    template&lt;typename list2&gt;
</span><span class='line'>    struct apply &lt;empty, list2&gt;: list2
</span><span class='line'>    {};
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename list1, typename list2&gt;
</span><span class='line'>struct append : std::conditional &lt;
</span><span class='line'>    is_empty&lt;list1&gt;::value,
</span><span class='line'>    list2,
</span><span class='line'>    append_t::template apply&lt;list1, list2&gt;
</span><span class='line'>    &gt;::type
</span><span class='line'>{};</span></code></pre></td></tr></table></div></figure>


<p><code>reverse</code>的实现思路与<code>append</code>类似，只不过是要逆序罢了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct reverse_t {
</span><span class='line'>    template &lt;typename reset, typename ready&gt;
</span><span class='line'>    struct apply : reverse_t::template apply&lt;
</span><span class='line'>            typename cdr&lt;reset&gt;::type,
</span><span class='line'>            cons&lt;typename car&lt;reset&gt;::type, ready&gt;&gt;
</span><span class='line'>    {};
</span><span class='line'>
</span><span class='line'>    template&lt;typename ready&gt;
</span><span class='line'>    struct apply &lt;empty, ready&gt; : ready
</span><span class='line'>    {};
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename list&gt;
</span><span class='line'>struct reverse : std::conditional &lt;
</span><span class='line'>    is_empty&lt;list&gt;::value,
</span><span class='line'>    list,
</span><span class='line'>    reverse_t::template apply&lt;typename list::type, empty&gt;
</span><span class='line'>    &gt;::type
</span><span class='line'>{};</span></code></pre></td></tr></table></div></figure>


<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// reverse
</span><span class='line'>using r1 = reverse&lt;l1&gt;;
</span><span class='line'>using r2 = reverse&lt;list&lt;int&gt;&gt;;
</span><span class='line'>print&lt;r1&gt;();    // 3, 2, 1
</span><span class='line'>print&lt;r2&gt;();
</span><span class='line'>
</span><span class='line'>// append
</span><span class='line'>using a1 = append&lt;l1, l2&gt;;
</span><span class='line'>using a2 = append&lt;l1, list&lt;int&gt;&gt;;
</span><span class='line'>using a3 = append&lt;list&lt;int&gt;, l1&gt;;
</span><span class='line'>print&lt;a1&gt;();    // 1, 2, 3, 4, 5, 6, 7
</span><span class='line'>print&lt;a2&gt;();    // 1, 2, 3
</span><span class='line'>print&lt;a3&gt;();    // 1, 2, 3</span></code></pre></td></tr></table></div></figure>


<h3>函数式编程</h3>

<p><code>lisp</code>系语言的最大特性就是支持函数式编程，它能够把无差别地对待数据与函数，实现了对数据与代码的同等抽象。下面我们来添加对函数式编程的支持：<code>enumerate</code>, <code>map</code>，<code>apply</code>, <code>lambda</code> 以及 <code>transform</code>。</p>

<h4>map的实现</h4>

<p><code>map</code>的语义是迭代地将某个方法作用于列表中的每个元素，然后得到结果<code>list</code>。先来定义一些辅助的方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;typename T, typename N&gt;
</span><span class='line'>struct plus : int_ &lt; T::value + N::value &gt; {};
</span><span class='line'>
</span><span class='line'>template &lt;typename T, typename N&gt;
</span><span class='line'>struct minus : int_ &lt; T::value - N::value &gt; {};
</span><span class='line'>
</span><span class='line'>struct inc_t {
</span><span class='line'>    template &lt;typename n&gt;
</span><span class='line'>    struct apply : int_ &lt; n::value + 1 &gt; {};
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename n&gt;
</span><span class='line'>struct inc : int_ &lt; n::value + 1 &gt; {};</span></code></pre></td></tr></table></div></figure>


<p>下面来看map的实现</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct map_t {
</span><span class='line'>    template &lt;typename fn, typename list&gt;
</span><span class='line'>    struct apply : cons &lt;
</span><span class='line'>        typename fn::template apply&lt;typename car&lt;list&gt;::type&gt;,
</span><span class='line'>        map_t::template apply&lt;fn, typename cdr&lt;list&gt;::type&gt;
</span><span class='line'>    &gt;{};
</span><span class='line'>
</span><span class='line'>    template &lt;typename fn&gt;
</span><span class='line'>    struct apply &lt;fn, empty&gt;: empty{};
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename fn, typename list&gt;
</span><span class='line'>struct map : std::conditional &lt;
</span><span class='line'>    is_empty&lt;list&gt;::value,
</span><span class='line'>    list,
</span><span class='line'>    map_t::template apply&lt;fn, list&gt;
</span><span class='line'>    &gt;::type
</span><span class='line'>{};</span></code></pre></td></tr></table></div></figure>


<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using m1 = map&lt;inc_t, list&lt;int, 1, 2, 3&gt;&gt;;
</span><span class='line'>using m2 = map&lt;inc_t, list&lt;int&gt;&gt;;
</span><span class='line'>print&lt;m1&gt;();    // 2, 3, 4
</span><span class='line'>print&lt;m2&gt;();</span></code></pre></td></tr></table></div></figure>


<p>为了让<code>map</code>支持形如<code>inc</code>这样的模板类，而不仅仅是形如<code>inc_t</code>，我们需要定义一个转换器：<code>lambda</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct apply_t {
</span><span class='line'>    template &lt;template &lt;typename...&gt; class F, typename ...args&gt;
</span><span class='line'>    struct apply : F&lt;typename args::type...&gt; {};
</span><span class='line'>
</span><span class='line'>    template &lt;template &lt;typename...&gt; class F&gt;
</span><span class='line'>    struct apply &lt;F, empty&gt; : empty {};
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;template &lt;typename...&gt; class F, typename ...args&gt;
</span><span class='line'>struct apply : apply_t::template apply&lt;F, args...&gt; {};
</span><span class='line'>
</span><span class='line'>template &lt;template &lt;typename...&gt; class F&gt;
</span><span class='line'>struct lambda {
</span><span class='line'>    template &lt;typename ...args&gt;
</span><span class='line'>    struct apply : apply_t::template apply&lt;F, args...&gt; {};
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>std::cout &lt;&lt; lambda&lt;inc&gt;::template apply&lt;int_&lt;0&gt;&gt;::value &lt;&lt; std::endl;  // 1
</span><span class='line'>using ml1 = map&lt;lambda&lt;inc&gt;, list&lt;int, 1, 2, 3&gt;&gt;;
</span><span class='line'>print&lt;ml1&gt;();  // 2, 3, 4</span></code></pre></td></tr></table></div></figure>


<h3>transform的实现</h3>

<p><code>transform</code>的语义是对迭代地将某个方法作用于两个列表上的元素，然后得到结果<code>list</code>。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct transform_t {
</span><span class='line'>    template &lt;typename list1, typename list2, typename fn&gt;
</span><span class='line'>    struct apply : cons &lt;
</span><span class='line'>        typename fn::template apply&lt;
</span><span class='line'>            typename car&lt;list1&gt;::type, typename car&lt;list2&gt;::type&gt;::type,
</span><span class='line'>        typename transform_t::template apply &lt;
</span><span class='line'>            typename cdr&lt;list1&gt;::type, typename cdr&lt;list2&gt;::type, fn&gt;::type
</span><span class='line'>    &gt; {};
</span><span class='line'>
</span><span class='line'>    template &lt;typename list1, typename fn&gt;
</span><span class='line'>    struct apply&lt;list1, empty, fn&gt; : cons &lt;
</span><span class='line'>        typename fn::template apply&lt;typename car&lt;list1&gt;::type, empty&gt;,
</span><span class='line'>        typename transform_t::template apply &lt;typename cdr&lt;list1&gt;::type, empty, fn&gt;::type
</span><span class='line'>    &gt; {};
</span><span class='line'>
</span><span class='line'>    template &lt;typename list2, typename fn&gt;
</span><span class='line'>    struct apply&lt;empty, list2, fn&gt; : cons &lt;
</span><span class='line'>        typename fn::template apply&lt;empty, typename car&lt;list2&gt;::type&gt;::type,
</span><span class='line'>        typename transform_t::template apply &lt;empty, typename cdr&lt;list2&gt;::type, fn&gt;::type
</span><span class='line'>    &gt; {};
</span><span class='line'>
</span><span class='line'>    template &lt;typename fn&gt;
</span><span class='line'>    struct apply&lt;empty, empty, fn&gt; : empty {};
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename list1, typename list2, typename fn&gt;
</span><span class='line'>struct transform : std::conditional &lt;
</span><span class='line'>    is_empty&lt;list1&gt;::value,
</span><span class='line'>    list1,
</span><span class='line'>    transform_t::template apply&lt;list1, list2, fn&gt;
</span><span class='line'>    &gt;::type
</span><span class='line'>{
</span><span class='line'>    static_assert(length&lt;list1&gt;::value == length&lt;list2&gt;::value, "transform: length of lists mismatch!");
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>其实现是最为复杂的，我们先来看使用示例，再来讲解实现细节。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using t1 = list&lt;int, 1, 2, 3&gt;;
</span><span class='line'>using t2 = list&lt;int, 3, 2, 1&gt;;
</span><span class='line'>using ml = transform&lt;t1, t2, lambda&lt;minus&gt;&gt;;
</span><span class='line'>using pl = transform&lt;t1, t2, lambda&lt;plus&gt;&gt;;
</span><span class='line'>using te = transform&lt;list&lt;int&gt;, list&lt;int&gt;, lambda&lt;plus&gt;&gt;;
</span><span class='line'>using el = transform&lt;t1, list&lt;int&gt;, lambda&lt;plus&gt;&gt;;
</span><span class='line'>print&lt;ml&gt;();    // -2, 0, 2
</span><span class='line'>print&lt;pl&gt;();    // 4, 4, 4
</span><span class='line'>print&lt;te&gt;();
</span><span class='line'>// print&lt;el&gt;(); // assertion: length mismatch!</span></code></pre></td></tr></table></div></figure>


<p>实现细节：</p>

<ul>
<li>使用<code>C++11</code>新特性<code>static_assert</code>对两个列表的长度相等做断言；</li>
<li>使用<code>std::conditional</code>处理空列表，如果非空<code>forward</code>给<code>transform_t</code>；</li>
<li>对<code>transform_t</code>特化处理空列表的情况；</li>
<li>如果<code>list1</code>与<code>list2</code>均非空，那么通过<code>car</code>取出两个列表的<code>head</code>作用于方法，然后递归调用<code>transform_t</code>作用于两个列表的<code>tail</code>。</li>
</ul>


<h3>enumerate的实现</h3>

<p><code>enumerate</code>的语义是迭代将某个方法作用于列表元素。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;typename fn, typename list, bool is_empty&gt;
</span><span class='line'>struct enumerate_t;
</span><span class='line'>
</span><span class='line'>template &lt;typename fn, typename list&gt;
</span><span class='line'>void enumerate(fn f)
</span><span class='line'>{
</span><span class='line'>    enumerate_t&lt;fn, list, is_empty&lt;list&gt;::value&gt; impl;
</span><span class='line'>    impl(f);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>template &lt;typename fn, typename list, bool is_empty = false&gt;
</span><span class='line'>struct enumerate_t
</span><span class='line'>{
</span><span class='line'>    void operator()(fn f) {
</span><span class='line'>        f(car&lt;list&gt;::value);
</span><span class='line'>        enumerate&lt;fn, typename cdr&lt;list&gt;::type&gt;(f);
</span><span class='line'>    }
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename fn, typename list&gt;
</span><span class='line'>struct enumerate_t&lt;fn, list, true&gt;
</span><span class='line'>{
</span><span class='line'>    void operator()(fn f) {
</span><span class='line'>        // nothing for empty
</span><span class='line'>    }
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p><code>enumerate</code>的实现与之前的<code>map</code>的实现很不一样，它是通过模板方法与函数子来实现的。模板方法内部调用函数子来做事情，函数子又是一个模板类，并对空列表做了特化处理。</p>

<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using value_type = typename car&lt;e1&gt;::value_type;
</span><span class='line'>auto sqr_print = [](value_type val) { std::cout &lt;&lt; val * val &lt;&lt; " "; };
</span><span class='line'>enumerate&lt;decltype(sqr_print), e1&gt;(sqr_print);      // 1 4 9</span></code></pre></td></tr></table></div></figure>


<h3>equal的实现</h3>

<p><code>equal</code>用于判断两个列表是否等价。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct equal_t {
</span><span class='line'>    // both lists are not empty
</span><span class='line'>    template &lt;typename list1, typename list2, int empty_value = 0,
</span><span class='line'>        typename pred = lambda&lt;std::is_same&gt;&gt;
</span><span class='line'>    struct apply : std::conditional &lt;
</span><span class='line'>        !pred::template apply &lt;
</span><span class='line'>            typename car&lt;list1&gt;::type,
</span><span class='line'>            typename car&lt;list2&gt;::type
</span><span class='line'>            &gt;::type::value,
</span><span class='line'>        bool_&lt;false&gt;,
</span><span class='line'>        typename equal_t::template apply &lt;
</span><span class='line'>            typename cdr&lt;list1&gt;::type,
</span><span class='line'>            typename cdr&lt;list2&gt;::type,
</span><span class='line'>            (is_empty&lt;typename cdr&lt;list1&gt;::type&gt;::value
</span><span class='line'>                + is_empty&lt;typename cdr&lt;list2&gt;::type&gt;::value),
</span><span class='line'>            pred
</span><span class='line'>        &gt;::type
</span><span class='line'>    &gt; {};
</span><span class='line'>
</span><span class='line'>    // one of the list is empty.
</span><span class='line'>    template &lt;typename list1, typename list2, typename pred&gt;
</span><span class='line'>    struct apply&lt;list1, list2, 1, pred&gt;: bool_&lt;false&gt;
</span><span class='line'>    {};
</span><span class='line'>
</span><span class='line'>    // both lists are empty.
</span><span class='line'>    template &lt;typename list1, typename list2, typename pred&gt;
</span><span class='line'>    struct apply&lt;list1, list2, 2, pred&gt;: bool_&lt;true&gt;
</span><span class='line'>    {};
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename list1, typename list2, typename pred = lambda&lt;std::is_same&gt;&gt;
</span><span class='line'>struct equal : equal_t::template apply&lt;list1, list2,
</span><span class='line'>    (is_empty&lt;list1&gt;::value + is_empty&lt;list2&gt;::value), pred&gt;::type
</span><span class='line'>{};</span></code></pre></td></tr></table></div></figure>


<p><code>equal</code>的实现也有点复杂。</p>

<ul>
<li><code>pred</code>是等价比较谓词，默认是使用<code>std::is_same</code>来做比较；</li>
<li>关键部分依然是通过<code>std::conditional</code>来实现的；</li>
<li>第一参数是判断两个列表的<code>head</code>是否相等；</li>
<li>如果不等就返回第二参数；</li>
<li>如果相等就递归比较两个列表的剩余元素；</li>
<li>这里使用了一个小小的技巧来简化模板类特化的情况：如果其中一个列表为空，那么<code>empty_value</code>为1；如果两个列表均为空，那么<code>empty_value</code>为2，这两种情况都会调用特化版本。</li>
</ul>


<p>使用示例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using e1 = list&lt;int, 1, 2, 3&gt;;
</span><span class='line'>using e2 = list&lt;int, 1, 2, 3&gt;;
</span><span class='line'>using e3 = list&lt;int, 1, 2, 1&gt;;
</span><span class='line'>std::cout &lt;&lt; "equal&lt;e1, e2&gt; : " &lt;&lt; equal&lt;e1, e2&gt;::value &lt;&lt; std::endl;   // 1
</span><span class='line'>std::cout &lt;&lt; "equal&lt;e1, e3&gt; : " &lt;&lt; equal&lt;e1, e3&gt;::value &lt;&lt; std::endl;   // 0
</span><span class='line'>std::cout &lt;&lt; "equal&lt;e1, list&lt;int&gt;&gt; : " &lt;&lt; equal&lt;e1, list&lt;int&gt;&gt;::value &lt;&lt; std::endl; // 0
</span><span class='line'>std::cout &lt;&lt; "equal&lt;list&lt;int&gt;, e1&gt; : " &lt;&lt; equal&lt;list&lt;int&gt;, e1&gt;::value &lt;&lt; std::endl; // 0
</span><span class='line'>std::cout &lt;&lt; "equal&lt;list&lt;int&gt;, list&lt;int&gt;&gt; : " &lt;&lt; equal&lt;list&lt;int&gt;, list&lt;int&gt;&gt;::value &lt;&lt; std::endl;   // 1</span></code></pre></td></tr></table></div></figure>


<h3>print的实现</h3>

<p><code>print</code>是依次打印列表元素，也可以使用<code>enumerate</code>来实现：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>template &lt;typename list, bool is_empty&gt;
</span><span class='line'>struct print_t;
</span><span class='line'>
</span><span class='line'>template &lt;typename list&gt;
</span><span class='line'>void print()
</span><span class='line'>{
</span><span class='line'>    print_t&lt;list, is_empty&lt;list&gt;::value&gt; impl;
</span><span class='line'>    impl();
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>template &lt;typename list, bool is_empty = true&gt;
</span><span class='line'>struct print_t
</span><span class='line'>{
</span><span class='line'>    void operator()() {
</span><span class='line'>        std::cout &lt;&lt; std::endl;
</span><span class='line'>    }
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>template &lt;typename list&gt;
</span><span class='line'>struct print_t&lt;list, false&gt;
</span><span class='line'>{
</span><span class='line'>    void operator()() {
</span><span class='line'>        std::cout &lt;&lt; car&lt;list&gt;::value;
</span><span class='line'>        using rest = typename cdr&lt;list&gt;::type;
</span><span class='line'>        if (false == is_empty&lt;rest&gt;::value) {
</span><span class='line'>            std::cout &lt;&lt; ", ";
</span><span class='line'>        }
</span><span class='line'>        print&lt;rest&gt;();
</span><span class='line'>    }
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p><code>print</code>的实现思路与<code>enumerate</code>，是通过模板方法与函数子来实现的。模板方法内部调用函数子来做事情，函数子又是一个模板类，并对空列表做了特化处理。</p>

<h2>总结</h2>

<p><code>C++</code>尤其是<code>C++</code>11，14，17等新特性使得这把实用的瑞士军刀越发锋利与实用，虽然实现的形式上不如<code>Scheme</code>、<code>Python</code>等优雅，但它确实能够，而且无需获得语言层面上的支持。纸上得来终觉浅，绝知此事要躬行。看过本文的读者不妨自己实现一番本文中的提到的相关概念。</p>

<h3>参考阅读</h3>

<p><a href="https://book.douban.com/subject/1148282/">《计算机程序的构造与解释》</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/01/reading/">2016年阅读统计</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-01-01T05:42:38+08:00'><span class='date'>2017-01-01</span> <span class='time'>5:42 am</span></time>
        
           | <a href="/blog/2017/01/01/reading/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2017/01/01/reading/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前言</h2>

<p>2016年又即将过去了，这一年阅读时间相比往年少了许多，总计只阅读了 46 本书，评价以四星、五星图书为主，主题以历史、编程、育儿为主。其中有几本是重读，如《万历十五年》、《论美国的民主》、《士与中国文化》、《COM本质论》等。</p>

<h2>2016年阅读统计，本页面由代码自动生成</h2>

<h2>总计阅读 46 本</h2>

<h3>评价统计:</h3>

<p><img src="https://i.imgur.com/553cdL2.png" alt="评价统计" /></p>

<blockquote><p>五星图书 14 本，占比 30.4%<br/>
四星图书 25 本，占比 54.3%<br/>
三星图书 6 本，占比 13.0%<br/>
两星图书 1 本，占比 2.2%</p></blockquote>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2017/01/01/reading/">阅读全文 &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/25/android-zygote-server/">Android5 Zygote 与 SystemServer 启动流程分析</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-02-25T22:13:20+08:00'><span class='date'>2016-02-25</span> <span class='time'>10:13 pm</span></time>
        
           | <a href="/blog/2016/02/25/android-zygote-server/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2016/02/25/android-zygote-server/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前言</h2>

<p><code>Android5.0.1</code> 的启动流程与之前的版本相比变化并不大，OK，变化虽然还是有：<code>SystemServer</code> 启动过程的 <code>init1()</code>, <code>init2()</code>没有了，但主干流程依然不变：<code>Linux</code> 内核加载完毕之后，首先启动 <code>init</code> 进程，然后解析 <code>init.rc</code>，并根据其内容由 <code>init</code> 进程装载 <code>Android</code> 文件系统、创建系统目录、初始化属性系统、启动一些守护进程，其中最重要的守护进程就是 <code>Zygote</code> 进程。<code>Zygote</code> 进程初始化时会创建 <code>Dalvik</code> 虚拟机、预装载系统的资源和 <code>Java</code> 类。所有从 <code>Zygote</code> 进程 <code>fork</code> 出来的用户进程都将继承和共享这些预加载的资源。<code>init</code> 进程是 <code>Android</code> 的第一个进程，而 <code>Zygote</code> 进程则是所有用户进程的根进程。<code>SystemServer</code> 是 <code>Zygote</code> 进程 <code>fork</code> 出的第一个进程，也是整个 <code>Android</code> 系统的核心进程。</p>

<h2>zygote 进程</h2>

<h3>解析 zygote.rc</h3>

<p>在文件中 /system/core/rootdir/init.rc 中包含了 zygote.rc:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import /init.${ro.zygote}.rc</span></code></pre></td></tr></table></div></figure>


<p><code>${ro.zygote}</code>是平台相关的参数，实际可对应到 <code>init.zygote32.rc</code>， <code>init.zygote64.rc</code>， <code>init.zygote64_32.rc</code>， <code>init.zygote32_64.rc</code>，前两个只会启动单一<code>app_process(64)</code> 进程，而后两个则会启动两个<code>app_process</code>进程：第二个<code>app_process</code>进程称为 <code>secondary</code>，在后面的代码中可以看到相应 <code>secondary socket</code> 的创建过程。为简化起见，在这里就不考虑这种创建两个<code>app_process</code>进程的情形。</p>

<p>以 <code>/system/core/rootdir/init.zygote32.rc</code> 为例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
</span><span class='line'>class main
</span><span class='line'>socket zygote stream 660 root system
</span><span class='line'>onrestart write /sys/android_power/request_state wake
</span><span class='line'>onrestart write /sys/power/state on
</span><span class='line'>onrestart restart media
</span><span class='line'>onrestart restart netd</span></code></pre></td></tr></table></div></figure>


<p>第一行创建了名为 <code>zygote</code> 的进程，这个进程是通过 <code>app_process</code> 的 <code>main</code> 启动并以<code>-Xzygote /system/bin &ndash;zygote &ndash;start-system-server</code>作为<code>main</code>的入口参数。</p>

<p><code>app_process</code> 对应代码为 <code>framework/base/cmds/app_process/app_main.cpp</code>。在这个文件的 <code>main</code> 函数中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">AppRuntime</span> <span class="nf">runtime</span><span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">computeArgBlockSize</span><span class="o">(</span><span class="n">argc</span><span class="o">,</span> <span class="n">argv</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">zygote</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">runtime</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">&quot;com.android.internal.os.ZygoteInit&quot;</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">className</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">runtime</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">&quot;com.android.internal.os.RuntimeInit&quot;</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>根据入口参数，我们知道 <code>zygote</code> 为<code>true</code>，<code>args</code>参数中包含了<code>&ldquo;start-system-server&rdquo;</code>。</p>

<p><code>AppRuntime</code> 继承自 <code>AndroidRuntime</code>，因此下一步就执行到 <code>AndroidRuntime</code> 的 <code>start</code> 函数。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nl">AndroidRuntime:</span><span class="o">:</span><span class="n">start</span><span class="o">(</span><span class="kd">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">className</span><span class="o">,</span> <span class="kd">const</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String8</span><span class="o">&gt;&amp;</span> <span class="n">options</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="cm">/* start the virtual machine */</span> <span class="c1">// 创建虚拟机</span>
</span><span class='line'>    <span class="n">JniInvocation</span> <span class="n">jni_invocation</span><span class="o">;</span>
</span><span class='line'>    <span class="n">jni_invocation</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">NULL</span><span class="o">);</span>
</span><span class='line'>    <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">startVm</span><span class="o">(&amp;</span><span class="n">mJavaVM</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">env</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">onVmCreated</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="c1">//调用className对应类的静态main()函数</span>
</span><span class='line'>    <span class="kt">char</span><span class="o">*</span> <span class="n">slashClassName</span> <span class="o">=</span> <span class="n">toSlashClassName</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
</span><span class='line'>    <span class="n">jclass</span> <span class="n">startClass</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="o">(</span><span class="n">slashClassName</span><span class="o">);</span>
</span><span class='line'>    <span class="n">jmethodID</span> <span class="n">startMeth</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="o">(</span><span class="n">startClass</span><span class="o">,</span> <span class="s">&quot;main&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="o">(</span><span class="n">startClass</span><span class="o">,</span> <span class="n">startMeth</span><span class="o">,</span> <span class="n">strArray</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>start</code>函数主要做两件事：创建虚拟机和调用传入类名对应类的 <code>main</code> 函数。因此下一步就执行到 <code>com.android.internal.os.ZygoteInit</code> 的 <code>main</code> 函数。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">startSystemServer</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">socketName</span> <span class="o">=</span> <span class="s">&quot;zygote&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argv</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="s">&quot;start-system-server&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">startSystemServer</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="o">...</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">registerZygoteSocket</span><span class="o">(</span><span class="n">socketName</span><span class="o">);</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>        <span class="n">preload</span><span class="o">();</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">startSystemServer</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">startSystemServer</span><span class="o">(</span><span class="n">abiList</span><span class="o">,</span> <span class="n">socketName</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Accepting command socket connections&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">runSelectLoop</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">closeServerSocket</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MethodAndArgsCaller</span> <span class="n">caller</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">caller</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Zygote died with exception&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>        <span class="n">closeServerSocket</span><span class="o">();</span>
</span><span class='line'>        <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>它主要做了三件事情:
1. 调用 <code>registerZygoteSocket</code> 函数创建了一个 <code>socket</code> 接口，用来和 <code>ActivityManagerService</code> 通讯；
2. 调用 <code>startSystemServer</code> 函数来启动 <code>SystemServer</code>;
3. 调用 <code>runSelectLoop</code> 函数进入一个无限循环在前面创建的 <code>socket</code> 接口上等待 <code>ActivityManagerService</code> 请求创建新的应用程序进程。</p>

<p>这里要留意 <code>catch (MethodAndArgsCaller caller)</code> 这一行，<code>android</code> 在这里通过抛出一个异常来处理正常的业务逻辑。</p>

<h3>创建 zygote socket</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ANDROID_SOCKET_PREFIX</span> <span class="o">=</span> <span class="s">&quot;ANDROID_SOCKET_&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerZygoteSocket</span><span class="o">(</span><span class="n">String</span> <span class="n">socketName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">sServerSocket</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">fileDesc</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">String</span> <span class="n">fullSocketName</span> <span class="o">=</span> <span class="n">ANDROID_SOCKET_PREFIX</span> <span class="o">+</span> <span class="n">socketName</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">env</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="n">fullSocketName</span><span class="o">);</span>
</span><span class='line'>            <span class="n">fileDesc</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">fullSocketName</span> <span class="o">+</span> <span class="s">&quot; unset or invalid&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">sServerSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">LocalServerSocket</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">createFileDescriptor</span><span class="o">(</span><span class="n">fileDesc</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
</span><span class='line'>                    <span class="s">&quot;Error binding to local socket &#39;&quot;</span> <span class="o">+</span> <span class="n">fileDesc</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这里根据传入参数<code>&ldquo;zygote&rdquo;</code>拼成名为 <code>fullSocketName</code> 的<code>key</code>，该 <code>key</code> 的值为：<code>ANDROID_SOCKET_zygote</code>，然后查找它对应的环境变量值，解析该值得到文件描述符号，再根据该文件描述符创建 <code>socket</code>。那么这个文件描述符是什么地方创建并写到环境变量里去的呢？还记得前面 <code>init.zygote32.rc</code> 的第二行么？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">socket</span> <span class="n">zygote</span> <span class="n">stream</span> <span class="mi">660</span> <span class="n">root</span> <span class="n">system</span>
</span></code></pre></td></tr></table></div></figure>


<p>系统启动脚本文件 <code>init.rc</code> 是由 <code>init</code> 进程来解释执行的，而 <code>init</code> 进程的源代码位于 <code>system/core/init</code> 目录中，在 <code>init.c</code> 文件中，是由 <code>service_start</code> 函数来解释 <code>init.zygote32.rc</code> 文件中的 <code>service</code> 命令的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">void</span> <span class="nf">service_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">service</span> <span class="o">*</span><span class="n">svc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dynamic_args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">socketinfo</span> <span class="o">*</span><span class="n">si</span><span class="p">;</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">si</span> <span class="o">=</span> <span class="n">svc</span><span class="o">-&gt;</span><span class="n">sockets</span><span class="p">;</span> <span class="n">si</span><span class="p">;</span> <span class="n">si</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">socket_type</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;stream&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nl">SOCK_STREAM</span> <span class="p">:</span>
</span><span class='line'>                        <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;dgram&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nl">SOCK_DGRAM</span> <span class="p">:</span> <span class="n">SOCK_SEQPACKET</span><span class="p">));</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">create_socket</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">socket_type</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">si</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">socketcon</span> <span class="o">?:</span> <span class="n">scon</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">publish_socket</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>每一个 service 命令都会促使 init 进程调用 fork 函数来创建一个新的进程，在新的进程里面，会分析里面的 socket 选项，对于每一个 socket 选项，都会通过 <code>create_socket</code> 函数来在 <code>/dev/socket</code> 目录下创建一个文件，在 zygote 进程中 socket 选项为<code>socket zygote stream 660 root system</code>，因此这个文件便是 zygote了，然后得到的文件描述符通过 <code>publish_socket</code> 函数写入到环境变量中去：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">publish_socket</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="n">ANDROID_SOCKET_ENV_PREFIX</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">val</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">strlcpy</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ANDROID_SOCKET_ENV_PREFIX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>            <span class="n">name</span><span class="p">,</span>
</span><span class='line'>            <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ANDROID_SOCKET_ENV_PREFIX</span><span class="p">));</span>
</span><span class='line'>    <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="n">add_environment</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* make sure we don&#39;t close-on-exec */</span>
</span><span class='line'>    <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里传进来的参数name值为"zygote"，而 <code>ANDROID_SOCKET_ENV_PREFIX</code> 在 <code>system/core/include/cutils/sockets.h</code> 定义为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#define ANDROID_SOCKET_ENV_PREFIX   &quot;ANDROID_SOCKET_&quot;</span>
</span><span class='line'><span class="cp">#define ANDROID_SOCKET_DIR          &quot;/dev/socket&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>因此，这里就把上面得到的文件描述符写入到以 <code>ANDROID_SOCKET_zygote</code> 为 key 值的环境变量中。又因为上面的 <code>ZygoteInit.registerZygoteSocket</code> 函数与这里创建 socket 文件的 create_socket 函数是运行在同一个进程中，因此，上面的 <code>ZygoteInit.registerZygoteSocket</code> 函数可以直接使用这个文件描述符来创建一个 Java 层的 LocalServerSocket 对象。如果其它进程也需要打开这个 <code>/dev/socket/zygote</code> 文件来和 zygote 进程进行通信，那就必须要通过文件名来连接这个 LocalServerSocket了。也就是说创建 zygote socket 之后，ActivityManagerService 就能够通过该 socket 与 zygote 进程通信从而 fork 创建新进程，android 中的所有应用进程都是通过这种方式 fork zygote 进程创建的。在 ActivityManagerService中 的 <code>startProcessLocked</code> 中调用了 <code>Process.start()</code> 方法，进而调用 <code>Process.startViaZygote</code> 和 <code>Process.openZygoteSocketIfNeeded</code>。</p>

<h3>启动 SystemServer</h3>

<p>socket 创建完成之后，紧接着就通过 <code>startSystemServer</code> 函数来启动 <code>SystemServer</code> 进程。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">startSystemServer</span><span class="o">(</span><span class="n">String</span> <span class="n">abiList</span><span class="o">,</span> <span class="n">String</span> <span class="n">socketName</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="n">posixCapabilitiesAsBits</span><span class="o">(</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_BLOCK_SUSPEND</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_KILL</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_NET_ADMIN</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_NET_BIND_SERVICE</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_NET_BROADCAST</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_NET_RAW</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_SYS_MODULE</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_SYS_NICE</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_SYS_RESOURCE</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_SYS_TIME</span><span class="o">,</span>
</span><span class='line'>        <span class="n">OsConstants</span><span class="o">.</span><span class="na">CAP_SYS_TTY_CONFIG</span>
</span><span class='line'>    <span class="o">);</span>
</span><span class='line'>    <span class="cm">/* Hardcoded command line to start the system server */</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">args</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="s">&quot;--setuid=1000&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--setgid=1000&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1032,3001,3002,3003,3006,3007&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--capabilities=&quot;</span> <span class="o">+</span> <span class="n">capabilities</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">capabilities</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--runtime-init&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--nice-name=system_server&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;com.android.server.SystemServer&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'>    <span class="n">ZygoteConnection</span><span class="o">.</span><span class="na">Arguments</span> <span class="n">parsedArgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">parsedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZygoteConnection</span><span class="o">.</span><span class="na">Arguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Request to fork the system server process */</span>
</span><span class='line'>        <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkSystemServer</span><span class="o">(</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span>
</span><span class='line'>                <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">permittedCapabilities</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">effectiveCapabilities</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* For child process */</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">hasSecondZygote</span><span class="o">(</span><span class="n">abiList</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">waitForSecondaryZygote</span><span class="o">(</span><span class="n">socketName</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">handleSystemServerProcess</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里我们可以从参数推测出：创建名为<code>“system_server"</code>的进程，其入口是： <code>com.android.server.SystemServer</code> 的 <code>main</code> 函数。<code>zygote</code> 进程通过 <code>Zygote.forkSystemServer</code> 函数来创建一个新的进程来启动 <code>SystemServer</code> 组件，返回值 <code>pid</code> 等 0 的地方就是新的进程要执行的路径，即新创建的进程会执行 <code>handleSystemServerProcess</code> 函数。<code>hasSecondZygote</code> 是针对 <code>init.zygote64_32.rc</code>， <code>init.zygote32_64.rc</code> 这两者情况的，在这里跳过不谈。接下来来看 <code>handleSystemServerProcess</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Finish remaining work for the newly forked system server process.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handleSystemServerProcess</span><span class="o">(</span>
</span><span class='line'>        <span class="n">ZygoteConnection</span><span class="o">.</span><span class="na">Arguments</span> <span class="n">parsedArgs</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">closeServerSocket</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// set umask to 0077 so new files and directories will default to owner-only permissions.</span>
</span><span class='line'>    <span class="n">Os</span><span class="o">.</span><span class="na">umask</span><span class="o">(</span><span class="n">S_IRWXG</span> <span class="o">|</span> <span class="n">S_IRWXO</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Process</span><span class="o">.</span><span class="na">setArgV0</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">final</span> <span class="n">String</span> <span class="n">systemServerClasspath</span> <span class="o">=</span> <span class="n">Os</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">&quot;SYSTEMSERVERCLASSPATH&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">systemServerClasspath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">cl</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">PathClassLoader</span><span class="o">(</span><span class="n">systemServerClasspath</span><span class="o">,</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Pass the remaining arguments to SystemServer.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">,</span> <span class="n">cl</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* should never reach here */</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>handleSystemServerProcess</code> 会抛出 <code>MethodAndArgsCaller</code> 异常，前面提到这个异常其实是处理正常业务逻辑的，相当于一个回调。由于由 <code>zygote</code> 进程创建的子进程会继承 <code>zygote</code> 进程在前面创建的 <code>socket</code> 文件描述符，而这里的子进程又不会用到它，因此，这里就调用 <code>closeServerSocket</code> 函数来关闭它。<code>SYSTEMSERVERCLASSPATH</code> 是包含 <code>/system/framework/framework.jar</code> 的环境变量，它定义在 <code>system/core/rootdir/init.environ.rc.in</code> 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">on</span> <span class="n">init</span>
</span><span class='line'>    <span class="n">export</span> <span class="n">PATH</span> <span class="o">/</span><span class="nl">sbin:</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="nl">bin:</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="nl">sbin:</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="nl">bin:</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">xbin</span>
</span><span class='line'>    <span class="n">export</span> <span class="n">ANDROID_BOOTLOGO</span> <span class="mi">1</span>
</span><span class='line'>    <span class="n">export</span> <span class="n">ANDROID_ROOT</span> <span class="o">/</span><span class="n">system</span>
</span><span class='line'>    <span class="n">export</span> <span class="n">SYSTEMSERVERCLASSPATH</span> <span class="o">%</span><span class="n">SYSTEMSERVERCLASSPATH</span><span class="o">%</span>
</span><span class='line'>    <span class="n">export</span> <span class="n">LD_PRELOAD</span> <span class="n">libsigchain</span><span class="o">.</span><span class="na">so</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>handleSystemServerProcess</code> 函数接着调用 <code>RuntimeInit.zygoteInit</code> 函数来进一步执行启动 <code>SystemServer</code> 组件的操作。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">zygoteInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">commonInit</span><span class="o">();</span>
</span><span class='line'>    <span class="n">nativeZygoteInit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">applicationInit</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">argv</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>commonInit</code> 设置线程未处理异常 <code>handler</code>，时区等，<code>JNI</code> 方法 <code>nativeZygoteInit</code> 实现在 <code>frameworks/base/core/jni/AndroidRuntime.cpp</code> 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">AndroidRuntime</span><span class="o">*</span> <span class="n">gCurRuntime</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">com_android_internal_os_RuntimeInit_nativeZygoteInit</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">gCurRuntime</span><span class="o">-&gt;</span><span class="n">onZygoteInit</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>AndroidRuntime</code> 是个带虚函数的基类，真正的实现是在 <code>app_main.cpp</code> 中的 <code>AppRuntime</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">AppRuntime</span> <span class="o">:</span> <span class="k">public</span> <span class="n">AndroidRuntime</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">onStarted</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">sp</span><span class="o">&lt;</span><span class="n">ProcessState</span><span class="o">&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">();</span>
</span><span class='line'>        <span class="n">ALOGV</span><span class="p">(</span><span class="s">&quot;App process: starting thread pool.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">proc</span><span class="o">-&gt;</span><span class="n">startThreadPool</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">AndroidRuntime</span><span class="o">*</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">AndroidRuntime</span><span class="o">::</span><span class="n">getRuntime</span><span class="p">();</span>
</span><span class='line'>        <span class="n">ar</span><span class="o">-&gt;</span><span class="n">callMain</span><span class="p">(</span><span class="n">mClassName</span><span class="p">,</span> <span class="n">mClass</span><span class="p">,</span> <span class="n">mArgs</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">stopProcess</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">onZygoteInit</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Re-enable tracing now that we&#39;re no longer in Zygote.</span>
</span><span class='line'>        <span class="n">atrace_set_tracing_enabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sp</span><span class="o">&lt;</span><span class="n">ProcessState</span><span class="o">&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">();</span>
</span><span class='line'>        <span class="n">ALOGV</span><span class="p">(</span><span class="s">&quot;App process: starting thread pool.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">proc</span><span class="o">-&gt;</span><span class="n">startThreadPool</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">onExit</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">mClassName</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// if zygote</span>
</span><span class='line'>            <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">stopProcess</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">AndroidRuntime</span><span class="o">::</span><span class="n">onExit</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过执行 <code>AppRuntime::onZygoteInit</code> 函数，这个进程的 <code>Binder</code> 进程间通信机制基础设施就准备好了，参考代码 <code>frameworks/native/libs/binder/ProcessState.cpp</code>。</p>

<p>接下来，看 applicationInit ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">final</span> <span class="n">Arguments</span> <span class="n">args</span><span class="o">;</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>        <span class="c1">// let the process exit</span>
</span><span class='line'>        <span class="k">return</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Remaining arguments are passed to the start class&#39;s static main</span>
</span><span class='line'>    <span class="n">invokeStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>applicationInit</code> 仅仅是转调 <code>invokeStaticMain</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeStaticMain</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">Class</span> <span class="n">cl</span><span class="o">;</span>
</span><span class='line'>    <span class="n">cl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Method</span> <span class="n">m</span><span class="o">;</span>
</span><span class='line'>    <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * This throw gets caught in ZygoteInit.main(), which responds</span>
</span><span class='line'><span class="cm">     * by invoking the exception&#39;s run() method. This arrangement</span>
</span><span class='line'><span class="cm">     * clears up all the stack frames that were required in setting</span>
</span><span class='line'><span class="cm">     * up the process.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>invokeStaticMain</code> 也很简单，通过反射找到参数 <code>className</code> 对应的类的静态 <code>main</code> 方法，然后将该方法与参数生成 <code>ZygoteInit.MethodAndArgsCaller</code> 对象当做异常抛出，这个异常对象在 <code>ZygoteInit</code> 的 <code>main</code> 函数被捕获并执行该对象的 <code>run</code> 方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Helper exception class which holds a method and arguments and</span>
</span><span class='line'><span class="cm"> * can call them. This is used as part of a trampoline to get rid of</span>
</span><span class='line'><span class="cm"> * the initial process setup stack frames.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodAndArgsCaller</span> <span class="kd">extends</span> <span class="n">Exception</span>
</span><span class='line'>        <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>        <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">mArgs</span> <span class="o">});</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这么复杂的跳转，其实就做了一件简单的事情：根据 <code>className </code>反射调用该类的静态 <code>main</code> 方法。这个类名是 <code>ZygoteInit.startSystemServer</code> 方法中写死的 <code>com.android.server.SystemServer</code>。 从而进入 <code>SystemServer</code> 类的 <code>main()</code>方法。</p>

<h3>执行 ZygoteInit.runSelectLoop</h3>

<p>在 <code>startSystemServer</code> 函数中，创建 <code>system_server</code> 进程之后，<code>pid</code> 等于 0 时在该新进程中执行 <code>SystemServer.main</code>，否则回到 <code>zygote</code> 进程进行执行 <code>ZygoteInit.runSelectLoop</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runSelectLoop</span><span class="o">(</span><span class="n">String</span> <span class="n">abiList</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">FileDescriptor</span><span class="o">&gt;</span> <span class="n">fds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">FileDescriptor</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ZygoteConnection</span><span class="o">&gt;</span> <span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ZygoteConnection</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">FileDescriptor</span><span class="o">[]</span> <span class="n">fdArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileDescriptor</span><span class="o">[</span><span class="mi">4</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sServerSocket</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">());</span>
</span><span class='line'>    <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">loopCount</span> <span class="o">=</span> <span class="n">GC_LOOP_COUNT</span><span class="o">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Call gc() before we block in select().</span>
</span><span class='line'><span class="cm">         * It&#39;s work that has to be done anyway, and it&#39;s better</span>
</span><span class='line'><span class="cm">         * to avoid making every child do it.  It will also</span>
</span><span class='line'><span class="cm">         * madvise() any free memory as a side-effect.</span>
</span><span class='line'><span class="cm">         *</span>
</span><span class='line'><span class="cm">         * Don&#39;t call it every time, because walking the entire</span>
</span><span class='line'><span class="cm">         * heap is a lot of overhead to free a few hundred bytes.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">loopCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">gc</span><span class="o">();</span>
</span><span class='line'>            <span class="n">loopCount</span> <span class="o">=</span> <span class="n">GC_LOOP_COUNT</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">loopCount</span><span class="o">--;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">fdArray</span> <span class="o">=</span> <span class="n">fds</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">fdArray</span><span class="o">);</span>
</span><span class='line'>            <span class="n">index</span> <span class="o">=</span> <span class="n">selectReadable</span><span class="o">(</span><span class="n">fdArray</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Error in select()&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Error in select()&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ZygoteConnection</span> <span class="n">newPeer</span> <span class="o">=</span> <span class="n">acceptCommandPeer</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
</span><span class='line'>            <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">);</span>
</span><span class='line'>            <span class="n">fds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">boolean</span> <span class="n">done</span><span class="o">;</span>
</span><span class='line'>            <span class="n">done</span> <span class="o">=</span> <span class="n">peers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">runOnce</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">peers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span><span class='line'>                <span class="n">fds</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runSelectLoop</code> 函数的逻辑比较简单，主要有两点：
1、 处理客户端的连接和请求。前面创建的 <code>LocalServerSocket</code> 对象保存 <code>sServerSocket</code>，这个 <code>socket</code> 通过 <code>selectReadable</code> 等待 <code>ActivityManagerService</code>(简写 <code>AMS</code>) 与之通信。<code>selectReadable</code>是一个<code>native</code>函数，内部调用<code>select</code>等待 <code>AMS</code> 连接，<code>AMS</code> 连接上之后就会返回: 返回值 &lt; 0：内部发生错误；返回值 = 0：第一次连接到服务端 ；返回值 > 0：与服务端已经建立连接，并开始发送数据。每一个链接在 <code>zygote</code> 进程中使用 <code>ZygoteConnection</code> 对象表示。</p>

<p>2、 客户端的请求由 <code>ZygoteConnection.runOnce</code> 来处理，这个方法也抛出 <code>MethodAndArgsCaller</code> 异常，从而进入 <code>MethodAndArgsCaller.run</code> 中调用根据客户请求数据反射出的类的 <code>main</code> 方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">readArgumentList</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">argc</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mSocketReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// EOF reached.</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">argc</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;invalid Zygote wire format: non-int at argc&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;invalid wire format&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">String</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">argc</span><span class="o">];</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">mSocketReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// We got an unexpected EOF.</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;truncated request&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">boolean</span> <span class="nf">runOnce</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">args</span><span class="o">[];</span>
</span><span class='line'>    <span class="n">Arguments</span> <span class="n">parsedArgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="n">args</span> <span class="o">=</span> <span class="n">readArgumentList</span><span class="o">();</span>
</span><span class='line'>    <span class="n">parsedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Arguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
</span><span class='line'>            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mountExternal</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">seInfo</span><span class="o">,</span>
</span><span class='line'>            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">instructionSet</span><span class="o">,</span>
</span><span class='line'>            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">appDataDir</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>SystemServer 启动过程</h2>

<p>在前面启动 SystemServer一节讲到，通过反射调用类 <code>com.android.server.SystemServer</code> main() 函数，从而开始执行 SystemServer 的初始化流程。</p>

<p>SystemServer.main()</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * The main entry point from zygote.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">SystemServer</span><span class="o">().</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>main 函数创建一个 SystemServer 对象，调用其 run() 方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// If a device&#39;s clock is before 1970 (before 0), a lot of</span>
</span><span class='line'>    <span class="c1">// APIs crash dealing with negative numbers, notably</span>
</span><span class='line'>    <span class="c1">// java.io.File#setLastModified, so instead we fake it and</span>
</span><span class='line'>    <span class="c1">// hope that time from cell towers or NTP fixes it shortly.</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">EARLIEST_SUPPORTED_TIME</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;System clock is before 1970; setting to 1970.&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">SystemClock</span><span class="o">.</span><span class="na">setCurrentTimeMillis</span><span class="o">(</span><span class="n">EARLIEST_SUPPORTED_TIME</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="c1">// 检测时间设置</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Here we go!</span>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Entered the Android system server!&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">BOOT_PROGRESS_SYSTEM_RUN</span><span class="o">,</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// In case the runtime switched since last boot (such as when</span>
</span><span class='line'>    <span class="c1">// the old runtime was removed in an OTA), set the system</span>
</span><span class='line'>    <span class="c1">// property so that it is in sync. We can&#39;t do this in</span>
</span><span class='line'>    <span class="c1">// libnativehelper&#39;s JniInvocation::Init code where we already</span>
</span><span class='line'>    <span class="c1">// had to fallback to a different runtime because it is</span>
</span><span class='line'>    <span class="c1">// running as root and we need to be the system user to set</span>
</span><span class='line'>    <span class="c1">// the property. http://b/11463182</span>
</span><span class='line'>    <span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;persist.sys.dalvik.vm.lib.2&quot;</span><span class="o">,</span> <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">vmLibrary</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Enable the sampling profiler.</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">SamplingProfilerIntegration</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">SamplingProfilerIntegration</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mProfilerSnapshotTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Timer</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mProfilerSnapshotTimer</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="nf">TimerTask</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="nd">@Override</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">SamplingProfilerIntegration</span><span class="o">.</span><span class="na">writeSnapshot</span><span class="o">(</span><span class="s">&quot;system_server&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">},</span> <span class="n">SNAPSHOT_INTERVAL</span><span class="o">,</span> <span class="n">SNAPSHOT_INTERVAL</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="c1">// 启动性能分析采样</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Mmmmmm... more memory!</span>
</span><span class='line'>    <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">clearGrowthLimit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The system server has to run all of the time, so it needs to be</span>
</span><span class='line'>    <span class="c1">// as efficient as possible with its memory usage.</span>
</span><span class='line'>    <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetHeapUtilization</span><span class="o">(</span><span class="mf">0.8f</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Some devices rely on runtime fingerprint generation, so make sure</span>
</span><span class='line'>    <span class="c1">// we&#39;ve defined it before booting further.</span>
</span><span class='line'>    <span class="n">Build</span><span class="o">.</span><span class="na">ensureFingerprintProperty</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Within the system server, it is an error to access Environment paths without</span>
</span><span class='line'>    <span class="c1">// explicitly specifying a user.</span>
</span><span class='line'>    <span class="n">Environment</span><span class="o">.</span><span class="na">setUserRequired</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Ensure binder calls into the system always run at foreground priority.</span>
</span><span class='line'>    <span class="n">BinderInternal</span><span class="o">.</span><span class="na">disableBackgroundScheduling</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Prepare the main looper thread (this thread).</span>
</span><span class='line'>    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span>
</span><span class='line'>            <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_FOREGROUND</span><span class="o">);</span>
</span><span class='line'>    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setCanSelfBackground</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Looper</span><span class="o">.</span><span class="na">prepareMainLooper</span><span class="o">();</span> <span class="c1">// 准备主线程循环</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Initialize native services.</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&quot;android_servers&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">nativeInit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Check whether we failed to shut down last time we tried.</span>
</span><span class='line'>    <span class="c1">// This call may not return.</span>
</span><span class='line'>    <span class="n">performPendingShutdown</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Initialize the system context.</span>
</span><span class='line'>    <span class="n">createSystemContext</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Create the system service manager.</span>
</span><span class='line'>    <span class="n">mSystemServiceManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SystemServiceManager</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">);</span>
</span><span class='line'>    <span class="n">LocalServices</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">SystemServiceManager</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">mSystemServiceManager</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Start services.  // 启动服务</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">startBootstrapServices</span><span class="o">();</span>
</span><span class='line'>        <span class="n">startCoreServices</span><span class="o">();</span>
</span><span class='line'>        <span class="n">startOtherServices</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;System&quot;</span><span class="o">,</span> <span class="s">&quot;******************************************&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;System&quot;</span><span class="o">,</span> <span class="s">&quot;************ Failure starting system services&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>        <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// For debug builds, log event loop stalls to dropbox for analysis.</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">StrictMode</span><span class="o">.</span><span class="na">conditionallyEnableDebugLogging</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Enabled StrictMode for system server main thread.&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Loop forever.</span>
</span><span class='line'>    <span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>  <span class="c1">// 启动线程循环，等待消息处理</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Main thread loop unexpectedly exited&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这个 run 方法中，主要完成三件事情，创建 system context 和 system service manager，启动一些系统服务，进入主线程消息循环。</p>

<h2>Zygote 的 fork 本地方法分析</h2>

<p>接下来我们仔细分析 <code>Zygote.forkSystemServer</code> 与 <code>Zygote.forkAndSpecialize</code> 两个方法。</p>

<h3>forkSystemServer</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ZygoteHooks</span> <span class="n">VM_HOOKS</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ZygoteHooks</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkSystemServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">long</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="kt">long</span> <span class="n">effectiveCapabilities</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">preFork</span><span class="o">();</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkSystemServer</span><span class="o">(</span>
</span><span class='line'>            <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="n">effectiveCapabilities</span><span class="o">);</span>
</span><span class='line'>    <span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">postForkCommon</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在调用 <code>nativeForkSystemServer</code> 创建 <code>system_server</code> 进程之前与之后，都会调用 ZygoteHooks 进行一些前置与后置处理。</p>

<h4>ZygoteHooks.preFork</h4>

<p>前置处理 <code>ZygoteHooks.preFork</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">preFork</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Daemons</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'>    <span class="n">waitUntilAllThreadsStopped</span><span class="o">();</span>
</span><span class='line'>    <span class="n">token</span> <span class="o">=</span> <span class="n">nativePreFork</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Daemons.stop()</code>; 停止虚拟机中一些守护线程操作：如引用队列、终接器、GC等</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ReferenceQueueDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'>    <span class="n">FinalizerDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'>    <span class="n">FinalizerWatchdogDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'>    <span class="n">HeapTrimmerDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'>    <span class="n">GCDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>waitUntilAllThreadsStopped</code> 保证被 <code>fork</code> 的进程是单线程，这样可以确保通过 <code>copyonwrite fork</code> 出来的进程也是单线程，从而节省资源。与前面提到的在新建 <code>system_server</code> 进程中调用 <code>closeServerSocket</code> 关闭 <code>sockect</code> 有异曲同工之妙。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * We must not fork until we&#39;re single-threaded again. Wait until /proc shows we&#39;re</span>
</span><span class='line'><span class="cm"> * down to just one thread.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">waitUntilAllThreadsStopped</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">File</span> <span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">&quot;/proc/self/task&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="n">tasks</span><span class="o">.</span><span class="na">list</span><span class="o">().</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Experimentally, booting and playing about with a stingray, I never saw us</span>
</span><span class='line'>            <span class="c1">// go round this loop more than once with a 10ms sleep.</span>
</span><span class='line'>            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>本地方法 <code>nativePreFork</code> 实现在 <code>art/runtime/native/dalvik_system_ZygoteHooks.cc</code> 中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">jlong</span> <span class="nf">ZygoteHooks_nativePreFork</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">Runtime</span><span class="o">*</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">();</span>
</span><span class='line'>  <span class="n">CHECK</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">IsZygote</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;runtime instance not started with -Xzygote&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">PreZygoteFork</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Grab thread before fork potentially makes Thread::pthread_key_self_ unusable.</span>
</span><span class='line'>  <span class="n">Thread</span><span class="o">*</span> <span class="n">self</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">::</span><span class="n">Current</span><span class="p">();</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ZygoteHooks_nativePreFork</code> 通过调用 <code>Runtime::PreZygoteFork</code> 来完成 <code>gc</code> 堆的一些初始化，这部分代码在 <code>art/runtime/runtime.cc</code> 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">heap_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">gc</span><span class="o">::</span><span class="n">Heap</span><span class="p">(...);</span>
</span><span class='line'><span class="kt">void</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">PreZygoteFork</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">heap_</span><span class="o">-&gt;</span><span class="n">PreZygoteFork</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>创建 system_server 进程：</h4>

<p><code>nativeForkSystemServer</code> 实现在 <code>framework/base/core/jni/com_android_internal_os_Zygote.cpp</code> 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">jint</span> <span class="nf">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="p">(</span>
</span><span class='line'>        <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">gids</span><span class="p">,</span>
</span><span class='line'>        <span class="n">jint</span> <span class="n">debug_flags</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">rlimits</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">permittedCapabilities</span><span class="p">,</span>
</span><span class='line'>        <span class="n">jlong</span> <span class="n">effectiveCapabilities</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">ForkAndSpecializeCommon</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gids</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">debug_flags</span><span class="p">,</span> <span class="n">rlimits</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">permittedCapabilities</span><span class="p">,</span> <span class="n">effectiveCapabilities</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">MOUNT_EXTERNAL_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
</span><span class='line'>                    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// The zygote process checks whether the child process has died or not.</span>
</span><span class='line'>        <span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;System server process %d has been created&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gSystemServerPid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// There is a slight window that the system server process has crashed</span>
</span><span class='line'>        <span class="c1">// but it went unnoticed because we haven&#39;t published its pid yet. So</span>
</span><span class='line'>        <span class="c1">// we recheck here just to make sure that all is well.</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">)</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;System server process %d has died. Restarting Zygote!&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'>            <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>它转调 <code>ForkAndSpecializeCommon</code> 来创建新进程，并确保 <code>system_server</code> 创建成功，若不成功便成仁：重启 <code>zygote</code>，因为没有 <code>system_server</code> 就干不了什么事情。<code>ForkAndSpecializeCommon</code> 实现如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kZygoteClassName</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;com/android/internal/os/Zygote&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">gZygoteClass</span> <span class="o">=</span> <span class="p">(</span><span class="n">jclass</span><span class="p">)</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewGlobalRef</span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">kZygoteClassName</span><span class="p">));</span>
</span><span class='line'><span class="n">gCallPostForkChildHooks</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">(</span><span class="n">gZygoteClass</span><span class="p">,</span> <span class="s">&quot;callPostForkChildHooks&quot;</span><span class="p">,</span>
</span><span class='line'>                                       <span class="s">&quot;(ILjava/lang/String;)V&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Utility routine to fork zygote and specialize the child process.</span>
</span><span class='line'><span class="k">static</span> <span class="kt">pid_t</span> <span class="nf">ForkAndSpecializeCommon</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">javaGids</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">jint</span> <span class="n">debug_flags</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">javaRlimits</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">jlong</span> <span class="n">permittedCapabilities</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">effectiveCapabilities</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">jint</span> <span class="n">mount_external</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">jstring</span> <span class="n">java_se_info</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">java_se_name</span><span class="p">,</span>
</span><span class='line'>                 <span class="kt">bool</span> <span class="n">is_system_server</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">fdsToClose</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">jstring</span> <span class="n">instructionSet</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">dataDir</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">SetSigChldHandler</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// The child process.</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">rc</span> <span class="o">=</span> <span class="n">selinux_android_setcontext</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">is_system_server</span><span class="p">,</span> <span class="n">se_info_c_str</span><span class="p">,</span> <span class="n">se_name_c_str</span><span class="p">);</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">UnsetSigChldHandler</span><span class="p">();</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">gZygoteClass</span><span class="p">,</span> <span class="n">gCallPostForkChildHooks</span><span class="p">,</span> <span class="n">debug_flags</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">is_system_server</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">instructionSet</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// the parent process</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ForkAndSpecializeCommon</code> 首先设置子进程异常处理<code>handler</code>，然后 </ode>fork</code> 新进程，在新进程中设置 <code>SELinux</code>，并清除它的子进程异常处理 <code>handler</code>，然后调用 <code>Zygote.callPostForkChildHooks</code> 方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">callPostForkChildHooks</span><span class="o">(</span><span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span><span class='line'>    <span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">postForkChild</span><span class="o">(</span><span class="n">debugFlags</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">);</span>
</span><span class='line'>    <span class="n">checkTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&quot;Zygote.callPostForkChildHooks&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>callPostForkChildHooks</code> 又转调 <code>ZygoteHooks.postForkChild</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">postForkChild</span><span class="o">(</span><span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">nativePostForkChild</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>本地方法 <code>nativePostForkChild</code> 又进到 <code>dalvik_system_ZygoteHooks.cc</code> 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">ZygoteHooks_nativePostForkChild</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">token</span><span class="p">,</span> <span class="n">jint</span> <span class="n">debug_flags</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">jstring</span> <span class="n">instruction_set</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// Our system thread ID, etc, has changed so reset Thread state.</span>
</span><span class='line'>    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">InitAfterFork</span><span class="p">();</span>
</span><span class='line'>    <span class="n">EnableDebugFeatures</span><span class="p">(</span><span class="n">debug_flags</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">instruction_set</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ScopedUtfChars</span> <span class="n">isa_string</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">instruction_set</span><span class="p">);</span>
</span><span class='line'>        <span class="n">InstructionSet</span> <span class="n">isa</span> <span class="o">=</span> <span class="n">GetInstructionSetFromString</span><span class="p">(</span><span class="n">isa_string</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span><span class='line'>        <span class="n">Runtime</span><span class="o">::</span><span class="n">NativeBridgeAction</span> <span class="n">action</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">NativeBridgeAction</span><span class="o">::</span><span class="n">kUnload</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">isa</span> <span class="o">!=</span> <span class="n">kNone</span> <span class="o">&amp;&amp;</span> <span class="n">isa</span> <span class="o">!=</span> <span class="n">kRuntimeISA</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">action</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">NativeBridgeAction</span><span class="o">::</span><span class="n">kInitialize</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DidForkFromZygote</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">isa_string</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DidForkFromZygote</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">NativeBridgeAction</span><span class="o">::</span><span class="n">kUnload</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>thread->InitAfterFork()</code>; 实现在 <code>art/runtime/thread.cc</code> 中，设置新进程主线程的线程<code>id</code>： <code>tid</code>。<code>DidForkFromZygote</code> 实现在 <code>Runtime.cc</code> 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">void</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">DidForkFromZygote</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">NativeBridgeAction</span> <span class="n">action</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">isa</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">is_zygote_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">NativeBridgeAction</span><span class="o">::</span><span class="nl">kUnload</span><span class="p">:</span>
</span><span class='line'>        <span class="n">UnloadNativeBridge</span><span class="p">();</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">NativeBridgeAction</span><span class="o">::</span><span class="nl">kInitialize</span><span class="p">:</span>
</span><span class='line'>        <span class="n">InitializeNativeBridge</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">isa</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Create the thread pool.</span>
</span><span class='line'>    <span class="n">heap_</span><span class="o">-&gt;</span><span class="n">CreateThreadPool</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StartSignalCatcher</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Start the JDWP thread. If the command-line debugger flags specified &quot;suspend=y&quot;,</span>
</span><span class='line'>    <span class="c1">// this will pause the runtime, so we probably want this to come last.</span>
</span><span class='line'>    <span class="n">Dbg</span><span class="o">::</span><span class="n">StartJdwp</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先根据 <code>action</code> 参数来卸载或转载用于跨平台桥接用的库。然后启动 <code>gc</code> 堆的线程池。<code>StartSignalCatcher</code> 设置信号处理 <code>handler</code>，其代码在 <code>signal_catcher.cc</code> 中。</p>

<h4>ZygoteHooks.postForkCommon</h4>

<p>后置处理 <code>ZygoteHooks.postForkCommon</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">postForkCommon</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Daemons</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>postForkCommon</code> 转调 <code>Daemons.start</code>，以初始化虚拟机中引用队列、终接器以及 <code>gc</code> 的守护线程。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ReferenceQueueDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="n">FinalizerDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="n">FinalizerWatchdogDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="n">HeapTrimmerDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="n">GCDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>forkAndSpecialize</h3>

<p><code>Zygote.forkAndSpecialize</code> 方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkAndSpecialize</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
</span><span class='line'>      <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">fdsToClose</span><span class="o">,</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">String</span> <span class="n">appDataDir</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span><span class='line'>    <span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">preFork</span><span class="o">();</span>
</span><span class='line'>    <span class="n">checkTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&quot;Zygote.preFork&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkAndSpecialize</span><span class="o">(</span>
</span><span class='line'>              <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">niceName</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span>
</span><span class='line'>              <span class="n">instructionSet</span><span class="o">,</span> <span class="n">appDataDir</span><span class="o">);</span>
</span><span class='line'>    <span class="n">checkTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&quot;Zygote.nativeForkAndSpecialize&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">postForkCommon</span><span class="o">();</span>
</span><span class='line'>    <span class="n">checkTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&quot;Zygote.postForkCommon&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>前置处理与后置处理与 <code>forkSystemServer</code> 中一样的，这里就跳过不讲了。本地方法 <code>nativeForkAndSpecialize</code> 实现在 <code>framework/base/core/jni/com_android_internal_os_Zygote.cpp</code> 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">jint</span> <span class="nf">com_android_internal_os_Zygote_nativeForkAndSpecialize</span><span class="p">(</span>
</span><span class='line'>        <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">jint</span> <span class="n">uid</span><span class="p">,</span> <span class="n">jint</span> <span class="n">gid</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">gids</span><span class="p">,</span>
</span><span class='line'>        <span class="n">jint</span> <span class="n">debug_flags</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">rlimits</span><span class="p">,</span>
</span><span class='line'>        <span class="n">jint</span> <span class="n">mount_external</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">se_info</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">se_name</span><span class="p">,</span>
</span><span class='line'>        <span class="n">jintArray</span> <span class="n">fdsToClose</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">instructionSet</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">appDataDir</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Grant CAP_WAKE_ALARM to the Bluetooth process.</span>
</span><span class='line'>    <span class="n">jlong</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">uid</span> <span class="o">==</span> <span class="n">AID_BLUETOOTH</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">capabilities</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="n">CAP_WAKE_ALARM</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">ForkAndSpecializeCommon</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gids</span><span class="p">,</span> <span class="n">debug_flags</span><span class="p">,</span>
</span><span class='line'>            <span class="n">rlimits</span><span class="p">,</span> <span class="n">capabilities</span><span class="p">,</span> <span class="n">capabilities</span><span class="p">,</span> <span class="n">mount_external</span><span class="p">,</span> <span class="n">se_info</span><span class="p">,</span>
</span><span class='line'>            <span class="n">se_name</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">fdsToClose</span><span class="p">,</span> <span class="n">instructionSet</span><span class="p">,</span> <span class="n">appDataDir</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个函数与 <code>com_android_internal_os_Zygote_nativeForkSystemServer</code> 非常类似，只不过少了一个确保子进程创建成功的步骤。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/31/book-genome/">读书笔记: 基因组-人种自传23章</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-31T21:51:38+08:00'><span class='date'>2016-01-31</span> <span class='time'>9:51 pm</span></time>
        
           | <a href="/blog/2016/01/31/book-genome/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2016/01/31/book-genome/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>简评</h2>

<p>这是一本比较全面、新颖、引人深思的书籍。相比<a href="http://book.douban.com/subject/11445548/">《自私的基因》</a>那种宏大概括的叙事方式，更注重个别基因这个微观层面的故事。全书选取与我们密切相关的一些基因探讨了：生命、物种、疾病、环境、智力、死亡、性别、压力、个性、死亡、基因疗法、政治、自由意志等科学的，哲学的，社会的，政治的，伦理的问题。</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2016/01/31/book-genome/">阅读全文 &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/01/reading/">2015年阅读统计</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-01T05:42:38+08:00'><span class='date'>2016-01-01</span> <span class='time'>5:42 am</span></time>
        
           | <a href="/blog/2016/01/01/reading/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2016/01/01/reading/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2015年阅读统计，本页面由代码自动生成</h2>

<h2>总计阅读 46 本</h2>

<h3>评价统计:</h3>

<p><img src="https://i.imgur.com/dSfkq35.png" alt="评价统计" /></p>

<blockquote><p>五星图书 18 本，占比 39.1%<br/>
四星图书 17 本，占比 37.0%<br/>
三星图书 7 本，占比 15.2%<br/>
两星图书 4 本，占比 8.7%</p></blockquote>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2016/01/01/reading/">阅读全文 &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/01/books-annual-review/">2015私人阅读十五佳</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-01T05:42:38+08:00'><span class='date'>2016-01-01</span> <span class='time'>5:42 am</span></time>
        
           | <a href="/blog/2016/01/01/books-annual-review/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2016/01/01/books-annual-review/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>统计</h2>

<p>2015年一共读完46本，其中五星18本，占比40%；四星17本，占比近40%；三星7本；两星4本。阅读主题以社科、历史、商业为主，人到中年已经消遣不起小说了。</p>

<p>阅读DNA在年底停掉了，可惜。幸好还有<strong>readingtaste</strong>可以用，2015 完整的阅读统计数据见如下链接：
<a href="http://readingtaste.com/user/1297475/stat/books">readingtaste 阅读统计</a></p>

<h2>私人阅读十五佳</h2>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2016/01/01/books-annual-review/">阅读全文 &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/02/study-android-fw/">Android框架学习资料</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-02T19:00:34+08:00'><span class='date'>2015-04-02</span> <span class='time'>7:00 pm</span></time>
        
           | <a href="/blog/2015/04/02/study-android-fw/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2015/04/02/study-android-fw/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前言</h2>

<p>这两年在做一个与 Android 类似的系统（参考：<a href="http://blog.csdn.net/kesalin/article/details/10474007">招聘：有兴趣做一个与Android对等的操作系统么？</a>），因此有机会对 Android framework 进行系统地学习与研究。期间也阅读了一些不错的书籍与资料，特此分享在这里，或许对其他有兴趣研究 Android framework 的朋友有所帮助。</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2015/04/02/study-android-fw/">阅读全文 &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/26/miss-of-the-dictatos-handbook/">中文版《独裁者手册》之和谐手册</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-26T10:00:34+08:00'><span class='date'>2015-03-26</span> <span class='time'>10:00 am</span></time>
        
           | <a href="/blog/2015/03/26/miss-of-the-dictatos-handbook/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2015/03/26/miss-of-the-dictatos-handbook/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前言</h2>

<p><img src="https://img5.doubanio.com/lpic/s27293486.jpg" alt="《独裁者手册》" /></p>

<p><a href="http://book.douban.com/subject/25881102/">《独裁者手册》</a></p>

<p>《独裁者手册》是一部解析权力&ndash;尤其是政治权力&ndash;运作机制的大作，这套机制适用于民主政府，也适用于独裁政府，还适用于一切有权力的场所，如公司、组织等等。总的来说，就是从如何获取权力，如何维持权力的角度来分析现有的政治制度、公司制度。</p>

<p>中文版由江苏文艺出版社出版，这样一本书能在中国出版实属不易，自然翻译过程中译者必须做一些和谐的功夫。坦白地说，这本书译文流畅，观点忠于原著，只有部分和中国相关的“敏感”论据被删除，其余都保留完整，实属佳品。鉴于很多人怀疑心重，我也有心一睹原著风貌，因此搜寻原文，将我找到的中英差异列在这里，让大家对这本删节书的质量心里有个谱。</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2015/03/26/miss-of-the-dictatos-handbook/">阅读全文 &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/06/my-father/">我的父亲</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-06T20:23:34+08:00'><span class='date'>2015-03-06</span> <span class='time'>8:23 pm</span></time>
        
           | <a href="/blog/2015/03/06/my-father/#disqus_thread"
             data-disqus-identifier="http://luozhaohui.github.io/blog/2015/03/06/my-father/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前言</h2>

<p>我的父亲今年已七十五了，每次回家都能明显感受到无情岁月在父亲身上留下的印迹。这时时刻刻在提醒着我，相处的时间的不会太多了，尤其是对于常年飘在外面的我来说。虽说在我离开家乡之前与父亲相处了十八个春秋，可我对于父亲的生平却了解的很少，非常的支离破碎。大约以前在一起的时候总觉得明天还会见到的，加上年少总是索取以满足自己的需要而不懂得去了解父辈的需要，因此不曾打听与了解过父亲的过去。这次借过年回家相处的一个夜晚，和父亲聊了聊他的过去，记在这里，以作一个平凡农民半个多世纪的回忆。</p>

<p><img src="http://i.imgur.com/H4OCoEZ.jpg" alt="我的父亲罗有胜" /></p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2015/03/06/my-father/">阅读全文 &rarr;</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">所有文章</a>
    
      <a class="next" href="/posts/2">旧贴子 &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>文章分类</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/shu-ping-ying-ping/'>书评影评 (38)</a></li>
<li class='category'><a href='/blog/categories/gong-ju-ruan-jian/'>工具软件 (2)</a></li>
<li class='category'><a href='/blog/categories/xin-zhi-si-wei/'>心智思维 (4)</a></li>
<li class='category'><a href='/blog/categories/sui-sui-nian/'>碎碎念 (24)</a></li>
<li class='category'><a href='/blog/categories/she-hui-za-tan/'>社会杂谈 (9)</a></li>
<li class='category'><a href='/blog/categories/du-shu-bi-ji/'>读书笔记 (2)</a></li>
<li class='category'><a href='/blog/categories/ruan-jian-kai-fa/'>软件开发 (9)</a></li>
<li class='category'><a href='/blog/categories/bian-zou-bian-kan/'>边走边看 (2)</a></li>

  </ul>
</section><section>
  <h1>最新文章</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/08/07/the-strunggle-for-law/">法律的斗争（萨孟武节录意译本）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/15/cpp-scheme/">C++ 11模板元编程实现Scheme中的list及相关函数式编程接口</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/01/01/reading/">2016年阅读统计</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/25/android-zygote-server/">Android5 Zygote 与 SystemServer 启动流程分析</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/31/book-genome/">读书笔记: 基因组-人种自传23章</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>标签云</h1>
  <ul class="tag-cloud">
    <a style="font-size: 110%" href="/tags/shu-ping/">书评</a>
<a style="font-size: 108%" href="/tags/sui-sui-nian/">碎碎念</a>
<a style="font-size: 106%" href="/tags/ying-ping/">影评</a>
<a style="font-size: 103%" href="/tags/si-wei/">思维</a>
<a style="font-size: 101%" href="/tags/za-tan/">杂谈</a>
<a style="font-size: 101%" href="/tags/android/">android</a>
<a style="font-size: 100%" href="/tags/xin-qing/">心情</a>
<a style="font-size: 100%" href="/tags/thread/">thread</a>
<a style="font-size: 98%" href="/tags/hui-yi/">回忆</a>
<a style="font-size: 97%" href="/tags/gong-ju/">工具</a>
<a style="font-size: 97%" href="/tags/zheng-zhi/">政治</a>
<a style="font-size: 97%" href="/tags/ri-ben/">日本</a>
<a style="font-size: 97%" href="/tags/li-shi/">历史</a>
<a style="font-size: 94%" href="/tags/lu-you/">旅游</a>
<a style="font-size: 94%" href="/tags/bi-ji/">笔记</a>
<a style="font-size: 94%" href="/tags/fang-fa-lun/">方法论</a>
<a style="font-size: 90%" href="/tags/jiao-yu/">教育</a>
<a style="font-size: 90%" href="/tags/duan-lian/">锻炼</a>
<a style="font-size: 90%" href="/tags/xin-li-xue/">心理学</a>
<a style="font-size: 90%" href="/tags/xi-guan/">习惯</a>

  </ul>
</section>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - 飘飘白云 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>

<!-- 友盟站点统计：http://www.umeng.com/ -->
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1261636993'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1261636993%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

</p>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'https-luozhaohui-github-io';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
