<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[标签：android | 飘飘白云]]></title>
  <link href="http://luozhaohui.github.io/tags/android/atom.xml" rel="self"/>
  <link href="http://luozhaohui.github.io/"/>
  <updated>2018-01-01T13:24:16+08:00</updated>
  <id>http://luozhaohui.github.io/</id>
  <author>
    <name><![CDATA[飘飘白云]]></name>
    <email><![CDATA[kesalin@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Android5 Zygote 与 SystemServer 启动流程分析]]></title>
    <link href="http://luozhaohui.github.io/blog/2016/02/25/android-zygote-server/"/>
    <updated>2016-02-25T22:13:20+08:00</updated>
    <id>http://luozhaohui.github.io/blog/2016/02/25/android-zygote-server</id>
    <content type="html"><![CDATA[<h2>前言</h2>

<p><code>Android5.0.1</code> 的启动流程与之前的版本相比变化并不大，OK，变化虽然还是有：<code>SystemServer</code> 启动过程的 <code>init1()</code>, <code>init2()</code>没有了，但主干流程依然不变：<code>Linux</code> 内核加载完毕之后，首先启动 <code>init</code> 进程，然后解析 <code>init.rc</code>，并根据其内容由 <code>init</code> 进程装载 <code>Android</code> 文件系统、创建系统目录、初始化属性系统、启动一些守护进程，其中最重要的守护进程就是 <code>Zygote</code> 进程。<code>Zygote</code> 进程初始化时会创建 <code>Dalvik</code> 虚拟机、预装载系统的资源和 <code>Java</code> 类。所有从 <code>Zygote</code> 进程 <code>fork</code> 出来的用户进程都将继承和共享这些预加载的资源。<code>init</code> 进程是 <code>Android</code> 的第一个进程，而 <code>Zygote</code> 进程则是所有用户进程的根进程。<code>SystemServer</code> 是 <code>Zygote</code> 进程 <code>fork</code> 出的第一个进程，也是整个 <code>Android</code> 系统的核心进程。</p>

<!--more-->


<h2>zygote 进程</h2>

<h3>解析 zygote.rc</h3>

<p>在文件中 /system/core/rootdir/init.rc 中包含了 zygote.rc:
<code>
import /init.${ro.zygote}.rc
</code></p>

<p><code>${ro.zygote}</code>是平台相关的参数，实际可对应到 <code>init.zygote32.rc</code>， <code>init.zygote64.rc</code>， <code>init.zygote64_32.rc</code>， <code>init.zygote32_64.rc</code>，前两个只会启动单一<code>app_process(64)</code> 进程，而后两个则会启动两个<code>app_process</code>进程：第二个<code>app_process</code>进程称为 <code>secondary</code>，在后面的代码中可以看到相应 <code>secondary socket</code> 的创建过程。为简化起见，在这里就不考虑这种创建两个<code>app_process</code>进程的情形。</p>

<p>以 <code>/system/core/rootdir/init.zygote32.rc</code> 为例：
<code>
    service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
    class main
    socket zygote stream 660 root system
    onrestart write /sys/android_power/request_state wake
    onrestart write /sys/power/state on
    onrestart restart media
    onrestart restart netd
</code></p>

<p>第一行创建了名为 <code>zygote</code> 的进程，这个进程是通过 <code>app_process</code> 的 <code>main</code> 启动并以<code>-Xzygote /system/bin &ndash;zygote &ndash;start-system-server</code>作为<code>main</code>的入口参数。</p>

<p><code>app_process</code> 对应代码为 <code>framework/base/cmds/app_process/app_main.cpp</code>。在这个文件的 <code>main</code> 函数中：</p>

<pre><code class="java">AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));

    if (zygote) {
        runtime.start("com.android.internal.os.ZygoteInit", args);
    } else if (className) {
        runtime.start("com.android.internal.os.RuntimeInit", args);
    }
</code></pre>

<p>根据入口参数，我们知道 <code>zygote</code> 为<code>true</code>，<code>args</code>参数中包含了<code>&ldquo;start-system-server&rdquo;</code>。</p>

<p><code>AppRuntime</code> 继承自 <code>AndroidRuntime</code>，因此下一步就执行到 <code>AndroidRuntime</code> 的 <code>start</code> 函数。</p>

<pre><code class="java">void AndroidRuntime::start(const char* className, const Vector&lt;String8&gt;&amp; options)
{
    /* start the virtual machine */ // 创建虚拟机
    JniInvocation jni_invocation;
    jni_invocation.Init(NULL);
    JNIEnv* env;
    if (startVm(&amp;mJavaVM, &amp;env) != 0) {
        return;
    }
    onVmCreated(env);

    ...
    //调用className对应类的静态main()函数
    char* slashClassName = toSlashClassName(className);
    jclass startClass = env-&gt;FindClass(slashClassName);
    jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, "main",
    env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);
    ...
}
</code></pre>

<p><code>start</code>函数主要做两件事：创建虚拟机和调用传入类名对应类的 <code>main</code> 函数。因此下一步就执行到 <code>com.android.internal.os.ZygoteInit</code> 的 <code>main</code> 函数。
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public static void main(String argv[]) {
</span><span class='line'>    try {
</span><span class='line'>        boolean startSystemServer = false;
</span><span class='line'>        String socketName = &ldquo;zygote&rdquo;;
</span><span class='line'>        for (int i = 1; i &lt; argv.length; i++) {
</span><span class='line'>            if (&ldquo;start-system-server&rdquo;.equals(argv[i])) {
</span><span class='line'>                startSystemServer = true;
</span><span class='line'>            }
</span><span class='line'>            &hellip;
</span><span class='line'>        }&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;        registerZygoteSocket(socketName);
</span><span class='line'>    ...
</span><span class='line'>    preload();
</span><span class='line'>    ...
</span><span class='line'>
</span><span class='line'>    if (startSystemServer) {
</span><span class='line'>        startSystemServer(abiList, socketName);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    Log.i(TAG, "Accepting command socket connections");
</span><span class='line'>    runSelectLoop(abiList);
</span><span class='line'>
</span><span class='line'>    closeServerSocket();
</span><span class='line'>} catch (MethodAndArgsCaller caller) {
</span><span class='line'>    caller.run();
</span><span class='line'>} catch (RuntimeException ex) {
</span><span class='line'>    Log.e(TAG, "Zygote died with exception", ex);
</span><span class='line'>    closeServerSocket();
</span><span class='line'>    throw ex;
</span><span class='line'>}
</span><span class='line'>}
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>它主要做了三件事情:
</span><span class='line'>1. 调用 &lt;code&gt;registerZygoteSocket&lt;/code&gt; 函数创建了一个 &lt;code&gt;socket&lt;/code&gt; 接口，用来和 &lt;code&gt;ActivityManagerService&lt;/code&gt; 通讯；
</span><span class='line'>2. 调用 &lt;code&gt;startSystemServer&lt;/code&gt; 函数来启动 &lt;code&gt;SystemServer&lt;/code&gt;;
</span><span class='line'>3. 调用 &lt;code&gt;runSelectLoop&lt;/code&gt; 函数进入一个无限循环在前面创建的 &lt;code&gt;socket&lt;/code&gt; 接口上等待 &lt;code&gt;ActivityManagerService&lt;/code&gt; 请求创建新的应用程序进程。
</span><span class='line'>
</span><span class='line'>这里要留意 &lt;code&gt;catch (MethodAndArgsCaller caller)&lt;/code&gt; 这一行，&lt;code&gt;android&lt;/code&gt; 在这里通过抛出一个异常来处理正常的业务逻辑。
</span><span class='line'>
</span><span class='line'>### 创建 zygote socket
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;static final String ANDROID_SOCKET_PREFIX = "ANDROID_SOCKET_";
</span><span class='line'>
</span><span class='line'>private static void registerZygoteSocket(String socketName) {
</span><span class='line'>if (sServerSocket == null) {
</span><span class='line'>    int fileDesc;
</span><span class='line'>    final String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;
</span><span class='line'>    try {
</span><span class='line'>        String env = System.getenv(fullSocketName);
</span><span class='line'>        fileDesc = Integer.parseInt(env);
</span><span class='line'>    } catch (RuntimeException ex) {
</span><span class='line'>        throw new RuntimeException(fullSocketName + " unset or invalid", ex);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    try {
</span><span class='line'>        sServerSocket = new LocalServerSocket(
</span><span class='line'>                createFileDescriptor(fileDesc));
</span><span class='line'>    } catch (IOException ex) {
</span><span class='line'>        throw new RuntimeException(
</span><span class='line'>                "Error binding to local socket '" + fileDesc + "'", ex);
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>}
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;在这里根据传入参数&lt;code&gt;"zygote"&lt;/code&gt;拼成名为 &lt;code&gt;fullSocketName&lt;/code&gt; 的&lt;code&gt;key&lt;/code&gt;，该 &lt;code&gt;key&lt;/code&gt; 的值为：&lt;code&gt;ANDROID_SOCKET_zygote&lt;/code&gt;，然后查找它对应的环境变量值，解析该值得到文件描述符号，再根据该文件描述符创建 &lt;code&gt;socket&lt;/code&gt;。那么这个文件描述符是什么地方创建并写到环境变量里去的呢？还记得前面 &lt;code&gt;init.zygote32.rc&lt;/code&gt; 的第二行么？
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;socket zygote stream 660 root system
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>系统启动脚本文件 &lt;code&gt;init.rc&lt;/code&gt; 是由 &lt;code&gt;init&lt;/code&gt; 进程来解释执行的，而 &lt;code&gt;init&lt;/code&gt; 进程的源代码位于 &lt;code&gt;system/core/init&lt;/code&gt; 目录中，在 &lt;code&gt;init.c&lt;/code&gt; 文件中，是由 &lt;code&gt;service_start&lt;/code&gt; 函数来解释 &lt;code&gt;init.zygote32.rc&lt;/code&gt; 文件中的 &lt;code&gt;service&lt;/code&gt; 命令的：
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;void service_start(struct service *svc, const char *dynamic_args)
</span><span class='line'>{
</span><span class='line'>...
</span><span class='line'>pid = fork();
</span><span class='line'>
</span><span class='line'>if (pid == 0) {
</span><span class='line'>    struct socketinfo *si;
</span><span class='line'>    ...
</span><span class='line'>
</span><span class='line'>    for (si = svc-&gt;sockets; si; si = si-&gt;next) {
</span><span class='line'>        int socket_type = (
</span><span class='line'>                !strcmp(si-&gt;type, "stream") ? SOCK_STREAM :
</span><span class='line'>                    (!strcmp(si-&gt;type, "dgram") ? SOCK_DGRAM : SOCK_SEQPACKET));
</span><span class='line'>        int s = create_socket(si-&gt;name, socket_type,
</span><span class='line'>                              si-&gt;perm, si-&gt;uid, si-&gt;gid, si-&gt;socketcon ?: scon);
</span><span class='line'>        if (s &gt;= 0) {
</span><span class='line'>            publish_socket(si-&gt;name, s);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    ...
</span><span class='line'>}
</span><span class='line'>...
</span><span class='line'>}
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>每一个 service 命令都会促使 init 进程调用 fork 函数来创建一个新的进程，在新的进程里面，会分析里面的 socket 选项，对于每一个 socket 选项，都会通过 &lt;code&gt;create_socket&lt;/code&gt; 函数来在 &lt;code&gt;/dev/socket&lt;/code&gt; 目录下创建一个文件，在 zygote 进程中 socket 选项为&lt;code&gt;socket zygote stream 660 root system&lt;/code&gt;，因此这个文件便是 zygote了，然后得到的文件描述符通过 &lt;code&gt;publish_socket&lt;/code&gt; 函数写入到环境变量中去：
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;static void publish_socket(const char *name, int fd)
</span><span class='line'>{
</span><span class='line'>char key[64] = ANDROID_SOCKET_ENV_PREFIX;
</span><span class='line'>char val[64];
</span><span class='line'>
</span><span class='line'>strlcpy(key + sizeof(ANDROID_SOCKET_ENV_PREFIX) - 1,
</span><span class='line'>        name,
</span><span class='line'>        sizeof(key) - sizeof(ANDROID_SOCKET_ENV_PREFIX));
</span><span class='line'>snprintf(val, sizeof(val), "%d", fd);
</span><span class='line'>add_environment(key, val);
</span><span class='line'>
</span><span class='line'>/* make sure we don't close-on-exec */
</span><span class='line'>fcntl(fd, F_SETFD, 0);
</span><span class='line'>}
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>这里传进来的参数name值为"zygote"，而 &lt;code&gt;ANDROID_SOCKET_ENV_PREFIX&lt;/code&gt; 在 &lt;code&gt;system/core/include/cutils/sockets.h&lt;/code&gt; 定义为：
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;define ANDROID_SOCKET_ENV_PREFIX   &ldquo;ANDROID_SOCKET_&rdquo;&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;define ANDROID_SOCKET_DIR          &ldquo;/dev/socket&rdquo;&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>因此，这里就把上面得到的文件描述符写入到以 &lt;code&gt;ANDROID_SOCKET_zygote&lt;/code&gt; 为 key 值的环境变量中。又因为上面的 &lt;code&gt;ZygoteInit.registerZygoteSocket&lt;/code&gt; 函数与这里创建 socket 文件的 create_socket 函数是运行在同一个进程中，因此，上面的 &lt;code&gt;ZygoteInit.registerZygoteSocket&lt;/code&gt; 函数可以直接使用这个文件描述符来创建一个 Java 层的 LocalServerSocket 对象。如果其它进程也需要打开这个 &lt;code&gt;/dev/socket/zygote&lt;/code&gt; 文件来和 zygote 进程进行通信，那就必须要通过文件名来连接这个 LocalServerSocket了。也就是说创建 zygote socket 之后，ActivityManagerService 就能够通过该 socket 与 zygote 进程通信从而 fork 创建新进程，android 中的所有应用进程都是通过这种方式 fork zygote 进程创建的。在 ActivityManagerService中 的 &lt;code&gt;startProcessLocked&lt;/code&gt; 中调用了 &lt;code&gt;Process.start()&lt;/code&gt; 方法，进而调用 &lt;code&gt;Process.startViaZygote&lt;/code&gt; 和 &lt;code&gt;Process.openZygoteSocketIfNeeded&lt;/code&gt;。
</span><span class='line'>
</span><span class='line'>### 启动 SystemServer
</span><span class='line'>socket 创建完成之后，紧接着就通过 &lt;code&gt;startSystemServer&lt;/code&gt; 函数来启动 &lt;code&gt;SystemServer&lt;/code&gt; 进程。
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;private static boolean startSystemServer(String abiList, String socketName)
</span><span class='line'>{
</span><span class='line'>long capabilities = posixCapabilitiesAsBits(
</span><span class='line'>    OsConstants.CAP_BLOCK_SUSPEND,
</span><span class='line'>    OsConstants.CAP_KILL,
</span><span class='line'>    OsConstants.CAP_NET_ADMIN,
</span><span class='line'>    OsConstants.CAP_NET_BIND_SERVICE,
</span><span class='line'>    OsConstants.CAP_NET_BROADCAST,
</span><span class='line'>    OsConstants.CAP_NET_RAW,
</span><span class='line'>    OsConstants.CAP_SYS_MODULE,
</span><span class='line'>    OsConstants.CAP_SYS_NICE,
</span><span class='line'>    OsConstants.CAP_SYS_RESOURCE,
</span><span class='line'>    OsConstants.CAP_SYS_TIME,
</span><span class='line'>    OsConstants.CAP_SYS_TTY_CONFIG
</span><span class='line'>);
</span><span class='line'>/* Hardcoded command line to start the system server */
</span><span class='line'>String args[] = {
</span><span class='line'>    "--setuid=1000",
</span><span class='line'>    "--setgid=1000",
</span><span class='line'>    "--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1032,3001,3002,3003,3006,3007",
</span><span class='line'>    "--capabilities=" + capabilities + "," + capabilities,
</span><span class='line'>    "--runtime-init",
</span><span class='line'>    "--nice-name=system_server",
</span><span class='line'>    "com.android.server.SystemServer",
</span><span class='line'>};
</span><span class='line'>ZygoteConnection.Arguments parsedArgs = null;
</span><span class='line'>
</span><span class='line'>int pid;
</span><span class='line'>
</span><span class='line'>try {
</span><span class='line'>    parsedArgs = new ZygoteConnection.Arguments(args);
</span><span class='line'>    ...
</span><span class='line'>
</span><span class='line'>    /* Request to fork the system server process */
</span><span class='line'>    pid = Zygote.forkSystemServer(
</span><span class='line'>            parsedArgs.uid, parsedArgs.gid,
</span><span class='line'>            parsedArgs.gids,
</span><span class='line'>            parsedArgs.debugFlags,
</span><span class='line'>            null,
</span><span class='line'>            parsedArgs.permittedCapabilities,
</span><span class='line'>            parsedArgs.effectiveCapabilities);
</span><span class='line'>} catch (IllegalArgumentException ex) {
</span><span class='line'>    throw new RuntimeException(ex);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/* For child process */
</span><span class='line'>if (pid == 0) {
</span><span class='line'>    if (hasSecondZygote(abiList)) {
</span><span class='line'>        waitForSecondaryZygote(socketName);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    handleSystemServerProcess(parsedArgs);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>return true;
</span><span class='line'>}
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>这里我们可以从参数推测出：创建名为&lt;code&gt;“system_server"&lt;/code&gt;的进程，其入口是： &lt;code&gt;com.android.server.SystemServer&lt;/code&gt; 的 &lt;code&gt;main&lt;/code&gt; 函数。&lt;code&gt;zygote&lt;/code&gt; 进程通过 &lt;code&gt;Zygote.forkSystemServer&lt;/code&gt; 函数来创建一个新的进程来启动 &lt;code&gt;SystemServer&lt;/code&gt; 组件，返回值 &lt;code&gt;pid&lt;/code&gt; 等 0 的地方就是新的进程要执行的路径，即新创建的进程会执行 &lt;code&gt;handleSystemServerProcess&lt;/code&gt; 函数。&lt;code&gt;hasSecondZygote&lt;/code&gt; 是针对 &lt;code&gt;init.zygote64_32.rc&lt;/code&gt;， &lt;code&gt;init.zygote32_64.rc&lt;/code&gt; 这两者情况的，在这里跳过不谈。接下来来看 &lt;code&gt;handleSystemServerProcess&lt;/code&gt;：
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;/**
</span><span class='line'> * Finish remaining work for the newly forked system server process.
</span><span class='line'> */
</span><span class='line'>private static void handleSystemServerProcess(
</span><span class='line'>    ZygoteConnection.Arguments parsedArgs)
</span><span class='line'>    throws ZygoteInit.MethodAndArgsCaller
</span><span class='line'>{
</span><span class='line'>closeServerSocket();
</span><span class='line'>
</span><span class='line'>// set umask to 0077 so new files and directories will default to owner-only permissions.
</span><span class='line'>Os.umask(S_IRWXG | S_IRWXO);
</span><span class='line'>
</span><span class='line'>if (parsedArgs.niceName != null) {
</span><span class='line'>    Process.setArgV0(parsedArgs.niceName);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>final String systemServerClasspath = Os.getenv("SYSTEMSERVERCLASSPATH");
</span><span class='line'>
</span><span class='line'>ClassLoader cl = null;
</span><span class='line'>if (systemServerClasspath != null) {
</span><span class='line'>    cl = new PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader());
</span><span class='line'>    Thread.currentThread().setContextClassLoader(cl);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/*
</span><span class='line'> * Pass the remaining arguments to SystemServer.
</span><span class='line'> */
</span><span class='line'>RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);
</span><span class='line'>
</span><span class='line'>/* should never reach here */
</span><span class='line'>}
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>&lt;code&gt;handleSystemServerProcess&lt;/code&gt; 会抛出 &lt;code&gt;MethodAndArgsCaller&lt;/code&gt; 异常，前面提到这个异常其实是处理正常业务逻辑的，相当于一个回调。由于由 &lt;code&gt;zygote&lt;/code&gt; 进程创建的子进程会继承 &lt;code&gt;zygote&lt;/code&gt; 进程在前面创建的 &lt;code&gt;socket&lt;/code&gt; 文件描述符，而这里的子进程又不会用到它，因此，这里就调用 &lt;code&gt;closeServerSocket&lt;/code&gt; 函数来关闭它。&lt;code&gt;SYSTEMSERVERCLASSPATH&lt;/code&gt; 是包含 &lt;code&gt;/system/framework/framework.jar&lt;/code&gt; 的环境变量，它定义在 &lt;code&gt;system/core/rootdir/init.environ.rc.in&lt;/code&gt; 中：
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;on init
</span><span class='line'>export PATH /sbin:/vendor/bin:/system/sbin:/system/bin:/system/xbin
</span><span class='line'>export ANDROID_BOOTLOGO 1
</span><span class='line'>export ANDROID_ROOT /system
</span><span class='line'>export SYSTEMSERVERCLASSPATH %SYSTEMSERVERCLASSPATH%
</span><span class='line'>export LD_PRELOAD libsigchain.so
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>&lt;code&gt;handleSystemServerProcess&lt;/code&gt; 函数接着调用 &lt;code&gt;RuntimeInit.zygoteInit&lt;/code&gt; 函数来进一步执行启动 &lt;code&gt;SystemServer&lt;/code&gt; 组件的操作。
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;public static final void zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader)
</span><span class='line'>    throws ZygoteInit.MethodAndArgsCaller {
</span><span class='line'>
</span><span class='line'>commonInit();
</span><span class='line'>nativeZygoteInit();
</span><span class='line'>
</span><span class='line'>applicationInit(targetSdkVersion, argv, classLoader);
</span><span class='line'>}
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>&lt;code&gt;commonInit&lt;/code&gt; 设置线程未处理异常 &lt;code&gt;handler&lt;/code&gt;，时区等，&lt;code&gt;JNI&lt;/code&gt; 方法 &lt;code&gt;nativeZygoteInit&lt;/code&gt; 实现在 &lt;code&gt;frameworks/base/core/jni/AndroidRuntime.cpp&lt;/code&gt; 中：
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;static AndroidRuntime* gCurRuntime = NULL;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;static void com_android_internal_os_RuntimeInit_nativeZygoteInit(JNIEnv* env, jobject clazz)
</span><span class='line'>{
</span><span class='line'>gCurRuntime-&gt;onZygoteInit();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>

<p><code>AndroidRuntime</code> 是个带虚函数的基类，真正的实现是在 <code>app_main.cpp</code> 中的 <code>AppRuntime</code>:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">AppRuntime</span> <span class="o">:</span> <span class="k">public</span> <span class="n">AndroidRuntime</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">onStarted</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">sp</span><span class="o">&lt;</span><span class="n">ProcessState</span><span class="o">&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">();</span>
</span><span class='line'>        <span class="n">ALOGV</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">App</span> <span class="nl">process</span><span class="p">:</span> <span class="n">starting</span> <span class="kr">thread</span> <span class="n">pool</span><span class="p">.</span><span class="err">\</span><span class="n">n</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;);</span>
</span><span class='line'>        <span class="n">proc</span><span class="o">-&gt;</span><span class="n">startThreadPool</span><span class="p">();</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="n">AndroidRuntime</span><span class="o">*</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">AndroidRuntime</span><span class="o">::</span><span class="n">getRuntime</span><span class="p">();</span>
</span><span class='line'>    <span class="n">ar</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">callMain</span><span class="p">(</span><span class="n">mClassName</span><span class="p">,</span> <span class="n">mClass</span><span class="p">,</span> <span class="n">mArgs</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">stopProcess</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">virtual</span> <span class="kt">void</span> <span class="n">onZygoteInit</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Re-enable tracing now that we&#39;re no longer in Zygote.</span>
</span><span class='line'>    <span class="n">atrace_set_tracing_enabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sp</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">ProcessState</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">();</span>
</span><span class='line'>    <span class="n">ALOGV</span><span class="p">(</span><span class="s">&quot;App process: starting thread pool.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">proc</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">startThreadPool</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">virtual</span> <span class="kt">void</span> <span class="n">onExit</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">mClassName</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// if zygote</span>
</span><span class='line'>        <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">stopProcess</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">AndroidRuntime</span><span class="o">::</span><span class="n">onExit</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>通过执行 <code>AppRuntime::onZygoteInit</code> 函数，这个进程的 <code>Binder</code> 进程间通信机制基础设施就准备好了，参考代码 <code>frameworks/native/libs/binder/ProcessState.cpp</code>。</p>

<p>接下来，看 applicationInit ：
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
<span class='line-number'>537</span>
<span class='line-number'>538</span>
<span class='line-number'>539</span>
<span class='line-number'>540</span>
<span class='line-number'>541</span>
<span class='line-number'>542</span>
<span class='line-number'>543</span>
<span class='line-number'>544</span>
<span class='line-number'>545</span>
<span class='line-number'>546</span>
<span class='line-number'>547</span>
<span class='line-number'>548</span>
<span class='line-number'>549</span>
<span class='line-number'>550</span>
<span class='line-number'>551</span>
<span class='line-number'>552</span>
<span class='line-number'>553</span>
<span class='line-number'>554</span>
<span class='line-number'>555</span>
<span class='line-number'>556</span>
<span class='line-number'>557</span>
<span class='line-number'>558</span>
<span class='line-number'>559</span>
<span class='line-number'>560</span>
<span class='line-number'>561</span>
<span class='line-number'>562</span>
<span class='line-number'>563</span>
<span class='line-number'>564</span>
<span class='line-number'>565</span>
<span class='line-number'>566</span>
<span class='line-number'>567</span>
<span class='line-number'>568</span>
<span class='line-number'>569</span>
<span class='line-number'>570</span>
<span class='line-number'>571</span>
<span class='line-number'>572</span>
<span class='line-number'>573</span>
<span class='line-number'>574</span>
<span class='line-number'>575</span>
<span class='line-number'>576</span>
<span class='line-number'>577</span>
<span class='line-number'>578</span>
<span class='line-number'>579</span>
<span class='line-number'>580</span>
<span class='line-number'>581</span>
<span class='line-number'>582</span>
<span class='line-number'>583</span>
<span class='line-number'>584</span>
<span class='line-number'>585</span>
<span class='line-number'>586</span>
<span class='line-number'>587</span>
<span class='line-number'>588</span>
<span class='line-number'>589</span>
<span class='line-number'>590</span>
<span class='line-number'>591</span>
<span class='line-number'>592</span>
<span class='line-number'>593</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="kd">final</span> <span class="n">Arguments</span> <span class="n">args</span><span class="o">;</span>
</span><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>    <span class="c1">// let the process exit</span>
</span><span class='line'>    <span class="k">return</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Remaining arguments are passed to the start class&#39;s static main</span>
</span><span class='line'><span class="n">invokeStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">applicationInit</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">仅仅是转调</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">invokeStaticMain</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeStaticMain</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">Class</span> <span class="n">cl</span><span class="o">;</span>
</span><span class='line'><span class="n">cl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span><span class='line'><span class="n">Method</span> <span class="n">m</span><span class="o">;</span>
</span><span class='line'><span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * This throw gets caught in ZygoteInit.main(), which responds</span>
</span><span class='line'><span class="cm"> * by invoking the exception&#39;s run() method. This arrangement</span>
</span><span class='line'><span class="cm"> * clears up all the stack frames that were required in setting</span>
</span><span class='line'><span class="cm"> * up the process.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">throw</span> <span class="k">new</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">invokeStaticMain</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">也很简单</span><span class="err">，</span><span class="n">通过反射找到参数</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">className</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">对应的类的静态</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">main</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">方法</span><span class="err">，</span><span class="n">然后将该方法与参数生成</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">对象当做异常抛出</span><span class="err">，</span><span class="n">这个异常对象在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteInit</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">的</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">main</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">函数被捕获并执行该对象的</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">run</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">方法</span><span class="err">。</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Helper exception class which holds a method and arguments and</span>
</span><span class='line'><span class="cm"> * can call them. This is used as part of a trampoline to get rid of</span>
</span><span class='line'><span class="cm"> * the initial process setup stack frames.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodAndArgsCaller</span> <span class="kd">extends</span> <span class="n">Exception</span>
</span><span class='line'>    <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">mArgs</span> <span class="o">});</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">这么复杂的跳转</span><span class="err">，</span><span class="n">其实就做了一件简单的事情</span><span class="err">：</span><span class="n">根据</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">className</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">反射调用该类的静态</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">main</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">方法</span><span class="err">。</span><span class="n">这个类名是</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteInit</span><span class="o">.</span><span class="na">startSystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">方法中写死的</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">SystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">。</span> <span class="n">从而进入</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">SystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">类的</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">main</span><span class="o">()&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">方法</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="err">###</span> <span class="n">执行</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">runSelectLoop</span>
</span><span class='line'><span class="n">在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">startSystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">函数中</span><span class="err">，</span><span class="n">创建</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">system_server</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">进程之后</span><span class="err">，</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">pid</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">等于</span> <span class="mi">0</span> <span class="n">时在该新进程中执行</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">SystemServer</span><span class="o">.</span><span class="na">main</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">，</span><span class="n">否则回到</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">zygote</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">进程进行执行</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteInit</span><span class="o">.</span><span class="na">runSelectLoop</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runSelectLoop</span><span class="o">(</span><span class="n">String</span> <span class="n">abiList</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'><span class="n">ArrayList</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">FileDescriptor</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">fds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">FileDescriptor</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;();</span>
</span><span class='line'><span class="n">ArrayList</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">ZygoteConnection</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">ZygoteConnection</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;();</span>
</span><span class='line'><span class="n">FileDescriptor</span><span class="o">[]</span> <span class="n">fdArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileDescriptor</span><span class="o">[</span><span class="mi">4</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'><span class="n">fds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sServerSocket</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">());</span>
</span><span class='line'><span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">loopCount</span> <span class="o">=</span> <span class="n">GC_LOOP_COUNT</span><span class="o">;</span>
</span><span class='line'><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Call gc() before we block in select().</span>
</span><span class='line'><span class="cm">     * It&#39;s work that has to be done anyway, and it&#39;s better</span>
</span><span class='line'><span class="cm">     * to avoid making every child do it.  It will also</span>
</span><span class='line'><span class="cm">     * madvise() any free memory as a side-effect.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Don&#39;t call it every time, because walking the entire</span>
</span><span class='line'><span class="cm">     * heap is a lot of overhead to free a few hundred bytes.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">loopCount</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">gc</span><span class="o">();</span>
</span><span class='line'>        <span class="n">loopCount</span> <span class="o">=</span> <span class="n">GC_LOOP_COUNT</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">loopCount</span><span class="o">--;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">fdArray</span> <span class="o">=</span> <span class="n">fds</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">fdArray</span><span class="o">);</span>
</span><span class='line'>        <span class="n">index</span> <span class="o">=</span> <span class="n">selectReadable</span><span class="o">(</span><span class="n">fdArray</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Error in select()&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Error in select()&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ZygoteConnection</span> <span class="n">newPeer</span> <span class="o">=</span> <span class="n">acceptCommandPeer</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
</span><span class='line'>        <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">);</span>
</span><span class='line'>        <span class="n">fds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">done</span><span class="o">;</span>
</span><span class='line'>        <span class="n">done</span> <span class="o">=</span> <span class="n">peers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">runOnce</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">peers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span><span class='line'>            <span class="n">fds</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">runSelectLoop</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">函数的逻辑比较简单</span><span class="err">，</span><span class="n">主要有两点</span><span class="err">：</span>
</span><span class='line'><span class="mi">1</span><span class="err">、</span> <span class="n">处理客户端的连接和请求</span><span class="err">。</span><span class="n">前面创建的</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">LocalServerSocket</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">对象保存</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">sServerSocket</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">，</span><span class="n">这个</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">socket</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">通过</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">selectReadable</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">等待</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ActivityManagerService</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">简写</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">AMS</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;)</span> <span class="n">与之通信</span><span class="err">。</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">selectReadable</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">是一个</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="kd">native</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">函数</span><span class="err">，</span><span class="n">内部调用</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">select</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">等待</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">AMS</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">连接</span><span class="err">，</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">AMS</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nl">连接上之后就会返回:</span> <span class="n">返回值</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="mi">0</span><span class="err">：</span><span class="n">内部发生错误</span><span class="err">；</span><span class="n">返回值</span> <span class="o">=</span> <span class="mi">0</span><span class="err">：</span><span class="n">第一次连接到服务端</span> <span class="err">；</span><span class="n">返回值</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">0</span><span class="err">：</span><span class="n">与服务端已经建立连接</span><span class="err">，</span><span class="n">并开始发送数据</span><span class="err">。</span><span class="n">每一个链接在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">zygote</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">进程中使用</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteConnection</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">对象表示</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span><span class="err">、</span> <span class="n">客户端的请求由</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteConnection</span><span class="o">.</span><span class="na">runOnce</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">来处理</span><span class="err">，</span><span class="n">这个方法也抛出</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">MethodAndArgsCaller</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">异常</span><span class="err">，</span><span class="n">从而进入</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">MethodAndArgsCaller</span><span class="o">.</span><span class="na">run</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中调用根据客户请求数据反射出的类的</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">main</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">方法</span><span class="err">。</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">readArgumentList</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kt">int</span> <span class="n">argc</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mSocketReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// EOF reached.</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">argc</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;invalid Zygote wire format: non-int at argc&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;invalid wire format&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">String</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">argc</span><span class="o">];</span>
</span><span class='line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">argc</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">mSocketReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// We got an unexpected EOF.</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;truncated request&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">boolean</span> <span class="nf">runOnce</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'><span class="n">String</span> <span class="n">args</span><span class="o">[];</span>
</span><span class='line'><span class="n">Arguments</span> <span class="n">parsedArgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'><span class="n">args</span> <span class="o">=</span> <span class="n">readArgumentList</span><span class="o">();</span>
</span><span class='line'><span class="n">parsedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Arguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
</span><span class='line'>        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mountExternal</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">seInfo</span><span class="o">,</span>
</span><span class='line'>        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">instructionSet</span><span class="o">,</span>
</span><span class='line'>        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">appDataDir</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="err">##</span> <span class="n">SystemServer</span> <span class="n">启动过程</span>
</span><span class='line'><span class="n">在前面启动</span> <span class="n">SystemServer一节讲到</span><span class="err">，</span><span class="n">通过反射调用类</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">SystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">main</span><span class="o">()</span> <span class="n">函数</span><span class="err">，</span><span class="n">从而开始执行</span> <span class="n">SystemServer</span> <span class="n">的初始化流程</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="n">SystemServer</span><span class="o">.</span><span class="na">main</span><span class="o">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * The main entry point from zygote.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="k">new</span> <span class="nf">SystemServer</span><span class="o">().</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">main</span> <span class="n">函数创建一个</span> <span class="n">SystemServer</span> <span class="n">对象</span><span class="err">，</span><span class="n">调用其</span> <span class="nf">run</span><span class="o">()</span> <span class="n">方法</span><span class="err">。</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="c1">// If a device&#39;s clock is before 1970 (before 0), a lot of</span>
</span><span class='line'><span class="c1">// APIs crash dealing with negative numbers, notably</span>
</span><span class='line'><span class="c1">// java.io.File#setLastModified, so instead we fake it and</span>
</span><span class='line'><span class="c1">// hope that time from cell towers or NTP fixes it shortly.</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">EARLIEST_SUPPORTED_TIME</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;System clock is before 1970; setting to 1970.&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">SystemClock</span><span class="o">.</span><span class="na">setCurrentTimeMillis</span><span class="o">(</span><span class="n">EARLIEST_SUPPORTED_TIME</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="c1">// 检测时间设置</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Here we go!</span>
</span><span class='line'><span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Entered the Android system server!&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">BOOT_PROGRESS_SYSTEM_RUN</span><span class="o">,</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// In case the runtime switched since last boot (such as when</span>
</span><span class='line'><span class="c1">// the old runtime was removed in an OTA), set the system</span>
</span><span class='line'><span class="c1">// property so that it is in sync. We can&#39;t do this in</span>
</span><span class='line'><span class="c1">// libnativehelper&#39;s JniInvocation::Init code where we already</span>
</span><span class='line'><span class="c1">// had to fallback to a different runtime because it is</span>
</span><span class='line'><span class="c1">// running as root and we need to be the system user to set</span>
</span><span class='line'><span class="c1">// the property. http://b/11463182</span>
</span><span class='line'><span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;persist.sys.dalvik.vm.lib.2&quot;</span><span class="o">,</span> <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">vmLibrary</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Enable the sampling profiler.</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">SamplingProfilerIntegration</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SamplingProfilerIntegration</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="n">mProfilerSnapshotTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Timer</span><span class="o">();</span>
</span><span class='line'>    <span class="n">mProfilerSnapshotTimer</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="nf">TimerTask</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">SamplingProfilerIntegration</span><span class="o">.</span><span class="na">writeSnapshot</span><span class="o">(</span><span class="s">&quot;system_server&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">},</span> <span class="n">SNAPSHOT_INTERVAL</span><span class="o">,</span> <span class="n">SNAPSHOT_INTERVAL</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="c1">// 启动性能分析采样</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Mmmmmm... more memory!</span>
</span><span class='line'><span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">clearGrowthLimit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The system server has to run all of the time, so it needs to be</span>
</span><span class='line'><span class="c1">// as efficient as possible with its memory usage.</span>
</span><span class='line'><span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetHeapUtilization</span><span class="o">(</span><span class="mf">0.8f</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Some devices rely on runtime fingerprint generation, so make sure</span>
</span><span class='line'><span class="c1">// we&#39;ve defined it before booting further.</span>
</span><span class='line'><span class="n">Build</span><span class="o">.</span><span class="na">ensureFingerprintProperty</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Within the system server, it is an error to access Environment paths without</span>
</span><span class='line'><span class="c1">// explicitly specifying a user.</span>
</span><span class='line'><span class="n">Environment</span><span class="o">.</span><span class="na">setUserRequired</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Ensure binder calls into the system always run at foreground priority.</span>
</span><span class='line'><span class="n">BinderInternal</span><span class="o">.</span><span class="na">disableBackgroundScheduling</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Prepare the main looper thread (this thread).</span>
</span><span class='line'><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span>
</span><span class='line'>        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_FOREGROUND</span><span class="o">);</span>
</span><span class='line'><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setCanSelfBackground</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'><span class="n">Looper</span><span class="o">.</span><span class="na">prepareMainLooper</span><span class="o">();</span> <span class="c1">// 准备主线程循环</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Initialize native services.</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&quot;android_servers&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">nativeInit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Check whether we failed to shut down last time we tried.</span>
</span><span class='line'><span class="c1">// This call may not return.</span>
</span><span class='line'><span class="n">performPendingShutdown</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Initialize the system context.</span>
</span><span class='line'><span class="n">createSystemContext</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the system service manager.</span>
</span><span class='line'><span class="n">mSystemServiceManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SystemServiceManager</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">);</span>
</span><span class='line'><span class="n">LocalServices</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">SystemServiceManager</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">mSystemServiceManager</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start services.  // 启动服务</span>
</span><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">startBootstrapServices</span><span class="o">();</span>
</span><span class='line'>    <span class="n">startCoreServices</span><span class="o">();</span>
</span><span class='line'>    <span class="n">startOtherServices</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;System&quot;</span><span class="o">,</span> <span class="s">&quot;******************************************&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;System&quot;</span><span class="o">,</span> <span class="s">&quot;************ Failure starting system services&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>    <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// For debug builds, log event loop stalls to dropbox for analysis.</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">StrictMode</span><span class="o">.</span><span class="na">conditionallyEnableDebugLogging</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Enabled StrictMode for system server main thread.&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Loop forever.</span>
</span><span class='line'><span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>  <span class="c1">// 启动线程循环，等待消息处理</span>
</span><span class='line'><span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Main thread loop unexpectedly exited&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">在这个</span> <span class="n">run</span> <span class="n">方法中</span><span class="err">，</span><span class="n">主要完成三件事情</span><span class="err">，</span><span class="n">创建</span> <span class="n">system</span> <span class="n">context</span> <span class="n">和</span> <span class="n">system</span> <span class="n">service</span> <span class="n">manager</span><span class="err">，</span><span class="n">启动一些系统服务</span><span class="err">，</span><span class="n">进入主线程消息循环</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="err">##</span> <span class="n">Zygote</span> <span class="n">的</span> <span class="n">fork</span> <span class="n">本地方法分析</span>
</span><span class='line'><span class="n">接下来我们仔细分析</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">Zygote</span><span class="o">.</span><span class="na">forkSystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">与</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">两个方法</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="err">###</span> <span class="n">forkSystemServer</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ZygoteHooks</span> <span class="n">VM_HOOKS</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ZygoteHooks</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkSystemServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
</span><span class='line'>    <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">long</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="kt">long</span> <span class="n">effectiveCapabilities</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">preFork</span><span class="o">();</span>
</span><span class='line'><span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkSystemServer</span><span class="o">(</span>
</span><span class='line'>        <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="n">effectiveCapabilities</span><span class="o">);</span>
</span><span class='line'><span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">postForkCommon</span><span class="o">();</span>
</span><span class='line'><span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">在调用</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">nativeForkSystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">创建</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">system_server</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">进程之前与之后</span><span class="err">，</span><span class="n">都会调用</span> <span class="n">ZygoteHooks</span> <span class="n">进行一些前置与后置处理</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="err">####</span> <span class="n">ZygoteHooks</span><span class="o">.</span><span class="na">preFork</span>
</span><span class='line'><span class="n">前置处理</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteHooks</span><span class="o">.</span><span class="na">preFork</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">preFork</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="n">Daemons</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'><span class="n">waitUntilAllThreadsStopped</span><span class="o">();</span>
</span><span class='line'><span class="n">token</span> <span class="o">=</span> <span class="n">nativePreFork</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">Daemons</span><span class="o">.</span><span class="na">stop</span><span class="o">()&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;;</span> <span class="n">停止虚拟机中一些守护线程操作</span><span class="err">：</span><span class="n">如引用队列</span><span class="err">、</span><span class="n">终接器</span><span class="err">、</span><span class="n">GC等</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="n">ReferenceQueueDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'><span class="n">FinalizerDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'><span class="n">FinalizerWatchdogDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'><span class="n">HeapTrimmerDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'><span class="n">GCDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">waitUntilAllThreadsStopped</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">保证被</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">fork</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">的进程是单线程</span><span class="err">，</span><span class="n">这样可以确保通过</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">copyonwrite</span> <span class="n">fork</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">出来的进程也是单线程</span><span class="err">，</span><span class="n">从而节省资源</span><span class="err">。</span><span class="n">与前面提到的在新建</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">system_server</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">进程中调用</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">closeServerSocket</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">关闭</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">sockect</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">有异曲同工之妙</span><span class="err">。</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * We must not fork until we&#39;re single-threaded again. Wait until /proc shows we&#39;re</span>
</span><span class='line'><span class="cm"> * down to just one thread.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">waitUntilAllThreadsStopped</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="n">File</span> <span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">&quot;/proc/self/task&quot;</span><span class="o">);</span>
</span><span class='line'><span class="k">while</span> <span class="o">(</span><span class="n">tasks</span><span class="o">.</span><span class="na">list</span><span class="o">().</span><span class="na">length</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Experimentally, booting and playing about with a stingray, I never saw us</span>
</span><span class='line'>        <span class="c1">// go round this loop more than once with a 10ms sleep.</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">本地方法</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">nativePreFork</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">实现在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">art</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="kd">native</span><span class="o">/</span><span class="n">dalvik_system_ZygoteHooks</span><span class="o">.</span><span class="na">cc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中</span><span class="err">。</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">static</span> <span class="n">jlong</span> <span class="nf">ZygoteHooks_nativePreFork</span><span class="o">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="o">,</span> <span class="n">jclass</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Runtime</span><span class="o">*</span> <span class="n">runtime</span> <span class="o">=</span> <span class="nl">Runtime:</span><span class="o">:</span><span class="n">Current</span><span class="o">();</span>
</span><span class='line'>  <span class="n">CHECK</span><span class="o">(</span><span class="n">runtime</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">IsZygote</span><span class="o">())</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="s">&quot;runtime instance not started with -Xzygote&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">runtime</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">PreZygoteFork</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Grab thread before fork potentially makes Thread::pthread_key_self_ unusable.</span>
</span><span class='line'>  <span class="n">Thread</span><span class="o">*</span> <span class="n">self</span> <span class="o">=</span> <span class="nl">Thread:</span><span class="o">:</span><span class="n">Current</span><span class="o">();</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">reinterpret_cast</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">jlong</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">self</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteHooks_nativePreFork</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">通过调用</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="nl">Runtime:</span><span class="o">:</span><span class="n">PreZygoteFork</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">来完成</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">gc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">堆的一些初始化</span><span class="err">，</span><span class="n">这部分代码在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">art</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">runtime</span><span class="o">.</span><span class="na">cc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">heap_</span> <span class="o">=</span> <span class="k">new</span> <span class="nl">gc:</span><span class="o">:</span><span class="n">Heap</span><span class="o">(...);</span>
</span><span class='line'><span class="kt">void</span> <span class="nl">Runtime:</span><span class="o">:</span><span class="n">PreZygoteFork</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="n">heap_</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">PreZygoteFork</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="err">####</span> <span class="n">创建</span> <span class="n">system_server</span> <span class="n">进程</span><span class="err">：</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">nativeForkSystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">实现在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">framework</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">jni</span><span class="o">/</span><span class="n">com_android_internal_os_Zygote</span><span class="o">.</span><span class="na">cpp</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">static</span> <span class="n">jint</span> <span class="nf">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="o">(</span>
</span><span class='line'>    <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="o">,</span> <span class="n">jclass</span><span class="o">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="o">,</span> <span class="n">jintArray</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>    <span class="n">jint</span> <span class="n">debug_flags</span><span class="o">,</span> <span class="n">jobjectArray</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">jlong</span> <span class="n">permittedCapabilities</span><span class="o">,</span>
</span><span class='line'>    <span class="n">jlong</span> <span class="n">effectiveCapabilities</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">ForkAndSpecializeCommon</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>                <span class="n">debug_flags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span>
</span><span class='line'>                <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="n">effectiveCapabilities</span><span class="o">,</span>
</span><span class='line'>                <span class="n">MOUNT_EXTERNAL_NONE</span><span class="o">,</span> <span class="n">NULL</span><span class="o">,</span> <span class="n">NULL</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">NULL</span><span class="o">,</span>
</span><span class='line'>                <span class="n">NULL</span><span class="o">,</span> <span class="n">NULL</span><span class="o">);</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// The zygote process checks whether the child process has died or not.</span>
</span><span class='line'>    <span class="n">ALOGI</span><span class="o">(</span><span class="s">&quot;System server process %d has been created&quot;</span><span class="o">,</span> <span class="n">pid</span><span class="o">);</span>
</span><span class='line'>    <span class="n">gSystemServerPid</span> <span class="o">=</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'>    <span class="c1">// There is a slight window that the system server process has crashed</span>
</span><span class='line'>    <span class="c1">// but it went unnoticed because we haven&#39;t published its pid yet. So</span>
</span><span class='line'>    <span class="c1">// we recheck here just to make sure that all is well.</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">status</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">waitpid</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">status</span><span class="o">,</span> <span class="n">WNOHANG</span><span class="o">)</span> <span class="o">==</span> <span class="n">pid</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ALOGE</span><span class="o">(</span><span class="s">&quot;System server process %d has died. Restarting Zygote!&quot;</span><span class="o">,</span> <span class="n">pid</span><span class="o">);</span>
</span><span class='line'>        <span class="n">RuntimeAbort</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">它转调</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ForkAndSpecializeCommon</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">来创建新进程</span><span class="err">，</span><span class="n">并确保</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">system_server</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">创建成功</span><span class="err">，</span><span class="n">若不成功便成仁</span><span class="err">：</span><span class="n">重启</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">zygote</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">，</span><span class="n">因为没有</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">system_server</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">就干不了什么事情</span><span class="err">。</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ForkAndSpecializeCommon</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">实现如下</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">static</span> <span class="kd">const</span> <span class="kt">char</span> <span class="n">kZygoteClassName</span><span class="o">[]</span> <span class="o">=</span> <span class="s">&quot;com/android/internal/os/Zygote&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">gZygoteClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">jclass</span><span class="o">)</span> <span class="n">env</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">NewGlobalRef</span><span class="o">(</span><span class="n">env</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">FindClass</span><span class="o">(</span><span class="n">kZygoteClassName</span><span class="o">));</span>
</span><span class='line'><span class="n">gCallPostForkChildHooks</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">GetStaticMethodID</span><span class="o">(</span><span class="n">gZygoteClass</span><span class="o">,</span> <span class="s">&quot;callPostForkChildHooks&quot;</span><span class="o">,</span>
</span><span class='line'>                                   <span class="s">&quot;(ILjava/lang/String;)V&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Utility routine to fork zygote and specialize the child process.</span>
</span><span class='line'><span class="kd">static</span> <span class="n">pid_t</span> <span class="nf">ForkAndSpecializeCommon</span><span class="o">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="o">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="o">,</span> <span class="n">jintArray</span> <span class="n">javaGids</span><span class="o">,</span>
</span><span class='line'>             <span class="n">jint</span> <span class="n">debug_flags</span><span class="o">,</span> <span class="n">jobjectArray</span> <span class="n">javaRlimits</span><span class="o">,</span>
</span><span class='line'>             <span class="n">jlong</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="n">jlong</span> <span class="n">effectiveCapabilities</span><span class="o">,</span>
</span><span class='line'>             <span class="n">jint</span> <span class="n">mount_external</span><span class="o">,</span>
</span><span class='line'>             <span class="n">jstring</span> <span class="n">java_se_info</span><span class="o">,</span> <span class="n">jstring</span> <span class="n">java_se_name</span><span class="o">,</span>
</span><span class='line'>             <span class="n">bool</span> <span class="n">is_system_server</span><span class="o">,</span> <span class="n">jintArray</span> <span class="n">fdsToClose</span><span class="o">,</span>
</span><span class='line'>             <span class="n">jstring</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">jstring</span> <span class="n">dataDir</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">SetSigChldHandler</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// The child process.</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">rc</span> <span class="o">=</span> <span class="n">selinux_android_setcontext</span><span class="o">(</span><span class="n">uid</span><span class="o">,</span> <span class="n">is_system_server</span><span class="o">,</span> <span class="n">se_info_c_str</span><span class="o">,</span> <span class="n">se_name_c_str</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">UnsetSigChldHandler</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">env</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">CallStaticVoidMethod</span><span class="o">(</span><span class="n">gZygoteClass</span><span class="o">,</span> <span class="n">gCallPostForkChildHooks</span><span class="o">,</span> <span class="n">debug_flags</span><span class="o">,</span>
</span><span class='line'>                  <span class="n">is_system_server</span> <span class="o">?</span> <span class="n">NULL</span> <span class="o">:</span> <span class="n">instructionSet</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// the parent process</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ForkAndSpecializeCommon</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">首先设置子进程异常处理</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">handler</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">，</span><span class="n">然后</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">ode</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">fork</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">新进程</span><span class="err">，</span><span class="n">在新进程中设置</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">SELinux</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">，</span><span class="n">并清除它的子进程异常处理</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">handler</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">，</span><span class="n">然后调用</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">Zygote</span><span class="o">.</span><span class="na">callPostForkChildHooks</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">方法</span><span class="err">。</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">callPostForkChildHooks</span><span class="o">(</span><span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span><span class='line'><span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">postForkChild</span><span class="o">(</span><span class="n">debugFlags</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">);</span>
</span><span class='line'><span class="n">checkTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&quot;Zygote.callPostForkChildHooks&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">callPostForkChildHooks</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">又转调</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteHooks</span><span class="o">.</span><span class="na">postForkChild</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="o">:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">postForkChild</span><span class="o">(</span><span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="n">nativePostForkChild</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">本地方法</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">nativePostForkChild</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">又进到</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">dalvik_system_ZygoteHooks</span><span class="o">.</span><span class="na">cc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">static</span> <span class="kt">void</span> <span class="nf">ZygoteHooks_nativePostForkChild</span><span class="o">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="o">,</span> <span class="n">jclass</span><span class="o">,</span> <span class="n">jlong</span> <span class="n">token</span><span class="o">,</span> <span class="n">jint</span> <span class="n">debug_flags</span><span class="o">,</span>
</span><span class='line'>                                    <span class="n">jstring</span> <span class="n">instruction_set</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="n">Thread</span><span class="o">*</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">reinterpret_cast</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">Thread</span><span class="o">*&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">token</span><span class="o">);</span>
</span><span class='line'><span class="c1">// Our system thread ID, etc, has changed so reset Thread state.</span>
</span><span class='line'><span class="n">thread</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">InitAfterFork</span><span class="o">();</span>
</span><span class='line'><span class="n">EnableDebugFeatures</span><span class="o">(</span><span class="n">debug_flags</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">instruction_set</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ScopedUtfChars</span> <span class="nf">isa_string</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">instruction_set</span><span class="o">);</span>
</span><span class='line'>    <span class="n">InstructionSet</span> <span class="n">isa</span> <span class="o">=</span> <span class="n">GetInstructionSetFromString</span><span class="o">(</span><span class="n">isa_string</span><span class="o">.</span><span class="na">c_str</span><span class="o">());</span>
</span><span class='line'>    <span class="nl">Runtime:</span><span class="o">:</span><span class="n">NativeBridgeAction</span> <span class="n">action</span> <span class="o">=</span> <span class="nl">Runtime:</span><span class="o">:</span><span class="nl">NativeBridgeAction:</span><span class="o">:</span><span class="n">kUnload</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">isa</span> <span class="o">!=</span> <span class="n">kNone</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="n">isa</span> <span class="o">!=</span> <span class="n">kRuntimeISA</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">action</span> <span class="o">=</span> <span class="nl">Runtime:</span><span class="o">:</span><span class="nl">NativeBridgeAction:</span><span class="o">:</span><span class="n">kInitialize</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="nl">Runtime:</span><span class="o">:</span><span class="n">Current</span><span class="o">()-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">DidForkFromZygote</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">action</span><span class="o">,</span> <span class="n">isa_string</span><span class="o">.</span><span class="na">c_str</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="nl">Runtime:</span><span class="o">:</span><span class="n">Current</span><span class="o">()-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">DidForkFromZygote</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="nl">Runtime:</span><span class="o">:</span><span class="nl">NativeBridgeAction:</span><span class="o">:</span><span class="n">kUnload</span><span class="o">,</span> <span class="n">nullptr</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">thread</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">InitAfterFork</span><span class="o">()&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;;</span> <span class="n">实现在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">art</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">thread</span><span class="o">.</span><span class="na">cc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中</span><span class="err">，</span><span class="n">设置新进程主线程的线程</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">id</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">：</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">tid</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">。</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">DidForkFromZygote</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">实现在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">Runtime</span><span class="o">.</span><span class="na">cc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">void</span> <span class="nl">Runtime:</span><span class="o">:</span><span class="n">DidForkFromZygote</span><span class="o">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="o">,</span> <span class="n">NativeBridgeAction</span> <span class="n">action</span><span class="o">,</span> <span class="kd">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">isa</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="n">is_zygote_</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">switch</span> <span class="o">(</span><span class="n">action</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="k">case</span> <span class="nl">NativeBridgeAction:</span><span class="o">:</span><span class="nl">kUnload:</span>
</span><span class='line'>    <span class="n">UnloadNativeBridge</span><span class="o">();</span>
</span><span class='line'>    <span class="k">break</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="nl">NativeBridgeAction:</span><span class="o">:</span><span class="nl">kInitialize:</span>
</span><span class='line'>    <span class="n">InitializeNativeBridge</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">isa</span><span class="o">);</span>
</span><span class='line'>    <span class="k">break</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the thread pool.</span>
</span><span class='line'><span class="n">heap_</span><span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">CreateThreadPool</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">StartSignalCatcher</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start the JDWP thread. If the command-line debugger flags specified &quot;suspend=y&quot;,</span>
</span><span class='line'><span class="c1">// this will pause the runtime, so we probably want this to come last.</span>
</span><span class='line'><span class="nl">Dbg:</span><span class="o">:</span><span class="n">StartJdwp</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">首先根据</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">action</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">参数来卸载或转载用于跨平台桥接用的库</span><span class="err">。</span><span class="n">然后启动</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">gc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">堆的线程池</span><span class="err">。</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">StartSignalCatcher</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">设置信号处理</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">handler</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">，</span><span class="n">其代码在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">signal_catcher</span><span class="o">.</span><span class="na">cc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="err">####</span> <span class="n">ZygoteHooks</span><span class="o">.</span><span class="na">postForkCommon</span>
</span><span class='line'><span class="n">后置处理</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">ZygoteHooks</span><span class="o">.</span><span class="na">postForkCommon</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">postForkCommon</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="n">Daemons</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">postForkCommon</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">转调</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">Daemons</span><span class="o">.</span><span class="na">start</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="err">，</span><span class="n">以初始化虚拟机中引用队列</span><span class="err">、</span><span class="n">终接器以及</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">gc</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">的守护线程</span><span class="err">。</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="n">ReferenceQueueDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="n">FinalizerDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="n">FinalizerWatchdogDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="n">HeapTrimmerDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="n">GCDaemon</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="err">###</span> <span class="n">forkAndSpecialize</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">方法</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkAndSpecialize</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
</span><span class='line'>  <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">fdsToClose</span><span class="o">,</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">String</span> <span class="n">appDataDir</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span><span class='line'><span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">preFork</span><span class="o">();</span>
</span><span class='line'><span class="n">checkTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&quot;Zygote.preFork&quot;</span><span class="o">);</span>
</span><span class='line'><span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkAndSpecialize</span><span class="o">(</span>
</span><span class='line'>          <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">niceName</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span>
</span><span class='line'>          <span class="n">instructionSet</span><span class="o">,</span> <span class="n">appDataDir</span><span class="o">);</span>
</span><span class='line'><span class="n">checkTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&quot;Zygote.nativeForkAndSpecialize&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">VM_HOOKS</span><span class="o">.</span><span class="na">postForkCommon</span><span class="o">();</span>
</span><span class='line'><span class="n">checkTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&quot;Zygote.postForkCommon&quot;</span><span class="o">);</span>
</span><span class='line'><span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">前置处理与后置处理与</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">forkSystemServer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中一样的</span><span class="err">，</span><span class="n">这里就跳过不讲了</span><span class="err">。</span><span class="n">本地方法</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">nativeForkAndSpecialize</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">实现在</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span><span class="n">framework</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">jni</span><span class="o">/</span><span class="n">com_android_internal_os_Zygote</span><span class="o">.</span><span class="na">cpp</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">中</span><span class="err">：</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kd">static</span> <span class="n">jint</span> <span class="nf">com_android_internal_os_Zygote_nativeForkAndSpecialize</span><span class="o">(</span>
</span><span class='line'>    <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="o">,</span> <span class="n">jclass</span><span class="o">,</span> <span class="n">jint</span> <span class="n">uid</span><span class="o">,</span> <span class="n">jint</span> <span class="n">gid</span><span class="o">,</span> <span class="n">jintArray</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>    <span class="n">jint</span> <span class="n">debug_flags</span><span class="o">,</span> <span class="n">jobjectArray</span> <span class="n">rlimits</span><span class="o">,</span>
</span><span class='line'>    <span class="n">jint</span> <span class="n">mount_external</span><span class="o">,</span> <span class="n">jstring</span> <span class="n">se_info</span><span class="o">,</span> <span class="n">jstring</span> <span class="n">se_name</span><span class="o">,</span>
</span><span class='line'>    <span class="n">jintArray</span> <span class="n">fdsToClose</span><span class="o">,</span> <span class="n">jstring</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">jstring</span> <span class="n">appDataDir</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="c1">// Grant CAP_WAKE_ALARM to the Bluetooth process.</span>
</span><span class='line'><span class="n">jlong</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">uid</span> <span class="o">==</span> <span class="n">AID_BLUETOOTH</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">capabilities</span> <span class="o">|=</span> <span class="o">(</span><span class="mi">1L</span><span class="n">L</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">CAP_WAKE_ALARM</span><span class="o">);</span>
</span><span class='line'><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">return</span> <span class="nf">ForkAndSpecializeCommon</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debug_flags</span><span class="o">,</span>
</span><span class='line'>    <span class="n">rlimits</span><span class="o">,</span> <span class="n">capabilities</span><span class="o">,</span> <span class="n">capabilities</span><span class="o">,</span> <span class="n">mount_external</span><span class="o">,</span> <span class="n">se_info</span><span class="o">,</span>
</span><span class='line'>    <span class="n">se_name</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">appDataDir</span><span class="o">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>这个函数与 <code>com_android_internal_os_Zygote_nativeForkSystemServer</code> 非常类似，只不过少了一个确保子进程创建成功的步骤。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android多线程分析之五：使用AsyncTask异步下载图像]]></title>
    <link href="http://luozhaohui.github.io/blog/2014/07/19/android-thread-tutoria05/"/>
    <updated>2014-07-19T21:12:40+08:00</updated>
    <id>http://luozhaohui.github.io/blog/2014/07/19/android-thread-tutoria05</id>
    <content type="html"><![CDATA[<h2>引言</h2>

<p>在本系列文章的第一篇<a href="https://luozhaohui.github.io/blog/2014/07/08/android-thread-tutoria01/">Android多线程分析之一：使用Thread异步下载图像</a>中，曾演示了如何使用 <code>Thread</code> 来完成异步任务。<code>Android</code> 为了简化在 <code>UI</code> 线程中完成异步任务（毕竟 <code>UI</code> 线程是 <code>app</code> 最重要的线程），实现了一个名为 <code>AysncTask</code> 的模板类。使用 <code>AysncTask</code> 能够在异步任务进行的同时，将任务进度状态反馈给 <code>UI</code> 线程（如让 <code>UI</code> 线程更新进度条）。正是由于它与 <code>UI</code> 线程紧密相关，使用的时候要就有一些限制，<code>AysncTask</code> 必须在 <code>UI</code> 线程中创建，并在 <code>UI</code> 线程中启动（通过调用其 <code>execute()</code> 方法）；此外，<code>AysncTask</code> 设计的目的是用于一些耗时较短的任务，如果是耗时较长的任务不推荐使用 <code>AysncTask</code>。</p>

<p>可以用简化记忆 “三参数，四步骤” 来学习 <code>AysncTask</code>。 即带有三个模板参数 <code>Params</code>, <code>Progress</code>, <code>Result</code>，四个处理步骤：<code>onPreExecute</code>，<code>doInBackground</code>，<code>onProgressUpdate</code>，<code>onPostExecute</code>。</p>

<!--more-->


<h2>简介</h2>

<h2>三参数</h2>

<blockquote><p><code>Params</code> 是异步任务所需的参数类型，也即 <code>doInBackground(Params&hellip; params)</code> 方法的参数类型；<br/>
<code>Progress</code> 是指进度的参数类型，也即 <code>onProgressUpdate(Progress&hellip; values)</code> 方法的参数类型；<br/>
<code>Result</code> 是指任务完成返回的参数类型，也即 <code>onPostExecute(Result result)</code> 或 <code>onCancelled(Result result)</code> 方法的参数类型。</p></blockquote>

<p>如果某一个参数类型没有意义或没有被用到，传递 <code>void</code> 即可。</p>

<h3>四步骤</h3>

<blockquote><p><code>protected void onPreExecute()</code>：在 <code>UI</code> 线程中运行，在异步任务开始之前被执行，以便 <code>UI</code> 线程完成一些初始化动作，如将进度条清零；<br/>
<code>protected abstract Result doInBackground(Params&hellip; params)</code>：在后台线程中运行，这是完成异步任务的地方，它是抽象接口，子类必须提供实现；<br/>
<code>protected void onProgressUpdate(Progress&hellip; values)</code>：在 <code>UI</code> 线程中运行，在异步任务执行的过程中可以通过调用 <code>void publishProgress(Progress&hellip; values)</code> 方法通知 <code>UI</code> 线程在 <code>onProgressUpdate</code> 方法内更新进度状态；<br/>
<code>protected void onPostExecute(Result result)</code>：在 <code>UI</code> 线程中运行，当异步任务完成之后被执行，以便 <code>UI</code> 线程更新任务完成状态。</p></blockquote>

<p><code>AysncTask</code> 支持取消异步任务，当异步任务被取消之后，上面的步骤四就不会被执行了，取而代之将执行 <code>onCancelled(Result result)</code>，以便 <code>UI</code> 线程更新任务被取消之后的状态。谨记：上面提到的这些方法都是回调函数，不需要用户手动去调用。</p>

<p>以前的 <code>AysncTask</code> 是基于单一后台线程实现的，而从 <code>Android 3.0</code> 起 <code>AysncTask</code> 是基于 <code>Android</code> 的并发库（<code>java.util.concurrent</code>）实现的，本文中不会展开讨论其具体实现，只是演示如何使用 <code>AysncTask。</p>

<h2>使用示例</h2>

<p>有了前面的轮廓介绍，再来使用 <code>AysncTask</code> 是非常容易的，下面的例子与<a href="https://luozhaohui.github.io/blog/2014/07/08/android-thread-tutoria01/">Android多线程分析之一：使用Thread异步下载图像</a>中的例子非常相似，只不过是使用 <code>AysncTask</code> 来完成异步任务罢了。</p>

<h2>权限</h2>

<p>这是一个使用 <code>AysncTask</code> 从网络上异步下载图片并在 <code>ImageView</code> 中显示的的简单示例。因为需要访问网络，所以要在 <code>manifest.xml</code> 中添加网络访问权限：
<code>xml
    &lt;uses-permission android:name="android.permission.INTERNET"&gt;
    &lt;/uses-permission&gt;
</code></p>

<h3>布局</h3>

<p>布局文件很简单，一个 <code>Button</code>，一个 <code>ImageView</code>：</p>

<pre><code class="xml">&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="10dip" &gt;

    &lt;Button
        android:id="@+id/LoadButton"
        android:layout_width="fill_parent"
        android:layout_height="wrap_content"
        android:text="Load"&gt;
    &lt;/Button&gt;

    &lt;ImageView
        android:id="@+id/ImageVivew" 
        android:layout_width="match_parent" 
        android:layout_height="400dip" 
        android:scaleType="centerInside" 
        android:padding="2dp"&gt;
    &lt;/ImageView&gt; 

&lt;/LinearLayout&gt;
</code></pre>

<h3>代码：</h3>

<p>首先来看定义：图片的 <code>url</code> 路径，两个消息值以及一些控件：</p>

<pre><code class="java">    private static final String sImageUrl = "http://fashion.qqread.com/ArtImage/20110225/0083_13.jpg";
    private Button mLoadButton;
    private ImageView mImageView;
</code></pre>

<p>然后来看控件的设置：</p>

<pre><code class="java">    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        Log.i("UI thread", " &gt;&gt; onCreate()");

        mImageView = (ImageView)this.findViewById(R.id.ImageVivew);

        mLoadButton = (Button)this.findViewById(R.id.LoadButton);
        mLoadButton.setOnClickListener(new View.OnClickListener() {
            @Override 
            public void onClick(View v) {
                LoadImageTask task = new LoadImageTask(v.getContext());
                task.execute(sImageUrl);
            }
        });
    }
</code></pre>

<p><code>LoadImageTask</code> 继承自 <code>AysncTask</code>，由这个类去完成异步图片下载任务，并相应地更新 <code>UI</code> 状态。</p>

<pre><code class="java">    class LoadImageTask extends AsyncTask&lt;String, Integer, Bitmap&gt; 
    {
        private ProgressDialog mProgressBar;

        LoadImageTask(Context context)
        {
            mProgressBar = new ProgressDialog(context);
            mProgressBar.setCancelable(true);
            mProgressBar.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);
            mProgressBar.setMax(100);
        }

        @Override
        protected Bitmap doInBackground(String... params) {
            Log.i("Load thread", " &gt;&gt; doInBackground()");

            Bitmap bitmap = null;

            try{
                publishProgress(10);
                Thread.sleep(1000);

                InputStream in = new java.net.URL(sImageUrl).openStream();
                publishProgress(60);
                Thread.sleep(1000);

                bitmap = BitmapFactory.decodeStream(in);
                in.close();
            } catch (Exception e) {
                e.printStackTrace();
            }

            publishProgress(100);
            return bitmap;
        }

        @Override
        protected void onCancelled() {
            super.onCancelled();
        }

        @Override
        protected void onPreExecute() {

            mProgressBar.setProgress(0);
            mProgressBar.setMessage("Image downloading ... %0");
            mProgressBar.show();

            Log.i("UI thread", " &gt;&gt; onPreExecute()");
        }

        @Override
        protected void onPostExecute(Bitmap result) {
            Log.i("UI thread", " &gt;&gt; onPostExecute()");
            if (result != null) {
                mProgressBar.setMessage("Image downloading success!");
                mImageView.setImageBitmap(result);
            }
            else {
                mProgressBar.setMessage("Image downloading failure!");
            }

            mProgressBar.dismiss(); 
        }

       @Override
        protected void onProgressUpdate(Integer... values) {
           Log.i("UI thread", " &gt;&gt; onProgressUpdate() %" + values[0]);
           mProgressBar.setMessage("Image downloading ... %" + values[0]);
           mProgressBar.setProgress(values[0]);
        }
    };
</code></pre>

<p>在 <code>LoadImageTask 中，前面提到的四个步骤都涉及到了：</p>

<p>首先在任务开始之前在 <code>onPreExecute()</code> 方法中设置进度条的初始状态（<code>UI</code>线程）；然后在下载线程中执行 <code>doInBackground()</code> 以完成下载任务，并在其中调用 <code>publishProgress()</code> 来通知 <code>UI</code> 线程更新进度状态；<code>UI</code> 线程在 <code>onProgressUpdate()</code> 中得知进度，并更新进度条（<code>UI线程</code>）；最后下载任务完成，<code>UI</code> 线程在 <code>onPostExecute()</code>中得知下载好的图像，并更新<code>UI</code>显示该图像（<code>UI</code>线程）。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android多线程分析之四：MessageQueue的实现]]></title>
    <link href="http://luozhaohui.github.io/blog/2014/07/12/android-thread-tutoria04/"/>
    <updated>2014-07-12T20:53:20+08:00</updated>
    <id>http://luozhaohui.github.io/blog/2014/07/12/android-thread-tutoria04</id>
    <content type="html"><![CDATA[<h2>引言</h2>

<p>在前面两篇文章<a href="https://luozhaohui.github.io/blog/2014/07/10/android-thread-tutoria02/">Android多线程分析之二：Thread的实现</a>，<a href="https://luozhaohui.github.io/blog/2014/07/12/android-thread-tutoria03/">Android多线程分析之三：Handler，Looper的实现</a>中分别介绍了 <code>Thread</code> 的创建，运行，销毁的过程以及 <code>Thread</code>与 <code>Handler</code>，<code>Looper</code> 之间的关联：<code>Thread</code> 在其 <code>run()</code> 方法中创建和运行消息处理循环 <code>Looper</code>，而 <code>Looper::loop()</code> 方法不断地从 <code>MessageQueue</code> 中获取消息，并由 <code>Handler</code> 分发处理该消息。接下来就来介绍 <code>MessageQueue</code> 的运作机制。</p>

<h2>参考源码：</h2>

<pre><code>android/framework/base/core/java/android/os/MessageQueue.java
android/framework/base/core/java/android/os/Message.java
android/frameworks/base/core/jni/android_os_MessageQueue.h
android/frameworks/base/core/jni/android_os_MessageQueue.cpp
</code></pre>

<!--more-->


<h2>构造函数及成员变量</h2>

<p>先来看 <code>MessageQueue</code> 的构造函数以及重要的成员变量：</p>

<pre><code class="java">    // True if the message queue can be quit.
    private final boolean mQuitAllowed;
    private int mPtr; // used by native code
    Message mMessages;
    private boolean mQuiting;
    // Indicates whether next() is blocked waiting in pollOnce() with a non-zero timeout.
    private boolean mBlocked;
</code></pre>

<p><code>mQuitAllowed</code>: 其含义与 <code>Looper.prepare(boolean quitAllowed)</code> 中参数含义一直，是否允许中止；
<code>mPtr</code>：<code>Android MessageQueue</code> 是通过调用 <code>C++ native MessageQueue</code> 实现的，这个 <code>mPtr</code> 就是指向 <code>native MessageQueue</code>；
<code>mMessages</code>：<code>Message</code> 是链表结构的，因此这个变量就代表 <code>Message</code> 链表；
<code>mQuiting</code>：是否终止了；
<code>mBlocked</code>：是否正在等待被激活以获取消息；</p>

<p><code>MessageQueue</code> 的构造函数很简单：</p>

<pre><code class="java">    MessageQueue(boolean quitAllowed) {
        mQuitAllowed = quitAllowed;
        nativeInit();
    }
</code></pre>

<p>它通过转调 <code>native</code> 方法 <code>nativeInit()</code> 实现的，后者是定义在 <code>android_os_MessageQueue.cpp</code>中：</p>

<pre><code class="cpp">static void android_os_MessageQueue_nativeInit(JNIEnv* env, jobject obj) {
    NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue();
    if (!nativeMessageQueue) {
        jniThrowRuntimeException(env, "Unable to allocate native queue");
        return;
    }

    nativeMessageQueue-&gt;incStrong(env);
    android_os_MessageQueue_setNativeMessageQueue(env, obj, nativeMessageQueue);
}
static void android_os_MessageQueue_setNativeMessageQueue(JNIEnv* env, jobject messageQueueObj,
        NativeMessageQueue* nativeMessageQueue) {
    env-&gt;SetIntField(messageQueueObj, gMessageQueueClassInfo.mPtr,
             reinterpret_cast&lt;jint&gt;(nativeMessageQueue));
}
</code></pre>

<p><code>nativeInit()</code> 方法创建 <code>NativeMessageQueue</code> 对象，并将这个对象的指针复制给 <code>Android MessageQueue</code> 的 <code>mPtr</code>。<code>NativeMessageQueue</code> 的定义如下：</p>

<pre><code class="java">class MessageQueue : public RefBase {
public:
    /* Gets the message queue's looper. */
    inline sp&lt;Looper&gt; getLooper() const {
        return mLooper;
    }

    bool raiseAndClearException(JNIEnv* env, const char* msg);
    virtual void raiseException(JNIEnv* env, const char* msg, jthrowable exceptionObj) = 0;
protected:
    MessageQueue();
    virtual ~MessageQueue();
protected:
    sp&lt;Looper&gt; mLooper;
};

class NativeMessageQueue : public MessageQueue {
public:
    NativeMessageQueue();
    virtual ~NativeMessageQueue();
    virtual void raiseException(JNIEnv* env, const char* msg, jthrowable exceptionObj);
    void pollOnce(JNIEnv* env, int timeoutMillis);
    void wake();

private:
    bool mInCallback;
    jthrowable mExceptionObj;
};
</code></pre>

<h2>消息同步</h2>

<p>其中值得关注的是 <code>NativeMessageQueue</code> 的构造以及<code>pollOnce</code>，<code>wake</code> 两个方法，它们是<code>Java MessageQueue</code> 中 <code>nativePollOnce</code> 和 <code>nativeWake</code> 的 <code>native</code> 方法：</p>

<pre><code class="cpp">NativeMessageQueue::NativeMessageQueue() : mInCallback(false), mExceptionObj(NULL) {
    mLooper = Looper::getForThread();
    if (mLooper == NULL) {
        mLooper = new Looper(false);
        Looper::setForThread(mLooper);
    }
}

void NativeMessageQueue::pollOnce(JNIEnv* env, int timeoutMillis) {
    mInCallback = true;
    mLooper-&gt;pollOnce(timeoutMillis);
    mInCallback = false;
}

void NativeMessageQueue::wake() {
    mLooper-&gt;wake();
}
</code></pre>

<p>在 <code>NativeMessageQueue</code> 的构造函数中，会获取当前线程的 <code>Looper</code>(注意这是 <code>C++ Looper</code>,定义在<code>frameworks/native/libs/utils/Looper.h</code> 中)，如果当前线程还没有 <code>Looper</code>，就创建一个，并保存在线程的 <code>TLS</code> 中。<code>pollOnce</code> 和 <code>wake</code> 最终都是通过 <code>Linux</code> 的 <code>epoll</code> 模型来实现的。<code>pollOnce()</code> 通过等待被激活，然后从消息队列中获取消息；<code>wake()</code> 则是激活处于等待状态的消息队列，通知它有消息到达了。这是典型的生产者-消费者模型。</p>

<p>对于<code>Android MessageQueue</code> 来说，其主要的工作就是：接收投递进来的消息，获取下一个需要处理的消息。这两个功能是通过 <code>enqueueMessage()</code> 和 <code>next()</code> 方法实现的。<code>next()</code> 在前一篇文章介绍 <code>Looper.loop()</code> 时提到过。</p>

<h2>Message</h2>

<p>在分析这两个函数之前，先来介绍一下 <code>Message</code>：前面说过 <code>Message</code> 是完备的，即它同时带有消息内容和处理消息的 <code>Handler</code> 或 <code>callback</code>。下面列出它的主要成员变量：</p>

<pre><code class="cpp">public int what;     // 消息 id
public int arg1;     // 消息参数
public int arg2;     // 消息参数
public Object obj;   // 消息参数
long when;           // 处理延迟时间，由 Handler 的 sendMessageDelayed/postDelayed 设置
Handler target;    // 处理消息的 Handler
Runnable callback;   // 处理消息的回调
Message next;    // 链表结构，指向下一个消息
</code></pre>

<p><code>Message</code> 有一些名为 <code>obtain</code> 的静态方法用于创建 <code>Message</code>，通常我们都是通过 <code>Handler</code> 的 <code>obtain</code> 静态方法转调 <code>Message</code> 的静态方法来创建新的 <code>Message</code>。</p>

<p>接下来分析 <code>enqueueMessage()</code>enqueueMessage：
``` java
    final boolean enqueueMessage(Message msg, long when) {
        if (msg.isInUse()) {
            throw new AndroidRuntimeException(msg + &ldquo; This message is already in use.&rdquo;);
        }
        if (msg.target == null) {
            throw new AndroidRuntimeException(&ldquo;Message must have a target.&rdquo;);
        }</p>

<pre><code>    boolean needWake;
    synchronized (this) {
        if (mQuiting) {
            return false;
        }

        msg.when = when;
        Message p = mMessages;
        if (p == null || when == 0 || when &lt; p.when) {
            // New head, wake up the event queue if blocked.
            msg.next = p;
            mMessages = msg;
            needWake = mBlocked;
        } else {
            // Inserted within the middle of the queue.  Usually we don't have to wake
            // up the event queue unless there is a barrier at the head of the queue
            // and the message is the earliest asynchronous message in the queue.
            needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous();
            Message prev;
            for (;;) {
                prev = p;
                p = p.next;
                if (p == null || when &lt; p.when) {
                    break;
                }
                if (needWake &amp;&amp; p.isAsynchronous()) {
                    needWake = false;
                }
            }
            msg.next = p; // invariant: p == prev.next
            prev.next = msg;
        }
    }
    if (needWake) {
        nativeWake(mPtr);
    }
    return true;
}
</code></pre>

<pre><code>
首先检测消息的合法性：是否已经在处理中和是否有处理它的 &lt;code&gt;Handler&lt;/code&gt;，然后判断 &lt;code&gt;mQuiting&lt;/code&gt; 是否中止了，如果没有则根据消息处理时间排序将消息插入链表中的合适位置。在这其中作了一些减少同步操作的优化，即使当前消息队列已经处于 &lt;code&gt;Blocked&lt;/code&gt; 状态，且队首是一个消息屏障(和内存屏障的理念一样，这里是通过 &lt;code&gt;p.target == null&lt;/code&gt; 来判断队首是否是消息屏障)，并且要插入的消息是所有异步消息中最早要处理的才会 &lt;code&gt;needwake&lt;/code&gt; 激活消息队列去获取下一个消息。&lt;code&gt;Handler&lt;/code&gt; 的 &lt;code&gt;post/sendMessage&lt;/code&gt; 系列方法最后都是通过转调 &lt;code&gt;MessageQueue&lt;/code&gt; 的 &lt;code&gt;enqueueMessage&lt;/code&gt; 来实现的，比如：
</code></pre>

<pre><code>public boolean sendMessageAtTime(Message msg, long uptimeMillis) {
    MessageQueue queue = mQueue;
    if (queue == null) {
        RuntimeException e = new RuntimeException(
                this + " sendMessageAtTime() called with no mQueue");
        Log.w("Looper", e.getMessage(), e);
        return false;
    }
    return enqueueMessage(queue, msg, uptimeMillis);
}

private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) {
    msg.target = this;
    if (mAsynchronous) {
        msg.setAsynchronous(true);
    }
    return queue.enqueueMessage(msg, uptimeMillis);
}
</code></pre>

<pre><code>
其实 &lt;code&gt;Handler&lt;/code&gt; 中与 &lt;code&gt;Message&lt;/code&gt; 相关的静态方法都是通过 &lt;code&gt;MessageQueue&lt;/code&gt; 的对应的静态方法实现的，比如 &lt;code&gt;removeMessages&lt;/code&gt;, &lt;code&gt;hasMessages&lt;/code&gt;, &lt;code&gt;hasCallbacks&lt;/code&gt; 等等，这里就不一一详述了。至此，已经完整地分析了如何通过 &lt;code&gt;Handler&lt;/code&gt; 提交消息到 &lt;code&gt;MessageQueue&lt;/code&gt; 中了。

## 获取消息
下面来分析如何从 &lt;code&gt;MessageQueue&lt;/code&gt; 中获取合适的消息, 这是 &lt;code&gt;next()&lt;/code&gt; 要做的最主要的事情，&lt;code&gt;next()&lt;/code&gt; 方法还做了其他一些事情，这些其它事情是为了提高系统效果，利用消息队列在空闲时通过 &lt;code&gt;idle handler&lt;/code&gt; 做一些事情，比如 &lt;code&gt;gc&lt;/code&gt; 等等。但它们和获取消息关系不大，所以这部分将从略介绍。
</code></pre>

<p>   final Message next() {
        int pendingIdleHandlerCount = -1; // -1 only during first iteration
        int nextPollTimeoutMillis = 0;</p>

<pre><code>    for (;;) {
        if (nextPollTimeoutMillis != 0) {
            Binder.flushPendingCommands();
        }
        nativePollOnce(mPtr, nextPollTimeoutMillis);

        synchronized (this) {
            if (mQuiting) {
                return null;
            }

            // Try to retrieve the next message.  Return if found.
            final long now = SystemClock.uptimeMillis();
            Message prevMsg = null;
            Message msg = mMessages;
            if (msg != null &amp;&amp; msg.target == null) {
                // Stalled by a barrier.  Find the next asynchronous message in the queue.
                do {
                    prevMsg = msg;
                    msg = msg.next;
                } while (msg != null &amp;&amp; !msg.isAsynchronous());
            }
            if (msg != null) {
                if (now &lt; msg.when) {
                    // Next message is not ready.  Set a timeout to wake up when it is ready.
                    nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);
                } else {
                    // Got a message.
                    mBlocked = false;
                    if (prevMsg != null) {
                        prevMsg.next = msg.next;
                    } else {
                        mMessages = msg.next;
                    }
                    msg.next = null;
                    if (false) Log.v("MessageQueue", "Returning message: " + msg);
                    msg.markInUse();
                    return msg;
                }
            } else {
                // No more messages.
                nextPollTimeoutMillis = -1;
            }

            // If first time idle, then get the number of idlers to run.
            // Idle handles only run if the queue is empty or if the first message
            // in the queue (possibly a barrier) is due to be handled in the future.
            if (pendingIdleHandlerCount &lt; 0
                    &amp;&amp; (mMessages == null || now &lt; mMessages.when)) {
                pendingIdleHandlerCount = mIdleHandlers.size();
            }
            if (pendingIdleHandlerCount &lt;= 0) {
                // No idle handlers to run.  Loop and wait some more.
                mBlocked = true;
                continue;
            }

            if (mPendingIdleHandlers == null) {
                mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)];
            }
            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);
        }

        // Run the idle handlers.
        // We only ever reach this code block during the first iteration.
        for (int i = 0; i &lt; pendingIdleHandlerCount; i++) {
            final IdleHandler idler = mPendingIdleHandlers[i];
            mPendingIdleHandlers[i] = null; // release the reference to the handler

            boolean keep = false;
            try {
                keep = idler.queueIdle();
            } catch (Throwable t) {
                Log.wtf("MessageQueue", "IdleHandler threw exception", t);
            }

            if (!keep) {
                synchronized (this) {
                    mIdleHandlers.remove(idler);
                }
            }
        }

        // Reset the idle handler count to 0 so we do not run them again.
        pendingIdleHandlerCount = 0;

        // While calling an idle handler, a new message could have been delivered
        // so go back and look again for a pending message without waiting.
        nextPollTimeoutMillis = 0;
    }
}
</code></pre>

<pre><code>
队列被激活之后，首先判断队首是不是消息屏障，如果是则跳过所有的同步消息，查找最先要处理的异步消息。如果第一个待处理的消息还没有到要处理的时机则设置激活等待时间；否则这个消息就是需要处理的消息，将该消息设置为 &lt;code&gt;inuse&lt;/code&gt;，并将队列设置为非  &lt;code&gt;blocked&lt;/code&gt; 状态，然后返回该消息。&lt;code&gt;next()&lt;/code&gt; 方法是在  &lt;code&gt;Looper.loop()&lt;/code&gt; 中被调用的，&lt;code&gt;Looper&lt;/code&gt; 在获得要处理的消息之后就会调用和消息关联的 &lt;code&gt;Handler&lt;/code&gt; 来分发消息，这里再回顾一下：
</code></pre>

<p>  public static void loop() {
        final Looper me = myLooper();
        if (me == null) {
            throw new RuntimeException(&ldquo;No Looper; Looper.prepare() wasn&rsquo;t called on this thread.&rdquo;);
        }
        final MessageQueue queue = me.mQueue;
        &hellip;
        for (;;) {
            Message msg = queue.next(); // might block
            if (msg == null) {
                // No message indicates that the message queue is quitting.
                return;
            }</p>

<pre><code>        msg.target.dispatchMessage(msg);

        msg.recycle();
    }
}
</code></pre>

<p>```</p>

<p>如果队列中没有消息或者第一个待处理的消息时机未到，且也没有其他利用队列空闲要处理的事务，则将队列设置为设置 <code>blocked</code> 状态，进入等待状态；否则就利用队列空闲处理其它事务。</p>

<p>至此，已经对 <code>Android</code> 多线程相关的主要概念 <code>Thread</code>, <code>HandlerThread</code>, <code>Handler</code>, <code>Looper</code>, <code>Message</code>, <code>MessageQueue</code> 作了一番介绍，下一篇就要讲讲 <code>AsyncTask</code>，这是为了简化 <code>UI</code> 多线程编程为提供的一个便利工具类。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android多线程分析之三：Handler，Looper的实现]]></title>
    <link href="http://luozhaohui.github.io/blog/2014/07/12/android-thread-tutoria03/"/>
    <updated>2014-07-12T20:53:20+08:00</updated>
    <id>http://luozhaohui.github.io/blog/2014/07/12/android-thread-tutoria03</id>
    <content type="html"><![CDATA[<h2>引言</h2>

<p>在前文<a href="https://luozhaohui.github.io/blog/2014/07/10/android-thread-tutoria02/">Android多线程分析之二：Thread的实现</a>中已经详细分析了<code>Android Thread</code> 是如何创建，运行以及销毁的，其重点是对相应 <code>native</code> 方法进行分析，今天我将聚焦于 <code>Android Framework</code> 层多线程相关的类：<code>Handler</code>, <code>Looper</code>, <code>MessageQueue</code>, <code>Message</code> 以及它们与<code>Thread</code> 之间的关系。可以用一个不太妥当的比喻来形容它们之间的关联：如果把 <code>Thread</code> 比作生产车间，那么 <code>Looper</code> 就是放在这车间里的生产线，这条生产线源源不断地从 <code>MessageQueue</code> 中获取材料 <code>Messsage</code>，并分发处理 <code>Message</code> (由于 <code>Message</code> 通常是完备的，所以 <code>Looper</code> 大多数情况下只是调度让 <code>Message</code> 的 <code>Handler</code> 去处理 <code>Message</code>)。正是因为消息需要在 <code>Looper</code> 中处理，而 <code>Looper</code> 又需运行在 <code>Thread</code> 中，所以不能随随便便在非 <code>UI</code> 线程中进行 <code>UI</code> 操作。 <code>UI</code> 操作通常会通过投递消息来实现，只有往正确的 <code>Looper</code> 投递消息才能得到处理，对于 <code>UI</code> 来说，这个 <code>Looper</code> 一定是运行在 <code>UI</code> 线程中。</p>

<!--more-->


<h2>示例</h2>

<p>在编写 <code>app</code> 的过程中，我们常常会这样来使用 <code>Handler</code>：</p>

<pre><code class="java">Handler mHandler = new Handler();
mHandler.post(new Runnable(){
    @Override
    public void run() {
        // do somework
    }
});
</code></pre>

<p>或者如这系列文章<a href="https://luozhaohui.github.io/blog/2014/07/08/android-thread-tutoria01/">Android多线程分析之一：使用Thread异步下载图像</a>中的示例那样：</p>

<pre><code class="java">    private Handler mHandler= new Handler(){
        @Override
        public void handleMessage(Message msg) {
            Log.i("UI thread", " &gt;&gt; handleMessage()");

            switch(msg.what){
            case MSG_LOAD_SUCCESS:
                Bitmap bitmap = (Bitmap) msg.obj;
                mImageView.setImageBitmap(bitmap);

                mProgressBar.setProgress(100);
                mProgressBar.setMessage("Image downloading success!");
                mProgressBar.dismiss();
                break;

            case MSG_LOAD_FAILURE:
                mProgressBar.setMessage("Image downloading failure!");
                mProgressBar.dismiss();
                break;
            }
        }
    };

    Message msg = mHandler.obtainMessage(MSG_LOAD_FAILURE, null);
    mHandler.sendMessage(msg);
</code></pre>

<h2>Handler</h2>

<p>那么，在 <code>Handler</code> 的 <code>post/sendMessage</code> 背后到底发生了什么事情呢？下面就来解开这个谜团。
首先我们从 <code>Handler</code> 的构造函数开始分析：</p>

<pre><code class="java">    final MessageQueue mQueue; 
    final Looper mLooper; 
    final Callback mCallback; 
    final boolean mAsynchronous;

    public Handler(Looper looper, Callback callback, boolean async) {
        mLooper = looper;
        mQueue = looper.mQueue;
        mCallback = callback;
        mAsynchronous = async;
    }

    public Handler(Callback callback, boolean async) {
        mLooper = Looper.myLooper();
        if (mLooper == null) {
            throw new RuntimeException(
                "Can't create handler inside thread that has not called Looper.prepare()");
        }
        mQueue = mLooper.mQueue;
        mCallback = callback;
        mAsynchronous = async;
    }

    public Handler() {
        this(null, false);
    }
</code></pre>

<p>上面列出了 <code>Handler</code> 的一些成员变量：</p>

<blockquote><p><code>mLooper</code>：线程的消息处理循环，注意：并非每一个线程都有消息处理循环，因此 <code>Framework</code> 中线程可以分为两种：有 <code>Looper</code> 的和无 <code>Looper</code> 的。为了方便 <code>app</code> 开发，<code>Framework</code> 提供了一个有 <code>Looper</code> 的 <code>Thread</code> 实现：<code>HandlerThread</code>。在前一篇<a href="https://luozhaohui.github.io/blog/2014/07/10/android-thread-tutoria02/">Android多线程分析之二：Thread的实现</a>中也提到了两种不同 <code>Thread</code> 的 <code>run()</code> 方法的区别。</p></blockquote>

<pre><code class="java">/**
 * Handy class for starting a new thread that has a looper. The looper can then be 
 * used to create handler classes. Note that start() must still be called.
 */
public class HandlerThread extends Thread {
    Looper mLooper;
    /**
     * Call back method that can be explicitly overridden if needed to execute some
     * setup before Looper loops.
     */
    protected void onLooperPrepared() {
    }

    public void run() {
        mTid = Process.myTid();
        Looper.prepare();
        synchronized (this) {
            mLooper = Looper.myLooper();
            notifyAll();
        }
        Process.setThreadPriority(mPriority);
        onLooperPrepared();
        Looper.loop();
        mTid = -1;
    }

    /**
     * This method returns the Looper associated with this thread. If this thread not been started
     * or for any reason is isAlive() returns false, this method will return null. If this thread 
     * has been started, this method will block until the looper has been initialized.  
     * @return The looper.
     */
    public Looper getLooper() {
        if (!isAlive()) {
            return null;
        }

        // If the thread has been started, wait until the looper has been created.
        synchronized (this) {
            while (isAlive() &amp;&amp; mLooper == null) {
                try {
                    wait();
                } catch (InterruptedException e) {
                }
            }
        }
        return mLooper;
    }
}
</code></pre>

<h2>Looper</h2>

<p>这个 <code>HandlerThread</code> 与 <code>Thread</code> 相比，多了一个类型为 <code>Looper</code> 成员变量 <code>mLooper</code>，它是在 <code>run()</code> 函数中由 <code>Looper::prepare()</code> 创建的，并保存在 <code>TLS</code> 中：</p>

<pre><code class="java">/** Initialize the current thread as a looper.
      * This gives you a chance to create handlers that then reference
      * this looper, before actually starting the loop. Be sure to call
      * {@link #loop()} after calling this method, and end it by calling
      * {@link #quit()}.
      */
    public static void prepare() {
        prepare(true);
    }

    private static void prepare(boolean quitAllowed) {
        if (sThreadLocal.get() != null) {
            throw new RuntimeException("Only one Looper may be created per thread");
        }
        sThreadLocal.set(new Looper(quitAllowed));
    }
</code></pre>

<p>然后通过 <code>Looper::myLooper()</code> 获取创建的 <code>Looper</code>：</p>

<pre><code class="java">    /**
     * Return the Looper object associated with the current thread.  Returns
     * null if the calling thread is not associated with a Looper.
     */
    public static Looper myLooper() {
        return sThreadLocal.get();
    }
</code></pre>

<p>最后通过 <code>Looper::Loop()</code> 方法运行消息处理循环：从 <code>MessageQueue</code> 中取出消息，并分发处理该消息，不断地循环这个过程。这个方法将在后面介绍。</p>

<blockquote><p><code>Handler</code> 的成员变量 <code>mQueue</code> 是其成员变量 <code>mLooper</code> 的成员变量，这里只是为了简化书写，单独拿出来作为 <code>Handler</code> 的成员变量；成员变量 <code>mCallback</code> 提供了另一种使用<code>Handler</code> 的简便途径：只需实现回调接口 <code>Callback</code>，而无需子类化<code>Handler</code>，下面会讲到的：</p></blockquote>

<pre><code class="java">    /**
     * Callback interface you can use when instantiating a Handler to avoid
     * having to implement your own subclass of Handler.
     */
    public interface Callback {
        public boolean handleMessage(Message msg);
    }
</code></pre>

<p>成员变量 <code>mAsynchronous</code> 是标识是否异步处理消息，如果是的话，通过该 <code>Handler obtain</code> 得到的消息都被强制设置为异步的。
同是否有无 <code>Looper</code> 来区分 <code>Thread</code> 一样，<code>Handler</code> 的构造函数也分为自带 <code>Looper</code> 和外部 <code>Looper</code> 两大类：如果提供了 <code>Looper</code>，在消息会在该 <code>Looper</code> 中处理，否则消息就会在当前线程的 <code>Looper</code> 中处理，注意这里要确保当前线程一定有 <code>Looper</code>。所有的 <code>UI thread</code> 都是有 <code>Looper</code> 的，因为 <code>view/widget</code> 的实现中大量使用了消息，需要 <code>UI thread</code> 提供 <code>Looper</code> 来处理，可以参考<code>view.java</code>：</p>

<p>view.java
<code>java
    public boolean post(Runnable action) {
        final AttachInfo attachInfo = mAttachInfo;
        if (attachInfo != null) {
            return attachInfo.mHandler.post(action);
        }
        // Assume that post will succeed later
        ViewRootImpl.getRunQueue().post(action);
        return true;
    }
</code></p>

<p>ViewRootImpl.java</p>

<pre><code class="java">    private void performTraversals() {
        ....
        // Execute enqueued actions on every traversal in case a detached view enqueued an action
        getRunQueue().executeActions(attachInfo.mHandler);
      ...
    }

    static RunQueue getRunQueue() {
        RunQueue rq = sRunQueues.get();
        if (rq != null) {
            return rq;
        }
        rq = new RunQueue();
        sRunQueues.set(rq);
        return rq;
    }

    /**
     * The run queue is used to enqueue pending work from Views when no Handler is
     * attached.  The work is executed during the next call to performTraversals on
     * the thread.
     * @hide
     */
    static final class RunQueue {
    ...
        void executeActions(Handler handler) {
            synchronized (mActions) {
                final ArrayList&lt;HandlerAction&gt; actions = mActions;
                final int count = actions.size();

                for (int i = 0; i &lt; count; i++) {
                    final HandlerAction handlerAction = actions.get(i);
                    handler.postDelayed(handlerAction.action, handlerAction.delay);
                }

                actions.clear();
            }
        }
    }
</code></pre>

<p>从上面的代码可以看出，作为所有控件基类的 <code>view</code> 提供了 <code>post</code> 方法，用于向 <code>UI thread</code> 发送消息，并在 <code>UI thread</code> 的 <code>Looper</code> 中处理这些消息，而 <code>UI thread</code> 一定有 <code>Looper</code> 这是由 <code>ActivityThread</code> 来保证的：</p>

<pre><code class="java">public final class ActivityThread {
...
    final Looper mLooper = Looper.myLooper();
}
</code></pre>

<p><code>UI</code> 操作需要向 <code>UI</code> 线程发送消息并在其 <code>Looper</code> 中处理这些消息。这就是为什么我们不能在非 <code>UI</code> 线程中更新 <code>UI</code> 的原因，在控件在非 <code>UI</code> 线程中构造 <code>Handler</code> 时，要么由于非 <code>UI</code> 线程没有 <code>Looper</code> 使得获取 <code>myLooper</code> 失败而抛出 <code>RunTimeException</code>，要么即便提供了 <code>Looper</code>，但这个 <code>Looper</code> 并非 <code>UI</code> 线程的 <code>Looper</code> 而不能处理控件消息。为此在 <code>ViewRootImpl</code> 中有一个强制检测 <code>UI</code> 操作是否是在 <code>UI</code> 线程中处理的方法 <code>checkThread()</code>：该方法中的 <code>mThread</code> 是在 <code>ViewRootImpl</code> 的构造函数中赋值的，它就是 <code>UI</code> 线程；该方法中的 <code>Thread.currentThread()</code> 是当前进行 <code>UI</code> 操作的线程，如果这个线程不是非 <code>UI</code> 线程就会抛出异常<code>CalledFromWrongThreadException</code>。</p>

<pre><code class="java">    void checkThread() {
        if (mThread != Thread.currentThread()) {
            throw new CalledFromWrongThreadException(
                    "Only the original thread that created a view hierarchy can touch its views.");
        }
    }
</code></pre>

<p>如果修改<a href="https://luozhaohui.github.io/blog/2014/07/08/android-thread-tutoria01/">Android多线程分析之一：使用Thread异步下载图像</a>中示例，下载完图像 <code>bitmap</code> 之后，在 <code>Thread</code> 的 <code>run()</code> 函数中设置 <code>ImageView</code> 的图像为该 <code>bitmap</code>，即会抛出上面提到的异常：</p>

<pre><code>W/dalvikvm(796): threadid=11: thread exiting with uncaught exception (group=0x40a71930)
E/AndroidRuntime(796): FATAL EXCEPTION: Thread-75
E/AndroidRuntime(796): android.view.ViewRootImpl$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views.
E/AndroidRuntime(796):  at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:4746)
E/AndroidRuntime(796):  at android.view.ViewRootImpl.requestLayout(ViewRootImpl.java:823)
E/AndroidRuntime(796):  at android.view.View.requestLayout(View.java:15473)
E/AndroidRuntime(796):  at android.view.View.requestLayout(View.java:15473)
E/AndroidRuntime(796):  at android.view.View.requestLayout(View.java:15473)
E/AndroidRuntime(796):  at android.view.View.requestLayout(View.java:15473)
E/AndroidRuntime(796):  at android.view.View.requestLayout(View.java:15473)
E/AndroidRuntime(796):  at android.widget.ImageView.setImageDrawable(ImageView.java:406)
E/AndroidRuntime(796):  at android.widget.ImageView.setImageBitmap(ImageView.java:421)
E/AndroidRuntime(796):  at com.example.thread01.MainActivity$2$1.run(MainActivity.java:80)
</code></pre>

<h2>处理消息</h2>

<p><code>Handler</code> 的构造函数暂且介绍到这里，接下来介绍：<code>handleMessage</code> 和 <code>dispatchMessage</code>：</p>

<pre><code class="java">/**
     * Subclasses must implement this to receive messages.
     */
    public void handleMessage(Message msg) {
    }

    /**
     * Handle system messages here.
     */
    public void dispatchMessage(Message msg) {
        if (msg.callback != null) {
            handleCallback(msg);
        } else {
            if (mCallback != null) {
                if (mCallback.handleMessage(msg)) {
                    return;
                }
            }
            handleMessage(msg);
        }
    }
</code></pre>

<p>前面提到有两种方式来设置处理消息的代码：一种是设置 <code>Callback</code> 回调，一种是子类化 <code>Handler</code>。而子类化 <code>Handler</code> 其子类就要实现 <code>handleMessage</code> 来处理自定义的消息，如前面的匿名子类示例一样。<code>dispatchMessage</code> 是在 <code>Looper::Loop()</code> 中被调用，即它是在线程的消息处理循环中被调用，这样就能让 <code>Handler</code> 不断地处理各种消息。在 <code>dispatchMessage</code> 的实现中可以看到，如果 <code>Message</code> 有自己的消息处理回调，那么就优先调用消息自己的消息处理回调：</p>

<pre><code class="java">    private static void handleCallback(Message message) {
        message.callback.run();
    }
</code></pre>

<p>否则看 <code>Handler</code> 是否有消息处理回调 <code>mCallback</code>，如果有且 <code>mCallback</code> 成功处理了这个消息就返回了，否则就调用 <code>handleMessage</code>（通常是子类的实现） 来处理消息。</p>

<p>在分析 <code>Looper::Loop()</code> 这个关键函数之前，先来理一理 <code>Thread，Looper，Handler，MessageQueue</code> 的关系：<code>Thread</code> 需要有 <code>Looper</code> 才能处理消息（也就是说 <code>Looper</code> 是运行在 <code>Thread</code> 中），这是通过在自定义 <code>Thread</code> 的 <code>run()</code> 函数中调用 <code>Looper::prepare()</code> 和 <code>Looper::loop()</code> 来实现，然后在 <code>Looper::loop()</code> 中不断地从 <code>MessageQueue</code> 获取由 <code>Handler</code> 投递到其中的 <code>Message</code>，并调用 <code>Message</code> 的成员变量 <code>Handler</code> 的 <code>dispatchMessage</code> 来处理消息。</p>

<p>下面先来看看 <code>Looper</code> 的构造函数：</p>

<pre><code class="java">    final MessageQueue mQueue;
    final Thread mThread;
    volatile boolean mRun;

    private Looper(boolean quitAllowed) {
        mQueue = new MessageQueue(quitAllowed);
        mRun = true;
        mThread = Thread.currentThread();
    }
</code></pre>

<p><code>Looper</code> 的构造函数很简单，创建 <code>MessageQueue</code>，保存当前线程到 <code>mThread</code> 中。但它是私有的，只能通过两个静态函数 <code>prepare()</code>/<code>prepareMainLooper()</code> 来调用，前面已经介绍了 <code>prepare()</code>,下面来介绍 <code>prepareMainLooper()</code>:</p>

<pre><code class="java">/**
     * Initialize the current thread as a looper, marking it as an
     * application's main looper. The main looper for your application
     * is created by the Android environment, so you should never need
     * to call this function yourself.  See also: {@link #prepare()}
     */
    public static void prepareMainLooper() {
        prepare(false);
        synchronized (Looper.class) {
            if (sMainLooper != null) {
                throw new IllegalStateException("The main Looper has already been prepared.");
            }
            sMainLooper = myLooper();
        }
    }
</code></pre>

<p><code>prepareMainLooper</code> 是通过调用 <code>prepare</code> 实现的，不过传入的参数为 <code>false</code>，表示 <code>main Looper</code> 不允许中途被中止，创建之后将 <code>looper</code> 保持在静态变量 <code>sMainLooper</code> 中。整个 <code>Framework</code> 框架只有两个地方调用了 <code>prepareMainLooper</code> 方法：</p>

<h3>ServerThread</h3>

<p><code>SystemServer.java</code> 中的 <code>ServerThread</code>，<code>ServerThread</code> 的重要性就不用说了，绝大部分 <code>Android Service</code> 都是这个线程中初始化的。这个线程是在 <code>Android</code> 启动过程中的 <code>init2()</code> 方法启动的：</p>

<pre><code class="java">    public static final void init2() {
        Slog.i(TAG, "Entered the Android system server!");
        Thread thr = new ServerThread();
        thr.setName("android.server.ServerThread");
        thr.start();
    }

class ServerThread extends Thread {
    @Override
    public void run() {
        ...
        Looper.prepareMainLooper();
        ...
        Looper.loop();
        Slog.d(TAG, "System ServerThread is exiting!");
    }
}
</code></pre>

<h3>ActivityThread</h3>

<p>以及 <code>ActivityThread.java</code> 的 <code>main()</code> 方法：</p>

<pre><code class="java">public static void main(String[] args) {
        ....
        Looper.prepareMainLooper();

        ActivityThread thread = new ActivityThread();
        thread.attach(false);

        if (sMainThreadHandler == null) {
            sMainThreadHandler = thread.getHandler();
        }

        AsyncTask.init();

        Looper.loop();

        throw new RuntimeException("Main thread loop unexpectedly exited");
    }
</code></pre>

<p><code>ActivityThread</code> 的重要性也不言而喻，它是 <code>Activity</code> 的主线程，也就是 <code>UI</code> 线程。注意这里的 <code>AsyncTask.init()</code>，在后面介绍 <code>AsyncTask</code> 时会详细介绍的，这里只提一下：<code>AsyncTask</code> 能够进行 <code>UI</code> 操作正是由于在这里调用了 <code>init()</code>。</p>

<h2>Looper::Loop()</h2>

<p>有了前面的铺垫，这下我们就可以来分析 <code>Looper::Loop()</code> 这个关键函数了：</p>

<pre><code class="java">/**
     * Run the message queue in this thread. Be sure to call
     * {@link #quit()} to end the loop.
     */
    public static void loop() {
        final Looper me = myLooper();
        if (me == null) {
            throw new RuntimeException("No Looper; Looper.prepare() wasn't called on this thread.");
        }
        final MessageQueue queue = me.mQueue;
        ...
        for (;;) {
            Message msg = queue.next(); // might block
            if (msg == null) {
                // No message indicates that the message queue is quitting.
                return;
            }

            msg.target.dispatchMessage(msg);

            msg.recycle();
        }
    }
</code></pre>

<p><code>loop()</code> 的实现非常简单，一如前面一再说过的那样：不断地从 <code>MessageQueue</code> 中获取消息，分发消息，回收消息。从上面的代码可以看出: <code>loop()</code> 仅仅是一个不断循环作业的生产流水线，而 <code>MessageQueue</code> 则为它提供原材料 <code>Message</code>，让它去分发处理。至于 <code>Handler</code> 是怎么提交消息到 <code>MessageQueue</code> 中，<code>MessageQueue</code> 又是怎么管理消息的，且待下文分解。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android多线程分析之二：Thread的实现]]></title>
    <link href="http://luozhaohui.github.io/blog/2014/07/10/android-thread-tutoria02/"/>
    <updated>2014-07-10T21:21:40+08:00</updated>
    <id>http://luozhaohui.github.io/blog/2014/07/10/android-thread-tutoria02</id>
    <content type="html"><![CDATA[<h2>引言</h2>

<p>在前文<a href="https://luozhaohui.github.io/blog/2014/07/08/android-thread-tutoria01/">Android多线程分析之一：使用Thread异步下载图像</a>中演示了如何使用<code>Thread</code>处理异步事务。示例中这个<code>Java Thread</code>类都是位于<code>Framework</code>层的类，它自身是通过<code>JNI</code>转调<code>dalvik</code>里面的<code>Thread</code>相关方法实现的。因此要分析<code>Andriod</code> 中的线程，就需要分析这两层中的与线程相关的代码，这就是本文要探讨的主题。本文将把<code>Framework</code>层中的<code>Java Thread</code>称为<code>Android Thread</code>，而把<code>dalvik</code>中的 <code>Thread</code>成为<code>dalvik Thread</code>。</p>

<!--more-->


<h2>源码路径</h2>

<p>本文涉及到的 <code>Android</code> 源码路径：
<code>
android/libcore/luni/src/main/java/java/lang/Runnable.java
android/libcore/luni/src/main/java/java/lang/Thread.java
android/libcore/luni/src/main/java/java/lang/ThreadGroup.java
android/libcore/luni/src/main/java/java/lang/VMThread.java
android/dalvik/vm/native/java_lang_VMThread.cpp
android/dalvik/vm/Thread.cpp
</code></p>

<h2>Android Thread</h2>

<p>首先来分析<code>Android Thread</code>，这个类的源码在<code>android/libcore/luni/src/main/java/java/lang/Thread.java</code>，它实现了<code>Runnable</code>接口。<code>Runnable</code>只有一个无参无返回值的<code>void run()</code>的接口：</p>

<pre><code class="java">/**
 * Represents a command that can be executed. Often used to run code in a
 * different {@link Thread}.
 */
public interface Runnable {

    /**
     * Starts executing the active part of the class' code. This method is
     * called when a thread is started that has been created with a class which
     * implements {@code Runnable}.
     */
    public void run();
}
</code></pre>

<p><code>Android Thread</code>存在六种状态，这些状态定义在枚举<code>State</code>中，源码注释写的很清晰，在这里就不罗嗦了：
<code>java
    /**
     * A representation of a thread's state. A given thread may only be in one
     * state at a time.
     */
    public enum State {
        /**
         * The thread has been created, but has never been started.
         */
        NEW,
        /**
         * The thread may be run.
         */
        RUNNABLE,
        /**
         * The thread is blocked and waiting for a lock.
         */
        BLOCKED,
        /**
         * The thread is waiting.
         */
        WAITING,
        /**
         * The thread is waiting for a specified amount of time.
         */
        TIMED_WAITING,
        /**
         * The thread has been terminated.
         */
        TERMINATED
    }
</code></p>

<p><code>Android Thread</code>类中一些关键成员变量如下：
<code>
    volatile VMThread vmThread;
    volatile ThreadGroup group;
    volatile boolean daemon;    
    volatile String name;
    volatile int priority;
    volatile long stackSize;
    Runnable target;
    private static int count = 0;
    private long id;
    ThreadLocal.Values localValues;
</code></p>

<blockquote><p><code>vmThread</code>：可视为对<code>dalvik thread</code>的简单封装，<code>Thread</code>类通过<code>VMThread</code>里面的<code>JNI</code>方法来调用<code>dalvik</code>中操作线程的方法，通过它的成员变量<code>thread</code>和<code>vmata</code>，我们可以将<code>Android Thread</code>和<code>dalvik Thread</code>的关联起来；<br/>
<code>group</code>：每一个线程都属于一个<code>group</code>，当线程被创建时就会加入一个特定的<code>group</code>，当线程运行结束，会从这个<code>group</code>中移除；<br/>
<code>daemon</code>：当前线程是不是守护线程，守护线程只会在没有非守护线程运行的情况下才会运行；<br/>
<code>priority</code>：线程优先级，<code>Java Thread</code>类的线程优先级取值范围为 [1, 10]，默认优先级为 5；<br/>
<code>stackSize</code>：线程栈大小，默认为 0，即使用默认的线程栈大小（由<code>dalvik&lt;</code>中的全局变量<code>gDvm.stackSize</code>决定）；<br/>
<code>target</code>：一个<code>Runnable</code>对象，<code>Thread</code>的<code>run()</code>方法中会转调该<code>target</code>的<code>run()</code>方法，这是线程真正处理事务的地方；<br/>
<code>id</code>：线程<code>id</code>，通过递增<code>count</code>得到该<code>id</code>，如果没有显式给线程设置名字，那么就会使用<code>Thread+id</code>当作线程的名字。注意这不是真正意义上的线程<code>id</code>，即在<code>logcat</code>中打印的<code>tid</code>并不是这个<code>id</code>，那<code>tid</code>是指<code>dalvik</code>线程的<code>id</code>；
<code>localValues</code>：线程本地存储（<code>TLS</code>）数据；</p></blockquote>

<p>接下来，我们来看<code>Android Thread</code>的构造函数，大部分构造函数都是通过转调静态函数<code>create</code>实现的，下面来详细分析<code>create</code>这个关键函数：</p>

<pre><code class="java">    private void create(ThreadGroup group, Runnable runnable, String threadName, long stackSize) {
        Thread currentThread = Thread.currentThread();
        if (group == null) {
            group = currentThread.getThreadGroup();
        }

        if (group.isDestroyed()) {
            throw new IllegalThreadStateException("Group already destroyed");
        }

        this.group = group;

        synchronized (Thread.class) {
            id = ++Thread.count;
        }

        if (threadName == null) {
            this.name = "Thread-" + id;
        } else {
            this.name = threadName;
        }

        this.target = runnable;
        this.stackSize = stackSize;

        this.priority = currentThread.getPriority();

        this.contextClassLoader = currentThread.contextClassLoader;

        // Transfer over InheritableThreadLocals.
        if (currentThread.inheritableValues != null) {
            inheritableValues = new ThreadLocal.Values(currentThread.inheritableValues);
        }

        // add ourselves to our ThreadGroup of choice
        this.group.addThread(this);
    }
</code></pre>

<p>首先，通过静态函数<code>currentThread</code>获取创建线程所在的当前线程，然后将当前线程的一些属性传递给即将创建的新线程。这是通过<code>VMThread</code>转调<code>dalvik</code>中的代码实现的。</p>

<pre><code class="java">    public static Thread currentThread() {
        return VMThread.currentThread();
    }
</code></pre>

<h2>dalvik Thread</h2>

<p><code>VMThread</code>的<code>currentThread</code>是一个<code>native</code>方法，其<code>JNI</code>实现为<code>android/dalvik/vm/native/java_lang_VMThread.cpp</code>中的<code>Dalvik_java_lang_VMThread_currentThread</code>方法：</p>

<pre><code class="cpp">static void Dalvik_java_lang_VMThread_currentThread(const u4* args,
    JValue* pResult)
{
    UNUSED_PARAMETER(args);

    RETURN_PTR(dvmThreadSelf()-&gt;threadObj);
}
</code></pre>

<p>该方法里的<code>dvmThreadSelf()</code>方法定义在<code>android/dalvik/vm/Thread.cpp</code>中：</p>

<pre><code class="cpp">Thread* dvmThreadSelf()
{
    return (Thread*) pthread_getspecific(gDvm.pthreadKeySelf);
}
</code></pre>

<p>从上面的调用栈可以看到，每一个<code>dalvik</code>线程都会将自身存放在<code>key</code>为<code>pthreadKeySelf</code> 的线程本地存储中，获取当前线程时，只需要根据这个<code>key</code>查询获取即可，<code>dalvik Thread</code>有一个名为<code>threadObj</code> 的成员变量：</p>

<pre><code class="cpp">    /* the java/lang/Thread that we are associated with */
    Object*     threadObj;
</code></pre>

<p><code>dalvik Thread</code>这个成员变量<code>threadObj</code>关联的就是对应的<code>Android Thread</code>对象，所以通过<code>native</code>方法<code>VMThread.currentThread()</code>返回的是存储在<code>TLS</code>中的当前<code>dalvik</code>线程对应的<code>Android Thread</code>。</p>

<p>接着分析上面的代码，如果没有给新线程指定<code>group</code>那么就会指定<code>group</code>为当前线程所在的<code>group</code>中，然后给新线程设置<code>name</code>，<code>priority</code>等。最后通过调用<code>ThreadGroup</code>的<code>addThread</code>方法将新线程添加到<code>group</code>中：</p>

<pre><code class="java">    /**
     * Called by the Thread constructor.
     */
    final void addThread(Thread thread) throws IllegalThreadStateException {
        synchronized (threadRefs) {
            if (isDestroyed) {
                throw new IllegalThreadStateException();
            }
            threadRefs.add(new WeakReference&lt;Thread&gt;(thread));
        }
    }
</code></pre>

<p><code>ThreadGroup</code>的代码相对简单，它有一个名为<code>threadRefs</code>的列表，持有属于同一组的<code>thread</code>引用，可以对一组<code>thread</code>进行一些线程操作。</p>

<p>上面分析的是<code>Android Thread</code>的构造过程，从上面的分析可以看出，<code>Android Thread</code>的构造方法仅仅是设置了一些线程属性，并没有真正去创建一个新的<code>dalvik Thread</code>，<code>dalvik Thread</code>创建过程要等到客户代码调用<code>Android Thread</code>的<code>start()</code>方法才会进行。下面我们来分析<code>Java Thread</code>的<code>start()</code>方法：</p>

<pre><code class="java">public synchronized void start() {

        if (hasBeenStarted) {
            throw new IllegalThreadStateException("Thread already started."); // TODO Externalize?
        }

        hasBeenStarted = true;

        VMThread.create(this, stackSize);
    }
}
</code></pre>

<p><code>Android Thread</code>的 <code>start</code> 方法很简单，仅仅是转调 <code>VMThread</code> 的 <code>native</code> 方法 <code>create</code>，其 <code>JNI</code> 实现为 <code>android/dalvik/vm/native/java_lang_VMThread.cpp</code> 中的 <code>Dalvik_java_lang_VMThread_create</code> 方法：</p>

<pre><code class="cpp">static void Dalvik_java_lang_VMThread_create(const u4* args, JValue* pResult)
{
    Object* threadObj = (Object*) args[0];
    s8 stackSize = GET_ARG_LONG(args, 1);

    /* copying collector will pin threadObj for us since it was an argument */
    dvmCreateInterpThread(threadObj, (int) stackSize);
    RETURN_VOID();
}
</code></pre>

<h2>Create 线程</h2>

<p><code>dvmCreateInterpThread</code> 的实现在 <code>Thread.cpp</code> 中，由于这个函数的内容很长，在这里只列出关键的地方：</p>

<pre><code class="cpp">bool dvmCreateInterpThread(Object* threadObj, int reqStackSize)
{
    Thread* self = dvmThreadSelf();
    ...
    Thread* newThread = allocThread(stackSize); 
    newThread-&gt;threadObj = threadObj;
    ...
    Object* vmThreadObj = dvmAllocObject(gDvm.classJavaLangVMThread, ALLOC_DEFAULT);
    dvmSetFieldInt(vmThreadObj, gDvm.offJavaLangVMThread_vmData, (u4)newThread);
    dvmSetFieldObject(threadObj, gDvm.offJavaLangThread_vmThread, vmThreadObj);
    ...
    pthread_t threadHandle;
    int cc = pthread_create(&amp;threadHandle, &amp;threadAttr, interpThreadStart, newThread);

    /*
     * Tell the new thread to start.
     *
     * We must hold the thread list lock before messing with another thread.
     * In the general case we would also need to verify that newThread was
     * still in the thread list, but in our case the thread has not started
     * executing user code and therefore has not had a chance to exit.
     *
     * We move it to VMWAIT, and it then shifts itself to RUNNING, which
     * comes with a suspend-pending check.
     */
    dvmLockThreadList(self);

    assert(newThread-&gt;status == THREAD_STARTING);
    newThread-&gt;status = THREAD_VMWAIT;
    pthread_cond_broadcast(&amp;gDvm.threadStartCond);

    dvmUnlockThreadList();
    ...
}

/*
 * Alloc and initialize a Thread struct.
 *
 * Does not create any objects, just stuff on the system (malloc) heap.
 */
static Thread* allocThread(int interpStackSize)
{
    Thread* thread;
    thread = (Thread*) calloc(1, sizeof(Thread));
    ...
    thread-&gt;status = THREAD_INITIALIZING;
}
</code></pre>

<p>首先，通过调用 <code>allocThread</code> 创建一个名为 <code>newThread</code> 的<code>dalvik Thread</code> 并设置一些属性，将设置其成员变量 <code>threadObj</code> 为传入的 <code>Android Thread</code>，这样<code>dalvik Thread</code>就与<code>Android Thread</code>关联起来了；然后创建一个名为 <code>vmThreadObj</code> 的 <code>VMThread</code> 对象，设置其成员变量 <code>vmData</code> 为 <code>newThread</code>，设置<code>Android Thread threadObj</code>的成员变量 <code>vmThread</code> 为这个 <code>vmThreadObj</code>，这样<code>Android Thread</code>通过 <code>VMThread</code> 的成员变量 <code>vmData</code> 就和<code>dalvik Thread</code>关联起来了。</p>

<h2>Start 线程</h2>

<p>然后，通过 <code>pthread_create</code> 创建 <code>pthread</code> 线程，并让这个线程 <code>start</code>，这样就会进入该线程的 <code>thread entry</code> 运行，下来我们来看新线程的 <code>thread entry</code> 方法 <code>interpThreadStart</code>，同样只列出关键的地方：</p>

<pre><code class="cpp">/*
 * pthread entry function for threads started from interpreted code.
 */
static void* interpThreadStart(void* arg)
{
    Thread* self = (Thread*) arg;

    std::string threadName(dvmGetThreadName(self));
    setThreadName(threadName.c_str());

    /*
     * Finish initializing the Thread struct.
     */
    dvmLockThreadList(self);
    prepareThread(self);

    while (self-&gt;status != THREAD_VMWAIT)
        pthread_cond_wait(&amp;gDvm.threadStartCond, &amp;gDvm.threadListLock);

    dvmUnlockThreadList();

    /*
     * Add a JNI context.
     */
    self-&gt;jniEnv = dvmCreateJNIEnv(self);

    /*
     * Change our state so the GC will wait for us from now on.  If a GC is
     * in progress this call will suspend us.
     */
    dvmChangeStatus(self, THREAD_RUNNING);

    /*
     * Execute the "run" method.
     *
     * At this point our stack is empty, so somebody who comes looking for
     * stack traces right now won't have much to look at.  This is normal.
     */
    Method* run = self-&gt;threadObj-&gt;clazz-&gt;vtable[gDvm.voffJavaLangThread_run];
    JValue unused;

    ALOGV("threadid=%d: calling run()", self-&gt;threadId);
    assert(strcmp(run-&gt;name, "run") == 0);
    dvmCallMethod(self, run, self-&gt;threadObj, &amp;unused);
    ALOGV("threadid=%d: exiting", self-&gt;threadId);

    /*
     * Remove the thread from various lists, report its death, and free
     * its resources.
     */
    dvmDetachCurrentThread();

    return NULL;
}

/*
 * Finish initialization of a Thread struct.
 *
 * This must be called while executing in the new thread, but before the
 * thread is added to the thread list.
 *
 * NOTE: The threadListLock must be held by the caller (needed for
 * assignThreadId()).
 */
static bool prepareThread(Thread* thread)
{
    assignThreadId(thread);
    thread-&gt;handle = pthread_self();
    thread-&gt;systemTid = dvmGetSysThreadId();

    setThreadSelf(thread);
    ...

    return true;
}

/*
 * Explore our sense of self.  Stuffs the thread pointer into TLS.
 */
static void setThreadSelf(Thread* thread)
{
    int cc;

    cc = pthread_setspecific(gDvm.pthreadKeySelf, thread);
    ...
}
</code></pre>

<p>在新线程的 <code>thread entry</code> 方法 <code>interpThreadStart</code> 中，首先设置线程的名字，然后通过调用 <code>prepareThread</code> 设置线程 <code>id</code> 以及其它一些属性，并调用 <code>setThreadSelf</code> 将新<code>dalvik Thread</code>自身保存在 <code>TLS</code> 中，这样之后就能通过 <code>dvmThreadSelf</code> 方法从 <code>TLS</code> 中获取它。然后修改状态为 <code>THREAD_RUNNING</code>，并调用对应<code>Android Thread</code>的 <code>run</code> 方法，运行客户代码：</p>

<pre><code class="java">    public void run() {
        if (target != null) {
            target.run();
        }
    }
</code></pre>

<p>对于继承自<code>Android Thread</code>带有 <code>Looper</code> 的 <code>Android HandlerThread</code> 来说，会调用它覆写 <code>run()</code> 方法：（关于 <code>Looper</code> 的话题下一篇会讲到，这里暂且略过）</p>

<pre><code class="java">    public void run() {
        mTid = Process.myTid();
        Looper.prepare();
        synchronized (this) {
            mLooper = Looper.myLooper();
            notifyAll();
        }
        Process.setThreadPriority(mPriority);
        onLooperPrepared();
        Looper.loop();
        mTid = -1;
    }
</code></pre>

<h2>Detach 线程</h2>

<p><code>target</code> 在前面已经做了介绍，它是线程真正处理逻辑事务的地方。一旦逻辑事务处理完毕从 <code>run</code> 中返回，线程就会回到 <code>interpThreadStart</code> 方法中，继续执行 <code>dvmDetachCurrentThread</code> 方法：</p>

<pre><code class="cpp">/*
 * Detach the thread from the various data structures, notify other threads
 * that are waiting to "join" it, and free up all heap-allocated storage.
 * /
void dvmDetachCurrentThread()
{
    Thread* self = dvmThreadSelf();
    Object* vmThread;
    Object* group;
    ...
    group = dvmGetFieldObject(self-&gt;threadObj, gDvm.offJavaLangThread_group);

    /*
     * Remove the thread from the thread group.
     */
    if (group != NULL) {
        Method* removeThread =
            group-&gt;clazz-&gt;vtable[gDvm.voffJavaLangThreadGroup_removeThread];
        JValue unused;
        dvmCallMethod(self, removeThread, group, &amp;unused, self-&gt;threadObj);
    }

    /*
     * Clear the vmThread reference in the Thread object.  Interpreted code
     * will now see that this Thread is not running.  As this may be the
     * only reference to the VMThread object that the VM knows about, we
     * have to create an internal reference to it first.
     */
    vmThread = dvmGetFieldObject(self-&gt;threadObj,
                    gDvm.offJavaLangThread_vmThread);
    dvmAddTrackedAlloc(vmThread, self);
    dvmSetFieldObject(self-&gt;threadObj, gDvm.offJavaLangThread_vmThread, NULL);

    /* clear out our struct Thread pointer, since it's going away */
    dvmSetFieldObject(vmThread, gDvm.offJavaLangVMThread_vmData, NULL);

    ...

    /*
     * Thread.join() is implemented as an Object.wait() on the VMThread
     * object.  Signal anyone who is waiting.
     */
    dvmLockObject(self, vmThread);
    dvmObjectNotifyAll(self, vmThread);
    dvmUnlockObject(self, vmThread);

    dvmReleaseTrackedAlloc(vmThread, self);
    vmThread = NULL;

    ...

    dvmLockThreadList(self);

    /*
     * Lose the JNI context.
     */
    dvmDestroyJNIEnv(self-&gt;jniEnv);
    self-&gt;jniEnv = NULL;

    self-&gt;status = THREAD_ZOMBIE;

    /*
     * Remove ourselves from the internal thread list.
     */
    unlinkThread(self);

    ...

    releaseThreadId(self);
    dvmUnlockThreadList();

    setThreadSelf(NULL);

    freeThread(self);
}

/*
 * Free a Thread struct, and all the stuff allocated within.
 */
static void freeThread(Thread* thread)
{
    ...
    free(thread);
}
</code></pre>

<p>在 <code>dvmDetachCurrentThread</code> 函数里，首先获取当前线程 <code>self</code>，这里获得的就是当前执行 <code>thread entry</code> 的新线程，然后通过其对应的<code>Android Thread</code>对象 <code>threadObj</code> 获取该对象所在 <code>group</code>，然后将 <code>threadObj</code> 这个<code>Android Thread</code>对象从 <code>group</code> 中移除；接着清除 <code>Android</code> 与 <code>dalvik</code> 线程之间的关联关系，并通知 <code>join</code> 该线程的其它线程；最后，设置线程状态为 <code>THREAD_ZOMBIE</code>，清除 <code>TLS</code> 中存储的线程值，并通过调用 <code>freeThread</code> 释放内存，至此线程就终结了。</p>
]]></content>
  </entry>
  
</feed>
